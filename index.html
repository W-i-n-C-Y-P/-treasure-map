<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—å¯¶åœ–æ®˜å·ã€ç¢ç‰‡è¨ˆç®—æ©Ÿ | Treasure Map Calculator</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* #region CSS Styles */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation;
            font-size: 17px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .input-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 0.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .input-group input[type="date"] {
            width: 100%;
            max-width: 8.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.3rem;
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
            transition: border-color 0.15s;
            background-color: rgba(255, 255, 255, 0.8);
        }

        .input-group input[type="number"] {
            width: 100%;
            max-width: 5.625rem;
            border: 1px solid #d1d5db;
            border-radius: 0.3rem;
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
            transition: border-color 0.15s;
            background-color: rgba(255, 255, 255, 0.8);
        }

        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #93c5fd;
            background-color: white;
        }


        th,
        td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.5rem;
            border-left: 4px solid #3b82f6;
            padding-left: 0.5rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-top: 0.1rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* å•†åº—æ¨£å¼ */
        .shop-counter {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.8);
            padding: 0.2rem 0.3rem;
            border-radius: 0.25rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.25rem;
        }

        .shop-counter button {
            width: 1.125rem;
            height: 1.125rem;
            border-radius: 3px;
            background: #e5e7eb;
            color: #374151;
            font-weight: bold;
            line-height: 1;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .shop-counter button:hover {
            background: #d1d5db;
        }

        .shop-counter button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .shop-item-cost-large {
            font-size: 0.8rem;
            font-weight: 700;
        }

        /* åˆ†é æŒ‰éˆ•æ¨£å¼ */
        .tabs-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 2px;
            -webkit-overflow-scrolling: touch;
        }

        .tabs-container::-webkit-scrollbar {
            height: 3px;
        }

        .tabs-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        /* Added flex-shrink-0 to prevent overlapping/squishing */
        .tab-btn {
            flex: 1;
            display: inline-block;
            padding: 0.5rem 0.4rem;
            text-align: center;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 70px;
            font-size: 0.8rem;
            flex-shrink: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (min-width: 640px) {
            .tab-btn {
                min-width: 90px;
                font-size: 0.95rem;
                padding: 0.6rem 1rem;
            }
        }

        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background-color: #eff6ff;
        }

        .tab-btn:hover:not(.active) {
            color: #374151;
            background-color: #f9fafb;
        }

        /* å…§å®¹å€å¡Šå·è»¸ */
        .tab-content-scroll {
            height: calc(100vh - 140px);
            overflow-y: auto;
            padding-right: 4px;
        }

        .tab-content-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .tab-content-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .tab-content-scroll::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .tab-content-scroll::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* è‡ªå®šç¾©å±¬æ€§é¡è‰² class */
        .color-fire {
            color: #FF2D2D;
        }

        .color-water {
            color: #00AEAE;
        }

        .color-wind {
            color: #4F9D9D;
        }

        .color-thunder {
            color: #4A4AFF;
        }

        .color-univ {
            color: #16a34a;
        }

        .border-fire {
            border-color: #FF2D2D;
        }

        .border-water {
            border-color: #00AEAE;
        }

        .border-wind {
            border-color: #4F9D9D;
        }

        .border-thunder {
            border-color: #4A4AFF;
        }

        .border-univ {
            border-color: #16a34a;
        }

        .bg-fire-light {
            background-color: #fff0f0;
        }

        .bg-water-light {
            background-color: #e0fafa;
        }

        .bg-wind-light {
            background-color: #eef9f9;
        }

        .bg-thunder-light {
            background-color: #efefff;
        }

        .bg-univ-light {
            background-color: #f0fdf4;
        }

        .text-fragment-custom {
            color: #9999CC;
        }

        .text-god {
            color: #b91c1c;
        }

        .text-peerless {
            color: #7e22ce;
        }

        .text-rare {
            color: #4338ca;
        }

        .text-common {
            color: #15803d;
        }

        .text-random {
            color: #a16207;
        }

        /* Help Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 600px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        /* Selection Styles */
        .queue-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .queue-item:hover:not(.selected) {
            background-color: #f9fafb;
        }

        .queue-item.selected {
            background-color: #eff6ff;
            border-left-color: #3b82f6;
        }

        /* Control Buttons */
        .ctrl-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.1s;
            background-color: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .ctrl-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .ctrl-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .ctrl-btn.up {
            color: #2563eb;
            background-color: #eff6ff;
            border-color: #bfdbfe;
        }

        .ctrl-btn.down {
            color: #2563eb;
            background-color: #eff6ff;
            border-color: #bfdbfe;
        }

        .ctrl-btn.del {
            color: #dc2626;
            background-color: #fef2f2;
            border-color: #fecaca;
        }

        /* #endregion */
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- å¤šèªè¨€è¨­å®š ---
        // #region å¤šèªè¨€è¨­å®š (I18N)
        const I18N = {
            zh: {
                title: "è—å¯¶åœ–æ´»å‹•æ”¶ç›Šè¨ˆç®—æ©Ÿ",
                period: "æ´»å‹•æœŸé–“: 2026/01/21 ~ 2026/02/25",
                tab_main: "ğŸ“Š åº«å­˜èˆ‡æ”¶ç›Šç¸½è¦½",
                tab_main_short: "ğŸ“Š åº«å­˜",
                tab_shop: "ğŸ›’ å•†åº—è¦åŠƒ",
                tab_shop_short: "ğŸ›’ å•†åº—",
                tab_daily: "ğŸ“… æ¯æ—¥æ˜ç´°",
                tab_daily_short: "ğŸ“… æ˜ç´°",
                tab_sources: "ğŸ“œ ä¾†æºèªªæ˜",
                tab_sources_short: "ğŸ“œ ä¾†æº",
                btn_help: "â“ èªªæ˜",
                btn_tabs: "ğŸ“‘ é ç±¤å¼",
                btn_single: "ğŸ“œ ä¸€é å¼",
                btn_clear: "ğŸ—‘ï¸ æ¸…é™¤",
                lbl_date: "ç•¶å‰æ—¥æœŸ",
                lbl_remaining: "å‰© {d} å¤© / {w} é€±",
                lbl_legend: "å‚³é Œè—å¯¶åœ– (å„é™1æ¬¡ - è‹¥å·²ç²å¾—è«‹å‹¿å‹¾é¸)",
                lbl_leg_captain_1: "â­éšŠé•·(+75é€š)",
                lbl_leg_member_1: "â­éšŠå“¡(+40é€š)",
                lbl_leg_captain_2: "â­â­éšŠé•·(+150é€š)",
                lbl_leg_member_2: "â­â­éšŠå“¡(+75é€š)",
                lbl_scrolls: "æŒæœ‰æ®˜å·åº«å­˜ (å±¬æ€§)",
                lbl_maps: "æŒæœ‰æˆå“è—å¯¶åœ– (ä¸åˆ†å±¬æ€§)",
                lbl_frags: "æŒæœ‰ç¢ç‰‡åº«å­˜",
                lbl_member_frag: "éšŠå“¡æ®˜å· (æ¯æ—¥èˆ‡æ¯é€±)",
                lbl_leader_frag: "éšŠé•·æ®˜å· (æŒæœ‰åœ–æ”¶ç›Š)",
                lbl_univ_frag: "é€šç”¨æ®˜å· (é€šç”¨èˆ‡å‚³é Œ)",
                lbl_art_event: "å¦™æ‰‹ä¸¹é’ (è‹¥å·²ç²å¾—è«‹å‹¿é¸)",
                art_count: "ç²å¾—æ¬¡æ•¸", attr_fire: "ç«", attr_water: "æ°´", attr_wind: "é¢¨", attr_thunder: "é›·", attr_univ: "é€šç”¨",
                lbl_attribute: "å±¬æ€§",
                qual_god: "ç¥å“", qual_peerless: "çµ•å“", qual_rare: "çå“", qual_common: "å‡¡å“", qual_random: "éš¨æ©Ÿ",
                qual_peerless_short: "çµ•", qual_rare_short: "ç", qual_common_short: "å‡¡",
                qual_legend: "å‚³é Œ",

                sec_settings: "è¨­å®šèˆ‡åº«å­˜",
                sec_income_title: "æ´»å‹•çµæŸç¸½æ”¶ç›Šé ä¼°",
                sec_details_title: "æ®˜å·ä¾†æºè©³æƒ…",
                row_base: "åº«å­˜+å›ºå®š",
                row_maps: "åº«å­˜æˆå“",
                row_conv: "éš¨æ©Ÿè½‰åŒ–",
                row_synth: "ç¢ç‰‡åˆæˆ",
                total_est: "ç¸½è¨ˆé ä¼°",
                exchange_ref: "ğŸ”„ å±¬æ€§2æ›é€šç”¨1 é€šç”¨1æ›å±¬æ€§1",
                exchange_all_attr: "å…¨è½‰æ›ï¼šå±¬æ€§", // Updated Text
                exchange_all_univ: "å…¨è½‰æ›ï¼šé€šç”¨", // Updated Text

                prog_title: "ç¢ç‰‡åˆæˆé€²åº¦ç›¤é»",
                prog_syn: "åˆ", prog_need: "å·®",

                sec_shop_title: "å…Œæ›å•†åº—è¦åŠƒ",
                shop_desc: "è«‹å‹¾é¸ä½ æƒ³å…Œæ›çš„é …ç›®ã€‚",
                shop_conv_attr: "å…¨è½‰å±¬æ€§æ®˜å·",
                shop_conv_univ: "å…¨è½‰é€šç”¨æ®˜å·",
                val_total: "ç¸½åƒ¹å€¼", req_total: "ç¸½éœ€æ±‚", bal_total: "é¤˜é¡",
                dtl_detail: "æ˜ç´°",
                card_supply: "ä¾›çµ¦", card_cost: "èŠ±è²»", card_bal: "çµé¤˜", card_inv: "åº«å­˜",

                sec_daily_title: "æ¯æ—¥è³‡æºç²å–æ˜ç´°",
                th_day: "Day", th_date: "æ—¥æœŸ", th_gain: "ç•¶æ—¥ç²å¾— (å±¬/é€š/éš¨æ©Ÿ)", th_acc: "ç´¯ç© å±¬/é€š", th_frag: "ç´¯ç© éš¨æ©Ÿ", th_note: "å‚™è¨»",
                note_weekly: "æ¯é€±ç¥å“(+30å±¬/+40é€š)",
                note_fixed: "æ´»å‹•å›ºå®šçå‹µ",
                note_leg: "å‚³é Œ(+{v}é€š)",

                sec_source_title: "ğŸ“œ å®˜æ–¹ç¢ç‰‡ç²å–ä¾†æºèªªæ˜",
                src_fixed_title: "ğŸ‰ æ´»å‹•å…¨ç¨‹å›ºå®šä»»å‹™ (ä¸€æ¬¡æ€§)",
                src_weekly_title: "ğŸ“… é€±æœŸæ€§ä»»å‹™",
                src_weekly_sub: "æ¯é€±ä»»å‹™ (é€±æ—¥é‡ç½®)",
                src_daily_sub: "æ¯æ—¥ç²å– (éš¨æ©Ÿ+ä»»å‹™)",
                src_daily_note: "(æ¯æ—¥éš¨æ©Ÿ 15 + æ¯æ—¥ä»»å‹™ 4)",
                src_art_reward: "å¯é¸ 0~25 éš¨æ©Ÿç¢ç‰‡",
                unit_frag: "ç‰‡", unit_week: "é€±", unit_day: "å¤©",

                src_rewards_title: "ğŸ è—å¯¶åœ–è¨ä¼çå‹µå°ç…§è¡¨",
                reward_header_qual: "å“è³ª", reward_header_role: "èº«åˆ†", reward_header_attr: "å±¬æ€§å·", reward_header_univ: "é€šç”¨å·", reward_header_refund: "è¿”é‚„",
                role_capt: "éšŠé•·", role_memb: "éšŠå“¡",

                help_title: "ä½¿ç”¨æŒ‡å—",
                help_p1: "è«‹è¼¸å…¥æ‚¨çš„åº«å­˜ï¼ˆå«æˆå“åœ–å±¬æ€§ï¼‰èˆ‡ç¢ç‰‡ï¼Œç³»çµ±å°‡è‡ªå‹•è¨ˆç®—æœªä¾†ç¸½æ”¶ç›Šèˆ‡å•†åº—è¦åŠƒã€‚",
                help_h1: "1. è³¼è²·åŠ›åˆ¤æ–· (ç¾åœ¨ vs æœªä¾†)",
                help_p2: "ã€Œå…Œæ›å•†åº—è¦åŠƒã€æ¡ç”¨å¤šé‡åˆ¤æ–·æ©Ÿåˆ¶ï¼š",
                help_li1: "â— **ç¾åœ¨**ï¼šåƒ…è¨ˆç®—ã€Œç¾æœ‰åº«å­˜ã€ã€‚é¡¯ç¤ºç‚ºè² æ•¸ä»£è¡¨æ‚¨ç¾é‡‘ä¸è¶³ã€‚",
                help_li2: "â— **æœªä¾†**ï¼šå„ªå…ˆä½¿ç”¨ã€ŒæŒæœ‰å±¬æ€§åœ–ã€ç”¢å‡ºçš„æ®˜å·ï¼Œå†è¨ˆç®—é€šç”¨/éš¨æ©Ÿæ”¶ç›Šã€‚",
                help_h2: "2. ç¢ç‰‡åˆæˆéè¿´é‚è¼¯",
                help_p3: "æœ¬å·¥å…·æ¨¡æ“¬äº†ã€Œè¨ä¼çµ•/ç/å‡¡å“åœ–å¾Œé€€é‚„ 1 ç‰‡ç¢ç‰‡ã€çš„è¦å‰‡ï¼š",
                help_li3: "ç•¶æ‚¨è¼¸å…¥ 10 ç‰‡æ™‚ï¼Œé€²åº¦æœƒé¡¯ç¤ºã€Œåˆ 1 / å·® 9ã€ï¼Œå› ç‚ºç³»çµ±é çŸ¥æ‚¨æ‰“å®Œå¾Œæœƒå‰© 1 ç‰‡ã€‚",
                help_h3: "3. å•†åº—å…Œæ›è¨ˆç®—é‚è¼¯ (é‡è¦ï¼)",
                help_p4: "å•†å“æŒ‰å„ªå…ˆé †åºä¾åºè™•ç†ï¼Œæ¯å€‹å•†å“ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿä½¿ç”¨è³‡æºï¼š",
                help_li4: "â— **æ­¥é©Ÿ1**ï¼šç¾æœ‰åŒå±¬æ€§åº«å­˜ (1:1)",
                help_li5: "â— **æ­¥é©Ÿ2**ï¼šæœªä¾†ç²å–åŒå±¬æ€§ (1:1ï¼Œå„ªå…ˆçµ¦ç¬¬ä¸€å€‹å±¬æ€§å•†å“)",
                help_li6: "â— **æ­¥é©Ÿ3**ï¼šç¾æœ‰ã€Œä¸åœ¨å•†å“æ¬„ã€çš„å±¬æ€§ (2:1è½‰æ›)",
                help_li7: "â— **æ­¥é©Ÿ4**ï¼šç¾æœ‰ã€Œå•†å“æ¬„è£¡æœ€ä½å„ªå…ˆæ¬Šã€çš„å±¬æ€§ (2:1è½‰æ›)",
                help_li8: "â— **æ­¥é©Ÿ5**ï¼šæœªä¾†ç²å–çš„å±¬æ€§æ®˜å· (2:1è½‰æ›)",
                help_p5: "**é‡è¦æç¤º**ï¼šå‰é¢çš„å•†å“æœƒå„ªå…ˆä½¿ç”¨æ‰€æœ‰å¯ç”¨è³‡æºï¼Œå¾Œé¢çš„å•†å“åªèƒ½ä½¿ç”¨å‰©é¤˜è³‡æºã€‚æ–°å¢å•†å“ä¸æœƒå½±éŸ¿å‰é¢å•†å“çš„è¨ˆç®—çµæœã€‚æ‚¨å¯ä»¥é€éèª¿æ•´å•†å“é †åºä¾†å„ªåŒ–è³‡æºåˆ†é…ã€‚",
                help_h4: "4. ç¸®æ”¾èˆ‡ä¾¿æ·æ“ä½œ",
                help_p6: "â— **ç¸®æ”¾æ“ä½œ**ï¼šæ‚¨å¯ä»¥é»æ“Šå³ä¸‹è§’çš„ [+] æˆ– [-] é€²è¡Œç¸®æ”¾ï¼Œé»æ“Šä¸­å¤®ç™¾åˆ†æ¯”å¯é‡ç½®ç‚º 100%ã€‚",
                help_p7: "â— **æ‹–æ‹½æ’åº**ï¼šåœ¨é›»è…¦ä¸Šï¼Œæ‚¨å¯ä»¥ç›´æ¥æ‹–æ‹½å•†å“éšŠåˆ—ä¾†å¿«é€Ÿèª¿æ•´å„ªå…ˆé †åºã€‚æ‰‹æ©Ÿè«‹ä½¿ç”¨ä¸Šä¸‹ç®­é ­æŒ‰éˆ•ã€‚",
                help_p8: "â— **æ•¸æ“šè‡ªå‹•ä¿å­˜**ï¼šæ‰€æœ‰è¼¸å…¥çš„æ•¸æ“šæœƒè‡ªå‹•ä¿å­˜åˆ°ç€è¦½å™¨ï¼Œä¸‹æ¬¡æ‰“é–‹æ™‚æœƒè‡ªå‹•è¼‰å…¥ã€‚",
                help_h5: "5. å»ºè­°æ¯æ—¥ä½¿ç”¨æµç¨‹",
                help_li4: "â— **å¿«æ·éµ**ï¼šæ”¯æ´ `Ctrl` + `+`/`-` ç¸®æ”¾ï¼Œä»¥åŠ `Ctrl` + `0` é‡ç½®ã€‚",
                help_h4: "4. å»ºè­°æ¯æ—¥ä½¿ç”¨æµç¨‹",
                help_s1: "æ¯æ—¥æ›´æ–°åº«å­˜ (åº«å­˜èˆ‡æ”¶ç›Šç¸½è¦½)",
                help_d1: "å¡«å…¥ä»Šæ—¥æœ€æ–°çš„æ®˜å·ã€æˆå“åœ–èˆ‡ç¢ç‰‡æ•¸é‡ã€‚",
                help_s2: "æŸ¥çœ‹åˆæˆé€²åº¦ (åº«å­˜èˆ‡æ”¶ç›Šç¸½è¦½ å³å´)",
                help_d2: "è‹¥é¡¯ç¤ºå¯åˆæˆï¼Œä»£è¡¨éŠæˆ²å…§å¯ä»¥å»åˆæˆä¸¦è¨ä¼äº†ã€‚",
                help_s3: "å„ªå…ˆéšŠåˆ—è¦åŠƒ (å•†åº—è¦åŠƒ)",
                help_d3: "åŠ å…¥æƒ³è²·çš„å•†å“ï¼Œä¸¦é€éä¸Šä¸‹æŒ‰éˆ•èª¿æ•´å„ªå…ˆé †åºï¼ˆé›»è…¦å¯æ‹–æ‹½ï¼‰ã€‚ç³»çµ±æœƒä¾åºæ‰£é™¤è³‡æºä¸¦é¡¯ç¤ºç¼ºå£ã€‚",
                btn_gotit: "æˆ‘ç­è§£äº†",

                // Priority Logic
                prio_title: "ğŸ† å‹•æ…‹è³¼ç‰©éšŠåˆ—èˆ‡ç¼ºå£åˆ†æ",
                prio_subtitle: "ç”±ä¸Šè€Œä¸‹ä¾åºè¨ˆç®—ï¼Œé»é¸é …ç›®å¾Œå¯ç§»å‹•/åˆªé™¤ï¼ˆé›»è…¦å¯æ‹–æ‹½ï¼‰",
                prio_header_item: "å…Œæ›é …ç›®",
                prio_header_calc: "æ‰£é™¤ä¾†æº",
                prio_header_status: "ç‹€æ…‹",
                prio_empty: "è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œè«‹åœ¨ä¸‹æ–¹é»é¸ + åŠ å…¥å•†å“",
                prio_stock_used: "ç¾æœ‰å±¬æ€§åº«å­˜",
                prio_future_attr: "é è¨ˆç²å¾—: å±¬æ€§å·",
                prio_future_univ: "é è¨ˆç²å¾—: é€šç”¨å·",
                prio_univ_stock: "ç¾æœ‰é€šç”¨åº«å­˜",
                prio_univ_reward: "é è¨ˆç²å¾—: é€šç”¨å·",
                prio_conv_used: "å±¬æ€§è½‰åŒ–",
                btn_clear_all: "ğŸ—‘ï¸ å…¨éƒ¨æ¸…ç©º",
                prio_gap: "ç¼ºå£",
                shop_cost: "æˆæœ¬",
                shop_gap: "ç¼º",
                prio_status_stock: "âœ… åº«å­˜å……è¶³",
                prio_status_univ: "ğŸŸ¢ é€šç”¨å…Œæ›",
                prio_status_convert: "ğŸ”µ å±¬æ€§è½‰åŒ–",
                prio_status_gap: "ğŸ”´ è³‡æºä¸è¶³",
                prio_farm: "å»ºè­°ï¼šå°ˆæ”»{attr}åœ–",
                prio_rem_univ: "é€šç”¨æ± å‰©é¤˜:",

                // New Labels
                sec_future_breakdown: "æœªä¾†é è¨ˆç²å–æ˜ç´° (å‰©é¤˜æ¬¡æ•¸)",
                th_source: "ä¾†æº",
                th_count: "å‰©é¤˜",
                th_attr: "å±¬æ€§å·",
                th_univ: "é€šç”¨å·",
                th_frag: "ç¢ç‰‡",
                row_daily: "æ¯æ—¥éšŠå“¡çå‹µ",
                row_weekly_divine: "æ¯é€±ç¥å“çå‹µ",
                row_daily_frag: "æ—¥å¸¸åŠä»»å‹™ç¢ç‰‡ (1çµ•/2ç/3å‡¡)",
                row_weekly_frag: "æ¯é€±ç¥å“ç¢ç‰‡ (ç¥*3)",
                row_art_event: "å¦™æ‰‹ä¸¹é’ (è‹¥å·²é ˜å–è«‹å‹¿è¼¸å…¥)",
            },
            en: {
                title: "Treasure Map Calculator",
                period: "Event Period: 2026/01/21 ~ 2026/02/25",
                tab_main: "Overview",
                tab_main_short: "ğŸ“Š Home",
                tab_shop: "Shop Plan",
                tab_shop_short: "ğŸ›’ Shop",
                tab_daily: "Daily Log",
                tab_daily_short: "ğŸ“… Daily",
                tab_sources: "Sources",
                tab_sources_short: "ğŸ“œ Info",
                btn_help: "â“ Help",
                btn_tabs: "ğŸ“‘ Tabs",
                btn_single: "ğŸ“œ Single",
                btn_clear: "ğŸ—‘ï¸ Clear",
                lbl_date: "Current Date",
                lbl_remaining: "{d} Days / {w} Weeks Left",
                lbl_legend: "Mythical Map (Limit 1 ea)",
                lbl_leg_captain_1: "â­Cpt(+75)",
                lbl_leg_member_1: "â­Mem(+40)",
                lbl_leg_captain_2: "â­â­Cpt(+150)",
                lbl_leg_member_2: "â­â­Mem(+75)",
                lbl_scrolls: "Scrolls Owned",
                lbl_maps: "Maps Owned",
                lbl_frags: "Fragments Owned",
                lbl_member_frag: "Member Frags (Daily+Weekly)",
                lbl_leader_frag: "Captain Frags (Map Drops)",
                lbl_univ_frag: "Universal Frags (Base+Legend)",
                attr_fire: "Fire", attr_water: "Water", attr_wind: "Wind", attr_thunder: "Thndr", attr_univ: "Univ",
                lbl_attribute: "Attr",
                qual_god: "Divine", qual_peerless: "Superior", qual_rare: "Epic", qual_common: "Common", qual_random: "Random",
                qual_peerless_short: "Sup", qual_rare_short: "Epic", qual_common_short: "Com",
                qual_legend: "Mythical",

                sec_settings: "Settings & Stock",
                sec_income_title: "Total Event Income Estimate",
                sec_details_title: "Scroll Sources Detail",
                row_base: "Stock+Fixed",
                row_maps: "Map Runs",
                row_conv: "Rdm Conv",
                row_synth: "Frag Synth",
                total_est: "Total Est.",
                exchange_ref: "ğŸ”„ Final Exchange Ref (2:1)",
                exchange_all_attr: "All to Attr",
                exchange_all_univ: "All to Univ",

                prog_title: "Fragment Synthesis Progress",
                prog_syn: "Craft", prog_need: "Need",

                sec_shop_title: "Shop Planning",
                shop_desc: "Select items you want to exchange.",
                shop_conv_attr: "Convert All to Attribute",
                shop_conv_univ: "Convert All to Universal",
                val_total: "Value", req_total: "Cost", bal_total: "Bal.",
                dtl_detail: "Detail",
                card_supply: "Supply", card_cost: "Cost", card_bal: "Net", card_inv: "Stock",

                sec_daily_title: "Daily Resource Log",
                th_day: "Day", th_date: "Date", th_gain: "Gain (Attr/Univ/Rdm)", th_acc: "Acc A/U", th_frag: "Acc Rdm", th_note: "Note",
                note_weekly: "Weekly Divine(+30A/+40U)",
                note_fixed: "Event Fixed",
                note_leg: "Mythical(+{v}U)",

                sec_source_title: "ğŸ“œ Fragment Source Reference",
                src_fixed_title: "ğŸ‰ Event Fixed Tasks (One-time)",
                src_weekly_title: "ğŸ“… Periodic Tasks",
                src_weekly_sub: "Weekly Tasks (Reset Sun)",
                src_daily_sub: "Daily (Random+Task)",
                src_daily_note: "(Daily Random 15 + Task 4)",
                src_art_reward: "Select 0-25 Random Frag",
                unit_frag: "pcs", unit_week: "/wk", unit_day: "/day",

                src_rewards_title: "ğŸ Map Rewards Table",
                reward_header_qual: "Quality", reward_header_role: "Role", reward_header_attr: "Attr Scrolls", reward_header_univ: "Univ Scrolls", reward_header_refund: "Refund",
                role_capt: "Captain", role_memb: "Member",

                help_title: "User Guide",
                help_p1: "Enter your stock (including map attributes) and fragments to calculate future income.",
                help_h1: "1. Purchasing Power (Now vs. Future)",
                help_p2: "Shop Planning uses multi-stage logic:",
                help_li1: "â— **Now**: Uses 'Current Stock Only'. Negative means unaffordable.",
                help_li2: "â— **Future**: Prioritizes specific scrolls from 'Owned Maps', then uses flexible income.",
                help_h2: "2. Recursive Synthesis",
                help_p3: "The tool simulates the '1-fragment refund after Superior/Epic/Common runs' rule:",
                help_li3: "Entering 10 fragments shows '1 Craft / 9 Needed' because 1 is returned after usage.",
                help_h3: "3. Shop Exchange Logic (Important!)",
                help_p4: "Items are processed in priority order. Each item uses resources in these steps:",
                help_li4: "â— **Step 1**: Current native stock (1:1 ratio)",
                help_li5: "â— **Step 2**: Future native income (1:1, priority to 1st attribute item)",
                help_li6: "â— **Step 3**: Current attributes NOT in cart (2:1 conversion)",
                help_li7: "â— **Step 4**: Lowest priority attributes IN cart (2:1 conversion)",
                help_li8: "â— **Step 5**: Future attribute income (2:1 conversion)",
                help_p5: "**Important**: Higher priority items use all available resources first. Later items only get remaining resources. Adding new items won't change previous items' calculations. Adjust item order to optimize resource allocation.",
                help_h4: "4. Zoom & Shortcuts",
                help_p6: "â— **Zoom Console**: Use [+] or [-] in the bottom right. Tap the percentage to reset to 100%.",
                help_p7: "â— **Drag to Reorder**: On desktop, drag items directly to adjust priority. On mobile, use arrow buttons.",
                help_p8: "â— **Auto-Save**: All input data is automatically saved to your browser and restored on next visit.",
                help_h5: "5. Daily Workflow",
                help_li4: "â— **Shortcuts**: Supports `Ctrl` + `+`/`-` zoom, and `Ctrl` + `0` to reset.",
                help_h5: "5. Recommended Routine",
                help_s1: "Daily Stock Update (Tab 1)",
                help_d1: "Fill in your latest scrolls, maps, and fragments.",
                help_s2: "Check Synthesis (Tab 1 Bottom Right)",
                help_d2: "If craftable, it means you can synthesize and raid in-game.",
                help_s3: "Plan Queue (Tab 2)",
                help_d3: "Add items and drag or use arrow buttons to prioritize. System drains resources sequentially.",
                btn_gotit: "Got it",

                // Priority Logic
                prio_title: "ğŸ† Dynamic Shopping Queue",
                prio_subtitle: "Calculated sequentially. Click to select, use arrows to reorder (desktop: drag).",
                prio_header_item: "Item",
                prio_header_calc: "Source",
                prio_header_status: "Status",
                prio_empty: "Cart is empty. Add items below.",
                prio_stock_used: "Current Attr Stock",
                prio_future_attr: "Future: Attr Reward",
                prio_future_univ: "Future: Univ Reward",
                prio_univ_stock: "Current Univ Stock",
                prio_univ_reward: "Future: Univ Reward",
                prio_conv_used: "Attr Conversion",
                btn_clear_all: "ğŸ—‘ï¸ Clear All",
                prio_gap: "Gap",
                shop_cost: "Cost",
                shop_gap: "Need",
                prio_status_stock: "âœ… Stock",
                prio_status_univ: "ğŸŸ¢ Univ Used",
                prio_status_convert: "ğŸ”µ Attr Conv",
                prio_status_gap: "ğŸ”´ Shortage",
                prio_farm: "Advice: Farm {attr}",
                prio_rem_univ: "Univ Rem:",

                // New Labels
                sec_future_breakdown: "Future Gain Breakdown (Rem. Counts)",
                th_source: "Source",
                th_count: "Rem.",
                th_attr: "Attr.",
                th_univ: "Univ.",
                th_frag: "Frag.",
                row_daily: "Daily Member",
                row_weekly_divine: "Weekly Divine",
                row_daily_frag: "Daily Random Frag",
                row_weekly_frag: "Weekly Divine Frag",
            }
        };
        // #endregion

        // --- å¸¸æ•¸è¨­å®š ---
        // #region å¸¸æ•¸èˆ‡é…ç½® (Constants)
        const START_DATE = new Date("2026-01-21T12:00:00+08:00");
        const END_DATE = new Date("2026-02-25T00:00:00+08:00");

        const DAILY_MEMBER_REWARD = { attr: 22, univ: 29 };
        const WEEKLY_MEMBER_REWARD = { attr: 30, univ: 40 };
        
        // å‚³é Œçå‹µ - ä¸€æ˜Ÿ
        const LEGEND_REWARD_1_STAR_MEMBER = { attr: 0, univ: 40 };
        const LEGEND_REWARD_1_STAR_CAPTAIN = { attr: 0, univ: 75 };
        // å‚³é Œçå‹µ - äºŒæ˜Ÿ
        const LEGEND_REWARD_2_STAR_MEMBER = { attr: 0, univ: 75 };
        const LEGEND_REWARD_2_STAR_CAPTAIN = { attr: 0, univ: 150 };
        
        // å‘ä¸‹å…¼å®¹ (é»˜èªä½¿ç”¨äºŒæ˜Ÿ)
        const LEGEND_REWARD_MEMBER = LEGEND_REWARD_2_STAR_MEMBER;
        const LEGEND_REWARD_CAPTAIN = LEGEND_REWARD_2_STAR_CAPTAIN;

        const FRAG_SOURCES = {
            dailyRandom: 19, weeklyGod: 3, fixedGod: 4, fixedPeerless: 5, fixedRare: 9, fixedCommon: 8, fixedRandom: 20
        };

        const CAPTAIN_REWARDS = {
            god: { attr: 30, univ: 40, refundFrag: 0 },
            peerless: { attr: 16, univ: 20, refundFrag: 1 },
            rare: { attr: 8, univ: 10, refundFrag: 1 },
            common: { attr: 4, univ: 5, refundFrag: 1 }
        };

        const RANDOM_CONVERSION = { attr: 4, univ: 5, refundCommonFrag: 1, cost: 10 };
        const WEEKDAYS = ["(æ—¥)", "(ä¸€)", "(äºŒ)", "(ä¸‰)", "(å››)", "(äº”)", "(å…­)"];
        const APP_VERSION = "v3.31";
        const APP_AUTHOR = "Nikis Ray";
        
        // è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—å‚³é Œç¸½çå‹µ
        const calculateLegendReward = (legendOptions) => {
            let totalUniv = 0;
            if (legendOptions.includeCaptain1Star) totalUniv += LEGEND_REWARD_1_STAR_CAPTAIN.univ;
            if (legendOptions.includeCaptain2Star) totalUniv += LEGEND_REWARD_2_STAR_CAPTAIN.univ;
            if (legendOptions.includeMember1Star) totalUniv += LEGEND_REWARD_1_STAR_MEMBER.univ;
            if (legendOptions.includeMember2Star) totalUniv += LEGEND_REWARD_2_STAR_MEMBER.univ;
            return totalUniv;
        };

        // --- å•†åº—è¨­å®š ---
        const ATTR_SHOP_ITEMS = [
            { id: 1, name: "I", cost: 1250 },
            { id: 2, name: "II", cost: 1000 },
            { id: 3, name: "III", cost: 750 },
            { id: 4, name: "IV", cost: 500 },
        ];
        const UNIV_SHOP_ITEMS = [
            { id: 1, name: "I", cost: 1500 },
            { id: 2, name: "II", cost: 1000 },
            { id: 3, name: "III", cost: 750 },
            { id: 4, name: "IV", cost: 500 },
        ];
        // #endregion

        function App() {
            // #region ç‹€æ…‹ç®¡ç† (State)
            const [activeTab, setActiveTab] = useState('main');
            const [viewMode, setViewMode] = useState('tabs');
            const [showHelp, setShowHelp] = useState(false);
            const [lang, setLang] = useState('zh');
            const [targetAttr, setTargetAttr] = useState('none');
            const [zoomLevel, setZoomLevel] = useState(() => {
                const saved = localStorage.getItem('treasure-zoom');
                return saved ? parseInt(saved) : 100;
            });

            useEffect(() => {
                document.documentElement.style.fontSize = `${zoomLevel}%`;
                localStorage.setItem('treasure-zoom', zoomLevel.toString());
            }, [zoomLevel]);

            // --- æ–°å¢ï¼šå¿«æ·éµæ”¯æ´ ---
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === '=' || e.key === '+') {
                            e.preventDefault();
                            setZoomLevel(prev => Math.min(250, prev + 10));
                        } else if (e.key === '-') {
                            e.preventDefault();
                            setZoomLevel(prev => Math.max(50, prev - 10));
                        } else if (e.key === '0') {
                            e.preventDefault();
                            setZoomLevel(100);
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            const t = I18N[lang];

            // #region ç‹€æ…‹åˆå§‹åŒ– - å¾ localStorage è®€å–
            const getInitialDate = () => {
                const saved = localStorage.getItem('treasure-date');
                if (saved) return saved;
                const now = new Date();
                if (now < START_DATE) return "2026-01-21";
                if (now > END_DATE) return "2026-02-25";
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };

            const getInitialInventory = () => {
                const saved = localStorage.getItem('treasure-inventory');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to parse inventory:', e);
                    }
                }
                return {
                    attrFire: 0, attrWater: 0, attrWind: 0, attrThunder: 0, univScrolls: 0,
                    godMaps: 0, peerlessMaps: 0, rareMaps: 0, commonMaps: 0,
                    godFrags: 0, peerlessFrags: 0, rareFrags: 0, commonFrags: 0, randomFrags: 0
                };
            };

            const getInitialLegendOptions = () => {
                const saved = localStorage.getItem('treasure-legend');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        // ç‚ºèˆŠç‰ˆæ•¸æ“šè½‰æ›æ ¼å¼
                        if (parsed.includeCaptain !== undefined || parsed.includeMember !== undefined) {
                            // èˆŠç‰ˆï¼šæœ‰ includeCaptain/includeMember
                            const starLevel = parsed.starLevel || 2;
                            return {
                                includeCaptain1Star: starLevel === 1 && parsed.includeCaptain,
                                includeCaptain2Star: starLevel === 2 && parsed.includeCaptain,
                                includeMember1Star: starLevel === 1 && parsed.includeMember,
                                includeMember2Star: starLevel === 2 && parsed.includeMember,
                                artEventAmount: parsed.artEventAmount || 0
                            };
                        }
                        // æ–°ç‰ˆæ ¼å¼ï¼Œç¢ºä¿æ‰€æœ‰å­—æ®µå­˜åœ¨
                        return {
                            includeCaptain1Star: parsed.includeCaptain1Star || false,
                            includeCaptain2Star: parsed.includeCaptain2Star || false,
                            includeMember1Star: parsed.includeMember1Star || false,
                            includeMember2Star: parsed.includeMember2Star || false,
                            artEventAmount: parsed.artEventAmount || 0
                        };
                    } catch (e) {
                        console.error('Failed to parse legend options:', e);
                    }
                }
                return { 
                    includeCaptain1Star: false, 
                    includeCaptain2Star: false, 
                    includeMember1Star: false, 
                    includeMember2Star: false, 
                    artEventAmount: 0 
                };
            };

            const getInitialCartQueue = () => {
                const saved = localStorage.getItem('treasure-cart-queue');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to parse cart queue:', e);
                    }
                }
                return [];
            };

            const getInitialShopCart = () => {
                const saved = localStorage.getItem('treasure-shop-cart');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to parse shop cart:', e);
                    }
                }
                return { fire: {}, water: {}, wind: {}, thunder: {}, univ: {} };
            };

            const [currentDateInput, setCurrentDateInput] = useState(getInitialDate);
            const [inventory, setInventory] = useState(getInitialInventory);
            const [legendOptions, setLegendOptions] = useState(getInitialLegendOptions);
            const [cartQueue, setCartQueue] = useState(getInitialCartQueue);
            const [shopCart, setShopCart] = useState(getInitialShopCart);
            const [selectedQueueIndex, setSelectedQueueIndex] = useState(null);
            const [dateError, setDateError] = useState('');
            const [draggedIndex, setDraggedIndex] = useState(null);
            const [isMobile, setIsMobile] = useState(false);
            // #endregion

            // æª¢æ¸¬æ˜¯å¦ç‚ºç§»å‹•è¨­å‚™
            useEffect(() => {
                const checkMobile = () => {
                    setIsMobile(window.innerWidth < 768 || 'ontouchstart' in window);
                };
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);

            // #region æ•¸æ“šæŒä¹…åŒ– - è‡ªå‹•ä¿å­˜åˆ° localStorage
            useEffect(() => {
                localStorage.setItem('treasure-date', currentDateInput);
            }, [currentDateInput]);

            useEffect(() => {
                localStorage.setItem('treasure-inventory', JSON.stringify(inventory));
            }, [inventory]);

            useEffect(() => {
                localStorage.setItem('treasure-legend', JSON.stringify(legendOptions));
            }, [legendOptions]);

            useEffect(() => {
                localStorage.setItem('treasure-cart-queue', JSON.stringify(cartQueue));
            }, [cartQueue]);

            useEffect(() => {
                localStorage.setItem('treasure-shop-cart', JSON.stringify(shopCart));
            }, [shopCart]);
            // #endregion

            // --- è¼”åŠ©å‡½å¼ ---
            // #region è¼”åŠ©å‡½å¼ (Utils)
            const getDaysDiff = (start, end) => {
                const s = new Date(start); s.setHours(0, 0, 0, 0);
                const e = new Date(end); e.setHours(0, 0, 0, 0);
                return Math.max(0, Math.round((e - s) / (1000 * 60 * 60 * 24)));
            };

            const countSundays = (start, end) => {
                let count = 0;
                let d = new Date(start); d.setHours(12, 0, 0, 0);
                while (d < end) {
                    if (d.getDay() === 0) count++;
                    d.setDate(d.getDate() + 1);
                }
                return count;
            };
            // #endregion

            // --- ä¸»è¦è¨ˆç®— ---
            // #region æ ¸å¿ƒè¨ˆç®—é‚è¼¯ (Calculation)
            const calculation = useMemo(() => {
                const totalDays = 35;
                const totalWeeks = 6;
                const userDate = new Date(currentDateInput);
                const daysRemaining = Math.min(getDaysDiff(userDate, END_DATE), totalDays);
                let weeksRemaining = 0;
                if (userDate < END_DATE) {
                    weeksRemaining = countSundays(userDate, END_DATE);
                    if (weeksRemaining > totalWeeks) weeksRemaining = totalWeeks;
                }

                // æœ‰æ•ˆæ¬¡æ•¸è¨ˆç®—
                const effDays = Math.max(0, daysRemaining - 1);
                const effWeeks = Math.max(0, weeksRemaining);

                // 1. éšŠå“¡æ®˜å· (Member Fragments)
                const memberIncomeAttr = (DAILY_MEMBER_REWARD.attr * effDays) + (WEEKLY_MEMBER_REWARD.attr * effWeeks);
                const memberIncomeUniv = (DAILY_MEMBER_REWARD.univ * effDays) + (WEEKLY_MEMBER_REWARD.univ * effWeeks);

                // 2. éšŠé•·æ®˜å· (Leader Fragments from Owned Maps)
                const getMapStats = (type, count) => ({
                    attr: count * CAPTAIN_REWARDS[type].attr,
                    univ: count * CAPTAIN_REWARDS[type].univ,
                    refund: count * CAPTAIN_REWARDS[type].refundFrag
                });

                const godReward = getMapStats('god', parseInt(inventory.godMaps || 0));
                const peerlessReward = getMapStats('peerless', parseInt(inventory.peerlessMaps || 0));
                const rareReward = getMapStats('rare', parseInt(inventory.rareMaps || 0));
                const commonReward = getMapStats('common', parseInt(inventory.commonMaps || 0));

                const leaderIncomeAttr = godReward.attr + peerlessReward.attr + rareReward.attr + commonReward.attr;
                const leaderIncomeUniv = godReward.univ + peerlessReward.univ + rareReward.univ + commonReward.univ;

                // 3. é€šç”¨æ®˜å·èˆ‡å…¶é¤˜æ”¶ç›Š
                const legendUniv = calculateLegendReward(legendOptions);
                const artEventFrags = (parseInt(legendOptions.artEventAmount) || 0);

                // éš¨æ©Ÿè½‰åŒ–
                const isStart = userDate <= START_DATE;
                const futureRandomFrags = (FRAG_SOURCES.dailyRandom * effDays) + (isStart ? FRAG_SOURCES.fixedRandom : 0) + artEventFrags;
                const totalRandomPool = parseInt(inventory.randomFrags || 0) + futureRandomFrags;
                const randomToMapsCount = Math.floor(totalRandomPool / 10);
                const convertedAttr = randomToMapsCount * RANDOM_CONVERSION.attr;
                const convertedUniv = randomToMapsCount * RANDOM_CONVERSION.univ;
                const refundedCommonFrags = randomToMapsCount * RANDOM_CONVERSION.refundCommonFrag;

                // ç¢ç‰‡åˆæˆæ”¶ç›Š
                const godRefund = 0; // Gods don't refund
                const peerlessRefund = parseInt(inventory.peerlessMaps || 0) * CAPTAIN_REWARDS.peerless.refundFrag;
                const rareRefund = parseInt(inventory.rareMaps || 0) * CAPTAIN_REWARDS.rare.refundFrag;
                const commonRefund = parseInt(inventory.commonMaps || 0) * CAPTAIN_REWARDS.common.refundFrag;

                const totalGodPool = parseInt(inventory.godFrags || 0) + ((FRAG_SOURCES.weeklyGod * effWeeks) + (isStart ? FRAG_SOURCES.fixedGod : 0));
                const totalPeerlessPool = parseInt(inventory.peerlessFrags || 0) + ((isStart ? FRAG_SOURCES.fixedPeerless : 0) + peerlessRefund + (effDays * 1));
                const totalRarePool = parseInt(inventory.rareFrags || 0) + ((isStart ? FRAG_SOURCES.fixedRare : 0) + rareRefund + (effDays * 2));
                const totalCommonPoolFinal = parseInt(inventory.commonFrags || 0) + ((isStart ? FRAG_SOURCES.fixedCommon : 0) + commonRefund + refundedCommonFrags + (effDays * 3));

                const mapsFromGod = analyzeFragment(totalGodPool, CAPTAIN_REWARDS.god.refundFrag).maps;
                const mapsFromPeerless = analyzeFragment(totalPeerlessPool, CAPTAIN_REWARDS.peerless.refundFrag).maps;
                const mapsFromRare = analyzeFragment(totalRarePool, CAPTAIN_REWARDS.rare.refundFrag).maps;
                const mapsFromCommon = analyzeFragment(totalCommonPoolFinal, CAPTAIN_REWARDS.common.refundFrag).maps;

                const fragSynthAttr = (mapsFromGod * CAPTAIN_REWARDS.god.attr) + (mapsFromPeerless * CAPTAIN_REWARDS.peerless.attr) +
                    (mapsFromRare * CAPTAIN_REWARDS.rare.attr) + (mapsFromCommon * CAPTAIN_REWARDS.common.attr);
                const fragSynthUniv = (mapsFromGod * CAPTAIN_REWARDS.god.univ) + (mapsFromPeerless * CAPTAIN_REWARDS.peerless.univ) +
                    (mapsFromRare * CAPTAIN_REWARDS.rare.univ) + (mapsFromCommon * CAPTAIN_REWARDS.common.univ);

                // ç¸½çµç®—
                const inventoryAttrTotal = parseInt(inventory.attrFire || 0) + parseInt(inventory.attrWater || 0) +
                    parseInt(inventory.attrWind || 0) + parseInt(inventory.attrThunder || 0);

                // Final Categorized Pools
                const finalMemberAttr = memberIncomeAttr;
                const finalLeaderAttr = leaderIncomeAttr;
                const finalConversionAttr = convertedAttr + fragSynthAttr;

                const finalUnivBase = parseInt(inventory.univScrolls || 0) + legendUniv;
                const finalUnivReward = memberIncomeUniv + leaderIncomeUniv + convertedUniv + fragSynthUniv;

                const grandTotalAttr = inventoryAttrTotal + finalMemberAttr + finalLeaderAttr + finalConversionAttr;
                const grandTotalUniv = finalUnivBase + finalUnivReward;

                // Waterfall Pools
                // Separate pools as requested: Member Future Attr vs Leader Future Attr
                const futureMemberIncomeAttr = memberIncomeAttr;
                const futureLeaderIncomeAttr = leaderIncomeAttr + convertedAttr + fragSynthAttr;
                const futureMapsIncome = { fire: 0, water: 0, wind: 0, thunder: 0 }; // No more attribute-specific fixed maps

                // å•†åº—æ¶ˆè€—è¨ˆç®— (Legacy helpers)
                const calcCategoryCost = (category) => {
                    let cost = 0;
                    const items = category === 'univ' ? UNIV_SHOP_ITEMS : ATTR_SHOP_ITEMS;
                    items.forEach(item => {
                        const count = shopCart[category][item.id] || 0;
                        cost += count * item.cost;
                    });
                    return cost;
                };

                return {
                    daysRemaining, weeksRemaining, legendUniv,
                    memberIncomeAttr, memberIncomeUniv,
                    leaderIncomeAttr, leaderIncomeUniv,
                    convertedAttr, convertedUniv,
                    fragSynthAttr, fragSynthUniv,
                    grandTotalAttr, grandTotalUniv,
                    univBase: finalUnivBase,
                    futureMemberIncomeAttr,
                    futureLeaderIncomeAttr,
                    futureMapsIncome,
                    allAsAttr: grandTotalAttr + grandTotalUniv,
                    allAsUniv: grandTotalUniv + Math.floor(grandTotalAttr / 2),
                    shopCostFire: calcCategoryCost('fire'), shopCostWater: calcCategoryCost('water'),
                    shopCostWind: calcCategoryCost('wind'), shopCostThunder: calcCategoryCost('thunder'),
                    shopCostUniv: calcCategoryCost('univ'),
                    shopCostAttrTotal: calcCategoryCost('fire') + calcCategoryCost('water') + calcCategoryCost('wind') + calcCategoryCost('thunder'),
                    totalRandomPool,
                    godStatus: analyzeFragment(totalGodPool, CAPTAIN_REWARDS.god.refundFrag),
                    peerlessStatus: analyzeFragment(totalPeerlessPool, CAPTAIN_REWARDS.peerless.refundFrag),
                    rareStatus: analyzeFragment(totalRarePool, CAPTAIN_REWARDS.rare.refundFrag),
                    commonStatus: analyzeFragment(totalCommonPoolFinal, CAPTAIN_REWARDS.common.refundFrag),
                    randomStatus: analyzeFragment(totalRandomPool, 0),
                    totalGodPool, totalPeerlessPool, totalRarePool, totalCommonPoolFinal,
                    effDays, effWeeks
                };
            }, [currentDateInput, inventory, legendOptions]);

            // --- NEW: Waterfall Queue Calculation ---
            const priorityQueueAnalysisData = useMemo(() => {
                // Determine auto-target attribute if set to 'none'
                let effectiveTargetAttr = targetAttr;
                if (effectiveTargetAttr === 'none') {
                    const firstAttrItem = cartQueue.find(it => it.category !== 'univ');
                    if (firstAttrItem) effectiveTargetAttr = firstAttrItem.category;
                }

                let pools = {
                    uStock: { val: parseInt(inventory.univScrolls || 0) },
                    uReward: { val: Math.max(0, (calculation.grandTotalUniv || 0) - parseInt(inventory.univScrolls || 0)) },
                    fFlex: { val: (calculation.futureMemberIncomeAttr || 0) + (calculation.futureLeaderIncomeAttr || 0) },
                    aStock: {
                        fire: { val: parseInt(inventory.attrFire || 0) }, water: { val: parseInt(inventory.attrWater || 0) },
                        wind: { val: parseInt(inventory.attrWind || 0) }, thunder: { val: parseInt(inventory.attrThunder || 0) }
                    }
                };

                // Initialize results
                const results = cartQueue.map(item => ({
                    ...item,
                    nativeUsed: 0,        // æ­¥é©Ÿ1: ç¾æœ‰ åŒå±¬æ€§ (1:1)
                    nonTargetUniv: 0,     // æ­¥é©Ÿ2: éç›®æ¨™ ç„¡å±¬ (1:1)
                    futureNativeUsed: 0,  // æ­¥é©Ÿ3: å¾ŒçºŒæ‰è½ åŒå±¬ (1:1)
                    futureUnivUsed: 0,    // æ­¥é©Ÿ3/4: å¾ŒçºŒæ‰è½ ç„¡å±¬ (1:1)
                    nonTargetOtherRaw: 0, // æ­¥é©Ÿ4: éç›®æ¨™ ä¸åŒå±¬ (2:1)
                    futureOtherRaw: 0,    // æ­¥é©Ÿ5: å¾ŒçºŒæ‰è½ ä¸åŒå±¬ (2:1)
                    conversionStolenRaw: 0, // æ­¥é©Ÿ6: éœ€åˆ†è§£å…¶ä»–
                    stolenFromMe: 0,      // è¢«åˆ†è§£
                    gap: item.cost,
                    status: 'gap',
                    reservedNative: 0     // Phase 1 é ç•™çš„ç¾æœ‰åº«å­˜
                }));

                // åˆ†æå•†å“æ¬„è£¡æœ‰å“ªäº›å±¬æ€§ï¼ˆç”¨æ–¼åˆ¤æ–·æ­¥é©Ÿ3å’Œ4ï¼‰
                const attributesInCart = {
                    fire: false, water: false, wind: false, thunder: false
                };
                const attributePriority = []; // æŒ‰é †åºè¨˜éŒ„å±¬æ€§å‡ºç¾çš„å„ªå…ˆæ¬Š
                
                results.forEach(res => {
                    if (res.category !== 'univ' && !attributesInCart[res.category]) {
                        attributesInCart[res.category] = true;
                        attributePriority.push(res.category);
                    }
                });

                // æŒ‰é †åºé€å€‹å®Œæ•´è™•ç†æ¯å€‹å•†å“
                results.forEach((res, i) => {
                    
                    // æ­¥é©Ÿ1: ç¾æœ‰åŒå±¬æ€§åº«å­˜ (1:1)
                    const nativePool = res.category === 'univ' ? pools.uStock : pools.aStock[res.category];
                    if (nativePool && nativePool.val > 0 && res.gap > 0) {
                        const took = Math.min(res.gap, nativePool.val);
                        res.nativeUsed = took;
                        res.reservedNative = took;
                        res.gap -= took;
                        nativePool.val -= took;
                    }
                    
                    if (res.gap <= 0) return;

                    // æ­¥é©Ÿ2: æœªä¾†ç²å–åŒå±¬æ€§ (1:1)
                    if (res.category !== 'univ' && res.category === effectiveTargetAttr) {
                        if (pools.fFlex.val > 0 && res.gap > 0) {
                            const took = Math.min(res.gap, pools.fFlex.val);
                            res.futureNativeUsed += took;
                            res.gap -= took;
                            pools.fFlex.val -= took;
                        }
                    } else if (res.category === 'univ') {
                        if (pools.uReward.val > 0 && res.gap > 0) {
                            const took = Math.min(res.gap, pools.uReward.val);
                            res.futureUnivUsed += took;
                            res.gap -= took;
                            pools.uReward.val -= took;
                        }
                    }
                    
                    if (res.gap <= 0) return;

                    // æ­¥é©Ÿ3: ç¾æœ‰ã€Œä¸åœ¨å•†å“æ¬„ã€çš„å±¬æ€§æ®˜å· (2:1)
                    if (res.category === 'univ') {
                        const notInCart = ['fire', 'water', 'wind', 'thunder'].filter(attr => !attributesInCart[attr]);
                        notInCart.forEach(attr => {
                            if (res.gap <= 0 || pools.aStock[attr].val <= 0) return;
                            const needed = res.gap * 2;
                            const took = Math.min(pools.aStock[attr].val, needed);
                            const gain = Math.floor(took / 2);
                            if (gain > 0) {
                                res.nonTargetOtherRaw += took;
                                res.gap -= gain;
                                pools.aStock[attr].val -= took;
                            }
                        });
                    }
                    
                    if (res.gap <= 0) return;

                    // æ­¥é©Ÿ4: ç¾æœ‰ã€Œå•†å“æ¬„è£¡æœ€ä½å„ªå…ˆæ¬Šã€çš„å±¬æ€§æ®˜å· (2:1)
                    if (res.category === 'univ') {
                        const inCartReversed = [...attributePriority].reverse();
                        inCartReversed.forEach(attr => {
                            if (res.gap <= 0 || pools.aStock[attr].val <= 0) return;
                            const needed = res.gap * 2;
                            const took = Math.min(pools.aStock[attr].val, needed);
                            const gain = Math.floor(took / 2);
                            if (gain > 0) {
                                res.nonTargetOtherRaw += took;
                                res.gap -= gain;
                                pools.aStock[attr].val -= took;
                            }
                        });
                    }
                    
                    if (res.gap <= 0) return;

                    // === å±¬æ€§å•†å“çš„æ­¥é©Ÿ3-6 ===
                    if (res.category !== 'univ') {
                        // æ­¥é©Ÿ3: æœªä¾†é€šç”¨æ®˜å· (1:1)
                        if (pools.uReward.val > 0 && res.gap > 0) {
                            const took = Math.min(res.gap, pools.uReward.val);
                            res.futureUnivUsed += took;
                            res.gap -= took;
                            pools.uReward.val -= took;
                        }
                        
                        if (res.gap <= 0) return;
                        
                        // æ­¥é©Ÿ4: ä¸åœ¨å•†å“æ¬„çš„å±¬æ€§ (2:1)
                        const notInCart = ['fire', 'water', 'wind', 'thunder'].filter(attr => !attributesInCart[attr] && attr !== res.category);
                        notInCart.forEach(attr => {
                            if (res.gap <= 0 || pools.aStock[attr].val <= 0) return;
                            const needed = res.gap * 2;
                            const took = Math.min(pools.aStock[attr].val, needed);
                            const gain = Math.floor(took / 2);
                            if (gain > 0) {
                                res.nonTargetOtherRaw += took;
                                res.gap -= gain;
                                pools.aStock[attr].val -= took;
                            }
                        });
                        
                        if (res.gap <= 0) return;
                        
                        // æ­¥é©Ÿ5: å•†å“æ¬„æœ€ä½å„ªå…ˆæ¬Šçš„å±¬æ€§ (2:1) - æ’é™¤è‡ªå·±
                        const inCartReversed = [...attributePriority].reverse().filter(attr => attr !== res.category);
                        inCartReversed.forEach(attr => {
                            if (res.gap <= 0 || pools.aStock[attr].val <= 0) return;
                            const needed = res.gap * 2;
                            const took = Math.min(pools.aStock[attr].val, needed);
                            const gain = Math.floor(took / 2);
                            if (gain > 0) {
                                res.nonTargetOtherRaw += took;
                                res.gap -= gain;
                                pools.aStock[attr].val -= took;
                            }
                        });
                        
                        if (res.gap <= 0) return;
                        
                        // æ­¥é©Ÿ6: æœªä¾†å±¬æ€§æ®˜å· (2:1)
                        if (pools.fFlex.val > 0 && res.gap > 0) {
                            const needed = res.gap * 2;
                            const took = Math.min(pools.fFlex.val, needed);
                            const gain = Math.floor(took / 2);
                            if (gain > 0) {
                                res.futureOtherRaw += took;
                                res.gap -= gain;
                                pools.fFlex.val -= took;
                            }
                        }
                    }

                    // === é€šç”¨å•†å“çš„æ­¥é©Ÿ5 ===
                    if (res.category === 'univ' && pools.fFlex.val > 0 && res.gap > 0) {
                        const needed = res.gap * 2;
                        const took = Math.min(pools.fFlex.val, needed);
                        const gain = Math.floor(took / 2);
                        if (gain > 0) {
                            res.futureOtherRaw += took;
                            res.gap -= gain;
                            pools.fFlex.val -= took;
                        }
                    }
                });

                const finalResults = results.map(res => {
                    const filled = res.cost - res.gap;
                    res.progress = `${filled}/${res.cost}`;
                    if (res.gap <= 0) {
                        if (res.nativeUsed > 0 || res.futureNativeUsed > 0) res.status = 'stock';
                        else if (res.nonTargetUniv > 0 || res.futureUnivUsed > 0) res.status = 'univ';
                        else res.status = 'convert';
                    } else res.status = 'gap';

                    return { ...res };
                });

                return {
                    results: finalResults,
                    remnants: {
                        univ: pools.uStock.val + pools.uReward.val,
                        fire: pools.aStock.fire.val, water: pools.aStock.water.val,
                        wind: pools.aStock.wind.val, thunder: pools.aStock.thunder.val,
                        flexible: pools.fFlex.val
                    }
                };
            }, [cartQueue, calculation, inventory, targetAttr]);

            const priorityQueueAnalysis = priorityQueueAnalysisData.results;
            const queueRemnants = priorityQueueAnalysisData.remnants;
            // #endregion


            function analyzeFragment(count, refund = 0) {
                // Recursive calculation for maps: maps = 1 + floor((totalFrags - 10) / (10 - refund))
                // Each map synth requires 10, but returns 'refund' pieces back.
                const maps = count >= 10 ? (refund === 0 ? Math.floor(count / 10) : 1 + Math.floor((count - 10) / (10 - refund))) : 0;
                const totalConsumed = maps * 10;
                const totalRefunded = maps * refund;
                const current = count - totalConsumed + totalRefunded;
                const needed = 10 - current;
                return { maps, current, needed: needed <= 0 ? 0 : needed };
            }

            const dailyTable = useMemo(() => {
                let rows = [];
                let curr = new Date(START_DATE);
                let accAttr = 0, accUniv = 0, accRandom = 0;

                for (let i = 1; i <= 35; i++) {
                    const dateStr = curr.toISOString().split('T')[0];
                    const weekDay = WEEKDAYS[curr.getDay()];
                    const isSunday = curr.getDay() === 0;

                    let dayAttr = DAILY_MEMBER_REWARD.attr;
                    let dayUniv = DAILY_MEMBER_REWARD.univ;
                    let dayRandom = FRAG_SOURCES.dailyRandom;
                    let notes = [];

                    if (isSunday || i === 1) {
                        dayAttr += WEEKLY_MEMBER_REWARD.attr;
                        dayUniv += WEEKLY_MEMBER_REWARD.univ;
                        notes.push({ text: t.note_weekly, style: "font-bold text-black" });
                    }
                    if (i === 1) {
                        notes.push({ text: t.note_fixed, style: "text-gray-500" });
                        accRandom += FRAG_SOURCES.fixedRandom + (parseInt(legendOptions.artEventAmount) || 0);

                        let legUniv = calculateLegendReward(legendOptions);
                        if (legUniv > 0) {
                            dayUniv += legUniv;
                            const noteText = t.note_leg.replace('{v}', legUniv);
                            notes.push({ text: noteText, style: "font-bold text-orange-600" });
                        }
                    }

                    accAttr += dayAttr;
                    accUniv += dayUniv;
                    accRandom += dayRandom;

                    rows.push({
                        day: i, date: `${dateStr.slice(5)} ${lang === 'zh' ? weekDay : ''}`,
                        dayAttr, dayUniv, dayRandom,
                        accAttr, accUniv, accRandom,
                        notes
                    });
                    curr.setDate(curr.getDate() + 1);
                }
                return rows;
            }, [legendOptions, lang]);

            // #region äº‹ä»¶è™•ç† (Event Handlers)
            // --- è¼¸å…¥é©—è­‰ ---
            const handleDateChange = (val) => {
                const inputDate = new Date(val);
                const minDate = new Date('2026-01-21');
                const maxDate = new Date('2026-02-25');
                
                if (inputDate < minDate || inputDate > maxDate) {
                    setDateError(lang === 'zh' 
                        ? 'æ—¥æœŸå¿…é ˆåœ¨ 2026-01-21 è‡³ 2026-02-25 ä¹‹é–“' 
                        : 'Date must be between 2026-01-21 and 2026-02-25');
                } else {
                    setDateError('');
                }
                setCurrentDateInput(val);
            };

            const updateInv = (field, val) => {
                let numVal = parseInt(val);
                if (val === "") {
                    setInventory(prev => ({ ...prev, [field]: "" }));
                    return;
                }
                if (numVal < 0 || numVal > 999999) return; // é™åˆ¶ç¯„åœ
                setInventory(prev => ({ ...prev, [field]: numVal.toString() }));
            };

            const updateArtEvent = (val) => {
                let numVal = parseInt(val);
                if (val === "") {
                    setLegendOptions(prev => ({ ...prev, artEventAmount: "" }));
                    return;
                }
                if (numVal < 0 || numVal > 999999) return;
                setLegendOptions(prev => ({ ...prev, artEventAmount: numVal }));
            };

            const toggleLegend = (field) => setLegendOptions(prev => ({ ...prev, [field]: !prev[field] }));

            const clearScrolls = () => setInventory(prev => ({ ...prev, attrFire: 0, attrWater: 0, attrWind: 0, attrThunder: 0, univScrolls: 0 }));
            const clearMaps = () => setInventory(prev => ({
                ...prev,
                godMaps: 0, peerlessMaps: 0, rareMaps: 0, commonMaps: 0
            }));
            const clearFrags = () => setInventory(prev => ({ ...prev, godFrags: 0, peerlessFrags: 0, rareFrags: 0, commonFrags: 0, randomFrags: 0 }));

            // --- Updated Shop Logic with Queue ---
            const updateShop = (category, item, delta) => {
                // 1. Update the Count Map (Legacy for UI)
                setShopCart(prev => {
                    const currentCount = prev[category][item.id] || 0;
                    const newCount = Math.max(0, currentCount + delta);
                    return { ...prev, [category]: { ...prev[category], [item.id]: newCount } };
                });

                // 2. Update the Queue
                setCartQueue(prev => {
                    if (delta > 0) {
                        const newId = Date.now() + Math.random();
                        const newQueue = [...prev, {
                            uid: newId,
                            category,
                            id: item.id,
                            name: item.name,
                            cost: item.cost
                        }];
                        // Update selection index to the newly added item (end of list)
                        setSelectedQueueIndex(newQueue.length - 1);
                        return newQueue;
                    } else {
                        // Remove Last Occurrence
                        const reversed = [...prev].reverse();
                        const indexToRemove = reversed.findIndex(q => q.category === category && q.id === item.id);

                        if (indexToRemove !== -1) {
                            const newReversed = [...reversed];
                            newReversed.splice(indexToRemove, 1);
                            const finalQueue = newReversed.reverse();
                            setSelectedQueueIndex(null);
                            return finalQueue;
                        }
                        return prev;
                    }
                });
            };

            const clearShopCategory = (category) => {
                setShopCart(prev => ({ ...prev, [category]: {} }));
                // Also clear from queue
                setCartQueue(prev => prev.filter(item => item.category !== category));
            };

            // --- Manual Control Handlers ---
            const handleQueueItemClick = (index) => {
                if (selectedQueueIndex === index) {
                    setSelectedQueueIndex(null);
                } else {
                    setSelectedQueueIndex(index);
                }
            };

            const handleMoveUp = () => {
                if (selectedQueueIndex === null || selectedQueueIndex === 0) return;
                const newQueue = [...cartQueue];
                [newQueue[selectedQueueIndex - 1], newQueue[selectedQueueIndex]] = [newQueue[selectedQueueIndex], newQueue[selectedQueueIndex - 1]];
                setCartQueue(newQueue);
                setSelectedQueueIndex(selectedQueueIndex - 1);
            };

            const handleMoveDown = () => {
                if (selectedQueueIndex === null || selectedQueueIndex === cartQueue.length - 1) return;
                const newQueue = [...cartQueue];
                [newQueue[selectedQueueIndex + 1], newQueue[selectedQueueIndex]] = [newQueue[selectedQueueIndex], newQueue[selectedQueueIndex + 1]];
                setCartQueue(newQueue);
                setSelectedQueueIndex(selectedQueueIndex + 1);
            };

            // --- æ‹–æ‹½æ’åº Handlers (åƒ…æ¡Œé¢ç«¯) ---
            const handleDragStart = (e, index) => {
                if (isMobile) return; // æ‰‹æ©Ÿç¦ç”¨
                setDraggedIndex(index);
                if (e.dataTransfer) {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', e.currentTarget);
                }
            };

            const handleDragOver = (e, index) => {
                if (isMobile) return; // æ‰‹æ©Ÿç¦ç”¨
                e.preventDefault();
                if (e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'move';
                }
                
                if (draggedIndex === null || draggedIndex === index) return;
                
                const newQueue = [...cartQueue];
                const draggedItem = newQueue[draggedIndex];
                newQueue.splice(draggedIndex, 1);
                newQueue.splice(index, 0, draggedItem);
                
                setCartQueue(newQueue);
                setDraggedIndex(index);
            };

            const handleDragEnd = () => {
                if (isMobile) return; // æ‰‹æ©Ÿç¦ç”¨
                setDraggedIndex(null);
            };

            // --- è§¸æ§æ‹–æ‹½å·²ç§»é™¤ï¼ˆæ‰‹æ©Ÿä½¿ç”¨ä¸Šä¸‹ç®­é ­ï¼‰ ---

            const handleDeleteItem = () => {
                if (selectedQueueIndex === null) return;
                const itemToRemove = cartQueue[selectedQueueIndex];

                const newQueue = [...cartQueue];
                newQueue.splice(selectedQueueIndex, 1);
                setCartQueue(newQueue);

                // Fix selection state: inherit next index or keep same or null
                if (newQueue.length === 0) {
                    setSelectedQueueIndex(null);
                } else {
                    const nextIndex = Math.min(selectedQueueIndex, newQueue.length - 1);
                    setSelectedQueueIndex(nextIndex);
                }

                // Sync with ShopCart counts
                setShopCart(prev => {
                    const cat = itemToRemove.category;
                    const id = itemToRemove.id;
                    const currentCount = prev[cat][id] || 0;
                    const newCount = Math.max(0, currentCount - 1);
                    return { ...prev, [cat]: { ...prev[cat], [id]: newCount } };
                });
            };
            const clearAllQueue = () => {
                if (window.confirm(lang === 'zh' ? 'ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ' : 'Clear all items?')) {
                    setCartQueue([]);
                    setShopCart({ fire: {}, water: {}, wind: {}, thunder: {}, univ: {} });
                    setSelectedQueueIndex(null);
                }
            };
            // #endregion

            // #region ä»‹é¢è¼”åŠ©å…ƒä»¶ (UI Components)
            const ShopItem = ({ item, category, color }) => {
                const count = shopCart[category][item.id] || 0;
                const costStyle = category === 'univ' ? "text-green-600" : "text-blue-600";

                return (
                    <div className="shop-counter">
                        <div className="flex flex-col justify-center">
                            <div className={`shop-item-cost-large ${costStyle}`}>{item.cost}</div>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={() => updateShop(category, item, -1)} disabled={count <= 0}>-</button>
                            <span className={`text-sm font-bold w-6 text-center ${count > 0 ? color : 'text-gray-400'}`}>{count}</span>
                            <button onClick={() => updateShop(category, item, 1)}>+</button>
                        </div>
                    </div>
                );
            };

            const AttrDashboardCard = ({ label, textColor, bgColorClass, inv, cost }) => {
                const net = inv - cost;

                return (
                    <div className={`p-2 rounded-lg border ${bgColorClass} ${net >= 0 ? 'border-gray-200' : 'border-red-500 border-2'}`}>
                        <div className={`font-bold text-[0.75rem] mb-1 ${textColor}`}>{label}</div>
                        <div className="space-y-1 text-[0.625rem] text-gray-600">
                            <div className="flex justify-between"><span>{t.card_inv}:</span> <span>{(inv || 0).toLocaleString()}</span></div>
                            <div className="flex justify-between text-pink-600"><span>{t.card_cost}:</span> <span>-{(cost || 0).toLocaleString()}</span></div>
                            <div className="border-t border-gray-200 my-0.5 pt-0.5 flex justify-between items-center">
                                <span className="font-bold">{t.card_bal}:</span>
                                <span className={`font-bold text-sm ${net >= 0 ? 'text-blue-600' : 'text-red-600 font-extrabold'}`}>{net}</span>
                            </div>
                        </div>
                    </div>
                );
            };

            const getAttrLabel = (key) => t[`attr_${key}`];
            const getAttrColorText = (key) => `color-${key}`;
            const getAttrBg = (key) => `bg-${key}-light`;
            // #endregion

            // #region ä»‹é¢ä½ˆå±€ (UI Layout)
            return (
                <div className="max-w-5xl xl:max-w-7xl mx-auto p-2 md:p-6 flex flex-col min-h-screen relative">
                    {/* Top Section */}
                    <div className="flex flex-col md:flex-row justify-between items-center mb-4 pt-2 gap-3">
                        <div className="text-[0.75rem] font-bold text-gray-500 font-mono flex items-center justify-center md:justify-start order-2 md:order-1 flex-shrink-0">
                            {APP_VERSION} | {APP_AUTHOR}
                        </div>
                        <div className="text-center order-1 md:order-2 px-2">
                            <h1 className="text-2xl font-bold text-indigo-900 mb-0 leading-tight whitespace-nowrap">{t.title}</h1>
                            <p className="text-gray-500 text-[0.625rem]">{t.period}</p>
                        </div>
                        <div className="flex flex-wrap gap-2 justify-center md:justify-end order-3 md:order-3 flex-grow md:flex-grow-0">
                            <button onClick={() => setLang(prev => prev === 'zh' ? 'en' : 'zh')} className="bg-white text-indigo-600 px-3 py-1 rounded-full shadow-sm text-[0.75rem] font-bold hover:bg-indigo-50 transition border border-indigo-200 min-h-[1.875rem] flex items-center flex-shrink-0 whitespace-nowrap">
                                {lang === 'zh' ? 'EN' : 'ä¸­'}
                            </button>
                            <button onClick={() => setShowHelp(true)} className="bg-white text-gray-600 px-3 py-1 rounded-full shadow-sm text-[0.75rem] font-bold hover:bg-gray-50 transition border border-gray-200 min-h-[1.875rem] flex items-center flex-shrink-0 whitespace-nowrap">{t.btn_help}</button>
                            <button onClick={() => setViewMode(prev => prev === 'tabs' ? 'single' : 'tabs')} className="bg-white text-indigo-600 px-3 py-1 rounded-full shadow-sm text-[0.75rem] font-bold hover:bg-indigo-50 transition border border-indigo-100 flex items-center gap-1 min-h-[1.875rem] flex-shrink-0 whitespace-nowrap">
                                {viewMode === 'tabs' ? t.btn_tabs : t.btn_single}
                            </button>
                        </div>
                    </div>

                    {/* Help Modal */}
                    {showHelp && (
                        <div className="modal-overlay" onClick={() => setShowHelp(false)}>
                            <div className="modal-content p-6" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="text-xl font-bold text-gray-800">{t.help_title}</h3>
                                    <button onClick={() => setShowHelp(false)} className="text-gray-500 font-bold">Ã—</button>
                                </div>
                                <div className="space-y-4 text-sm text-gray-700 overflow-y-auto px-1" style={{ maxHeight: '70vh' }}>
                                    <p>{t.help_p1}</p>

                                    {/* Section 1 */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1">{t.help_h1}</h4>
                                    <p>{t.help_p2}</p>
                                    <ul className="list-disc pl-5 space-y-1">
                                        <li>{t.help_li1}</li>
                                        <li>{t.help_li2}</li>
                                    </ul>

                                    {/* Section 2 */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1 mt-4">{t.help_h2}</h4>
                                    <p>{t.help_p3}</p>
                                    <ul className="list-disc pl-5 space-y-1">
                                        <li>{t.help_li3}</li>
                                    </ul>

                                    {/* Section 3 - Calculation Logic */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1 mt-4">{t.help_h3}</h4>
                                    <p className="mt-1">{t.help_p4}</p>
                                    <ul className="list-none pl-3 space-y-1 text-sm">
                                        <li>{t.help_li4}</li>
                                        <li>{t.help_li5}</li>
                                        <li>{t.help_li6}</li>
                                        <li>{t.help_li7}</li>
                                        <li>{t.help_li8}</li>
                                    </ul>
                                    <p className="mt-2 text-sm bg-amber-50 p-2 rounded border-l-4 border-amber-400">{t.help_p5}</p>

                                    {/* Section 4 - Zoom & Shortcuts */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1 mt-4">{t.help_h4}</h4>
                                    <p className="mt-1">{t.help_p6}</p>
                                    <p className="mt-1">{t.help_p7}</p>
                                    <p className="mt-1">{t.help_p8}</p>

                                    {/* Section 5 - Daily Workflow */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1 mt-4">{t.help_h5}</h4>
                                    <ol className="list-decimal pl-5 space-y-2">
                                        <li><strong>{t.help_s1}</strong>ï¼š<p className="text-[0.75rem] text-gray-500 mt-0.5">{t.help_d1}</p></li>
                                        <li><strong>{t.help_s2}</strong>ï¼š<p className="text-[0.75rem] text-gray-500 mt-0.5">{t.help_d2}</p></li>
                                        <li><strong>{t.help_s3}</strong>ï¼š<p className="text-[0.75rem] text-gray-500 mt-0.5">{t.help_d3}</p></li>
                                    </ol>
                                </div>
                                <div className="mt-6 text-center"><button onClick={() => setShowHelp(false)} className="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 transition">{t.btn_gotit}</button></div>
                            </div>
                        </div>
                    )}

                    {/* åˆ†é  Tab */}
                    {viewMode === 'tabs' && (
                        <div className="flex border-b border-gray-200 mb-4 bg-white rounded-t-lg shadow-sm tabs-container mx-1">
                            <div className={`tab-btn rounded-tl-lg ${activeTab === 'main' ? 'active' : ''}`} onClick={() => setActiveTab('main')}>
                                <span className="hidden sm:inline">{t.tab_main}</span>
                                <span className="inline sm:hidden">{t.tab_main_short}</span>
                            </div>
                            <div className={`tab-btn ${activeTab === 'shop' ? 'active' : ''}`} onClick={() => setActiveTab('shop')}>
                                <span className="hidden sm:inline">{t.tab_shop}</span>
                                <span className="inline sm:hidden">{t.tab_shop_short}</span>
                            </div>
                            <div className={`tab-btn ${activeTab === 'daily' ? 'active' : ''}`} onClick={() => setActiveTab('daily')}>
                                <span className="hidden sm:inline">{t.tab_daily}</span>
                                <span className="inline sm:hidden">{t.tab_daily_short}</span>
                            </div>
                            <div className={`tab-btn rounded-tr-lg ${activeTab === 'sources' ? 'active' : ''}`} onClick={() => setActiveTab('sources')}>
                                <span className="hidden sm:inline">{t.tab_sources}</span>
                                <span className="inline sm:hidden">{t.tab_sources_short}</span>
                            </div>
                        </div>
                    )}

                    {/* Merged Tab 1: è¨­å®šåº«å­˜èˆ‡æ”¶ç›Šé ä¼° */}
                    {(viewMode === 'single' || activeTab === 'main') && (
                        <div className={`grid grid-cols-1 lg:grid-cols-12 gap-4 mx-1 h-full ${viewMode === 'tabs' ? 'mb-6' : 'mb-6'}`}>
                            {/* Left Col: Settings (6 cols wide) */}
                            <div className={`lg:col-span-6 card p-4 bg-white border-t-4 border-blue-500 flex flex-col h-full`}>
                                {/* 3-Row Header Layout - Consistent 3-Part Alignment & Compact */}
                                <div className="flex flex-col gap-1.5 mb-3">
                                    {/* Row 1: Date Selection */}
                                    <div className="bg-blue-50/50 p-2 rounded-lg border border-blue-100 flex flex-wrap items-center gap-2 shadow-sm">
                                        <div className="text-blue-900 font-bold text-[0.6875rem] flex items-center gap-1">ğŸ“… {t.lbl_date}</div>
                                        <input 
                                            type="date" 
                                            value={currentDateInput} 
                                            onChange={(e) => handleDateChange(e.target.value)} 
                                            min="2026-01-21" 
                                            max="2026-02-24" 
                                            className={`border-blue-200 rounded px-1 text-[0.75rem] h-7 w-[9rem] shadow-inner ${dateError ? 'border-red-400 bg-red-50' : ''}`}
                                            onWheel={(e) => e.target.blur()} 
                                        />
                                        {dateError && <span className="text-[0.625rem] text-red-600">{dateError}</span>}
                                        <div className="ml-auto">
                                            <span className="text-[0.75rem] sm:text-[0.875rem] text-blue-700 font-bold whitespace-nowrap bg-white px-2 py-0.5 rounded shadow-sm border border-blue-100 block text-center min-w-[5.625rem]">
                                                {t.lbl_remaining.replace('{d}', calculation.effDays).replace('{w}', calculation.effWeeks)}
                                            </span>
                                        </div>
                                    </div>

                                    {/* Row 2: Legend & Art Event (Merged) */}
                                    <div className="bg-gradient-to-br from-purple-50/50 to-orange-50/50 p-2 rounded-lg border border-purple-100 shadow-sm">
                                        <div className="flex justify-between items-center gap-2">
                                            {/* å·¦å´ï¼šå‚³é Œå’Œå¦™æ‰‹ */}
                                            <div className="flex-grow flex items-center gap-3 flex-wrap">
                                                {/* å‚³é Œéƒ¨åˆ† */}
                                                <div className="flex items-center gap-1.5 flex-wrap">
                                                    <span className="text-purple-900 font-bold text-[0.6875rem]">ğŸ“œ {lang === 'zh' ? 'å‚³é Œ' : 'Legend'}</span>
                                                    <span className="text-purple-800 text-[0.625rem] font-semibold">â­â­</span>
                                                    <div className="flex items-center gap-0.5">
                                                        <input type="checkbox" id="legCaptain2" checked={legendOptions.includeCaptain2Star} onChange={() => setLegendOptions(prev => ({ ...prev, includeCaptain2Star: !prev.includeCaptain2Star }))} className="w-3.5 h-3.5 cursor-pointer" />
                                                        <label htmlFor="legCaptain2" className="text-gray-700 text-[0.625rem] cursor-pointer">{lang === 'zh' ? 'éšŠé•·' : 'Cpt'}</label>
                                                    </div>
                                                    <div className="flex items-center gap-0.5">
                                                        <input type="checkbox" id="legMember2" checked={legendOptions.includeMember2Star} onChange={() => setLegendOptions(prev => ({ ...prev, includeMember2Star: !prev.includeMember2Star }))} className="w-3.5 h-3.5 cursor-pointer" />
                                                        <label htmlFor="legMember2" className="text-gray-700 text-[0.625rem] cursor-pointer">{lang === 'zh' ? 'éšŠå“¡' : 'Mem'}</label>
                                                    </div>
                                                    <span className="text-purple-800 text-[0.625rem] font-semibold">â­</span>
                                                    <div className="flex items-center gap-0.5">
                                                        <input type="checkbox" id="legCaptain1" checked={legendOptions.includeCaptain1Star} onChange={() => setLegendOptions(prev => ({ ...prev, includeCaptain1Star: !prev.includeCaptain1Star }))} className="w-3.5 h-3.5 cursor-pointer" />
                                                        <label htmlFor="legCaptain1" className="text-gray-700 text-[0.625rem] cursor-pointer">{lang === 'zh' ? 'éšŠé•·' : 'Cpt'}</label>
                                                    </div>
                                                    <div className="flex items-center gap-0.5">
                                                        <input type="checkbox" id="legMember1" checked={legendOptions.includeMember1Star} onChange={() => setLegendOptions(prev => ({ ...prev, includeMember1Star: !prev.includeMember1Star }))} className="w-3.5 h-3.5 cursor-pointer" />
                                                        <label htmlFor="legMember1" className="text-gray-700 text-[0.625rem] cursor-pointer">{lang === 'zh' ? 'éšŠå“¡' : 'Mem'}</label>
                                                    </div>
                                                </div>
                                                
                                                {/* åˆ†éš”ç·š */}
                                                <div className="h-5 w-px bg-purple-300/50"></div>
                                                
                                                {/* å¦™æ‰‹éƒ¨åˆ† */}
                                                <div className="flex items-center gap-2">
                                                    <span className="text-orange-900 font-bold text-[0.6875rem]">âœ¨ {lang === 'zh' ? 'å¦™æ‰‹' : 'Art'}</span>
                                                    <select value={legendOptions.artEventAmount} onChange={(e) => setLegendOptions(prev => ({ ...prev, artEventAmount: parseInt(e.target.value) }))} className="border-orange-200 rounded px-1.5 text-[0.7rem] h-6 bg-white">
                                                        <option value="0">0</option><option value="5">5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            {/* å³å´ï¼šæ¨™ç±¤ */}
                                            <div className="flex-shrink-0">
                                                <span className="text-[0.5625rem] text-purple-600 italic whitespace-nowrap bg-white/60 px-2 py-0.5 rounded border border-purple-200/50">
                                                    {lang === 'zh' ? 'å¦‚å·²ç²å¾—è«‹å‹¿å‹¾é¸' : 'Opt-out if done'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Scrolls */}
                                <div className="bg-blue-50 p-2 rounded-lg border border-blue-200 mb-2">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-[0.75rem] font-bold text-gray-700">{t.lbl_scrolls}</label>
                                        <button onClick={clearScrolls} className="text-[0.625rem] bg-white border border-gray-300 px-1 rounded shadow-sm">{t.btn_clear}</button>
                                    </div>
                                    <div className="grid grid-cols-5 gap-1">
                                        <div className="input-group"><label className="color-wind">{t.attr_wind}</label><input type="number" min="0" value={inventory.attrWind} onChange={(e) => updateInv('attrWind', e.target.value)} className="border-wind focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="color-thunder">{t.attr_thunder}</label><input type="number" min="0" value={inventory.attrThunder} onChange={(e) => updateInv('attrThunder', e.target.value)} className="border-thunder focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="color-water">{t.attr_water}</label><input type="number" min="0" value={inventory.attrWater} onChange={(e) => updateInv('attrWater', e.target.value)} className="border-water focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="color-fire">{t.attr_fire}</label><input type="number" min="0" value={inventory.attrFire} onChange={(e) => updateInv('attrFire', e.target.value)} className="border-fire focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-gray-600">{t.attr_univ}</label><input type="number" min="0" value={inventory.univScrolls} onChange={(e) => updateInv('univScrolls', e.target.value)} onWheel={(e) => e.target.blur()} /></div>
                                    </div>
                                </div>

                                {/* Maps (Simplified: One row for Qualities) */}
                                <div className="bg-orange-50 p-2 rounded-lg border border-orange-200 mb-2">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-[0.75rem] font-bold text-gray-700">{t.lbl_maps}</label>
                                        <button onClick={clearMaps} className="text-[0.625rem] bg-white border border-gray-300 px-1 rounded shadow-sm">{t.btn_clear}</button>
                                    </div>

                                    <div className="grid grid-cols-5 gap-1">
                                        <div className="input-group">
                                            <label className="text-red-600">{t.qual_god}</label>
                                            <input type="number" min="0" value={inventory.godMaps} onChange={(e) => updateInv('godMaps', e.target.value)} className="bg-red-50" onWheel={(e) => e.target.blur()} />
                                        </div>
                                        <div className="input-group">
                                            <label className="text-purple-600">{t.qual_peerless}</label>
                                            <input type="number" min="0" value={inventory.peerlessMaps} onChange={(e) => updateInv('peerlessMaps', e.target.value)} className="bg-purple-50" onWheel={(e) => e.target.blur()} />
                                        </div>
                                        <div className="input-group">
                                            <label className="text-indigo-600">{t.qual_rare}</label>
                                            <input type="number" min="0" value={inventory.rareMaps} onChange={(e) => updateInv('rareMaps', e.target.value)} className="bg-indigo-50" onWheel={(e) => e.target.blur()} />
                                        </div>
                                        <div className="input-group">
                                            <label className="text-green-600">{t.qual_common}</label>
                                            <input type="number" min="0" value={inventory.commonMaps} onChange={(e) => updateInv('commonMaps', e.target.value)} className="bg-green-50" onWheel={(e) => e.target.blur()} />
                                        </div>
                                        <div className="input-group">
                                            <label className="text-gray-400">{/* ç©ºç™½ä½”ä½ */}</label>
                                            <input type="text" disabled className="bg-gray-100 opacity-0 cursor-not-allowed" />
                                        </div>
                                    </div>
                                </div>

                                {/* Frags */}
                                <div className="bg-indigo-50 p-2 rounded-lg border border-indigo-200">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-[0.75rem] font-bold text-gray-700">{t.lbl_frags}</label>
                                        <button onClick={clearFrags} className="text-[0.625rem] bg-white border border-gray-300 px-1 rounded shadow-sm">{t.btn_clear}</button>
                                    </div>
                                    <div className="grid grid-cols-5 gap-1">
                                        <div className="input-group"><label className="text-god">{t.qual_god}</label><input type="number" min="0" value={inventory.godFrags} onChange={(e) => updateInv('godFrags', e.target.value)} className="bg-red-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-peerless">{t.qual_peerless}</label><input type="number" min="0" value={inventory.peerlessFrags} onChange={(e) => updateInv('peerlessFrags', e.target.value)} className="bg-purple-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-rare">{t.qual_rare}</label><input type="number" min="0" value={inventory.rareFrags} onChange={(e) => updateInv('rareFrags', e.target.value)} className="bg-indigo-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-common">{t.qual_common}</label><input type="number" min="0" value={inventory.commonFrags} onChange={(e) => updateInv('commonFrags', e.target.value)} className="bg-green-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-random">{t.qual_random}</label><input type="number" min="0" value={inventory.randomFrags} onChange={(e) => updateInv('randomFrags', e.target.value)} className="bg-yellow-50" onWheel={(e) => e.target.blur()} /></div>
                                    </div>
                                </div>

                                {/* ç¢ç‰‡åˆæˆé€²åº¦ç›¤é» - ç·Šæ¹Šæ©«å‘ä½ˆå±€ï¼ˆå¼·åˆ¶å–®è¡Œï¼‰ */}
                                <div className="card p-2.5 border-t-2 border-indigo-500 bg-white shadow-sm mt-2">
                                    <h3 className="font-bold text-gray-700 mb-1.5 text-xs border-b pb-1">{t.prog_title}</h3>
                                    <div className="grid grid-cols-5 gap-1 text-[0.625rem]">
                                        <div className="flex flex-row items-center justify-center flex-wrap gap-x-1 gap-y-0.5 px-1.5 py-1.5 bg-red-50 rounded border border-red-100">
                                            <span className="text-red-900 font-bold text-[0.6rem] whitespace-nowrap">{t.qual_god}</span>
                                            <span className="text-red-600 text-[0.55rem]">({calculation.totalGodPool})</span>
                                            <span className="text-red-600 text-[0.55rem] whitespace-nowrap">{t.prog_syn} {calculation.godStatus.maps}/{t.prog_need} {calculation.godStatus.needed}</span>
                                        </div>
                                        <div className="flex flex-row items-center justify-center flex-wrap gap-x-1 gap-y-0.5 px-1.5 py-1.5 bg-purple-50 rounded border border-purple-100">
                                            <span className="text-purple-900 font-bold text-[0.6rem] whitespace-nowrap">{t.qual_peerless}</span>
                                            <span className="text-purple-600 text-[0.55rem]">({calculation.totalPeerlessPool})</span>
                                            <span className="text-purple-600 text-[0.55rem] whitespace-nowrap">{t.prog_syn} {calculation.peerlessStatus.maps}/{t.prog_need} {calculation.peerlessStatus.needed}</span>
                                        </div>
                                        <div className="flex flex-row items-center justify-center flex-wrap gap-x-1 gap-y-0.5 px-1.5 py-1.5 bg-indigo-50 rounded border border-indigo-100">
                                            <span className="text-indigo-900 font-bold text-[0.6rem] whitespace-nowrap">{t.qual_rare}</span>
                                            <span className="text-indigo-600 text-[0.55rem]">({calculation.totalRarePool})</span>
                                            <span className="text-indigo-600 text-[0.55rem] whitespace-nowrap">{t.prog_syn} {calculation.rareStatus.maps}/{t.prog_need} {calculation.rareStatus.needed}</span>
                                        </div>
                                        <div className="flex flex-row items-center justify-center flex-wrap gap-x-1 gap-y-0.5 px-1.5 py-1.5 bg-green-50 rounded border border-green-100">
                                            <span className="text-green-900 font-bold text-[0.6rem] whitespace-nowrap">{t.qual_common}</span>
                                            <span className="text-green-600 text-[0.55rem]">({calculation.totalCommonPoolFinal})</span>
                                            <span className="text-green-600 text-[0.55rem] whitespace-nowrap">{t.prog_syn} {calculation.commonStatus.maps}/{t.prog_need} {calculation.commonStatus.needed}</span>
                                        </div>
                                        <div className="flex flex-row items-center justify-center flex-wrap gap-x-1 gap-y-0.5 px-1.5 py-1.5 bg-yellow-50 rounded border border-yellow-100">
                                            <span className="text-yellow-900 font-bold text-[0.6rem] whitespace-nowrap">{t.qual_random}</span>
                                            <span className="text-yellow-600 text-[0.55rem]">({calculation.totalRandomPool})</span>
                                            <span className="text-yellow-600 text-[0.55rem] whitespace-nowrap">{t.prog_syn} {calculation.randomStatus.maps}/{t.prog_need} {calculation.randomStatus.needed}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Right Col: Calculations (6 cols wide) */}
                            <div className="lg:col-span-6 flex flex-col gap-4 overflow-hidden">
                                {/* Merged Row: Source Details & Grand Total */}
                                <div className="card p-4 border-t-2 border-indigo-600 bg-white shadow-sm">
                                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
                                        {/* Left part: Source Details */}
                                        <div className="md:col-span-7">
                                            <div className="section-title text-indigo-700 text-[0.875rem] font-bold mb-2">
                                                {t.sec_details_title}
                                            </div>
                                            <div className="bg-gray-50 p-2 rounded-lg border border-gray-100 space-y-1.5 text-[0.75rem]">
                                                <div className="grid grid-cols-[1fr,60px,60px] gap-2 items-center border-b pb-1 font-bold uppercase text-[0.625rem]">
                                                    <span className="text-gray-700">{t.th_source}</span>
                                                    <span className="text-right text-blue-600">{t.th_attr}</span>
                                                    <span className="text-right text-green-600">{t.th_univ}</span>
                                                </div>
                                                <div className="grid grid-cols-[1fr,60px,60px] gap-2 items-center py-1 border-b border-gray-100 bg-blue-50/30 px-1 rounded">
                                                    <div className="text-gray-600 font-bold">{t.lbl_member_frag}</div>
                                                    <div className="text-right text-blue-600 font-bold">{(calculation.memberIncomeAttr || 0).toLocaleString()}</div>
                                                    <div className="text-right text-green-600 font-bold">{(calculation.memberIncomeUniv || 0).toLocaleString()}</div>
                                                </div>
                                                <div className="grid grid-cols-[1fr,60px,60px] gap-2 items-center py-1 border-b border-gray-100 bg-orange-50/30 px-1 rounded">
                                                    <div className="text-gray-600 font-bold">{t.lbl_leader_frag}</div>
                                                    <div className="text-right text-blue-600">{(calculation.leaderIncomeAttr || 0).toLocaleString()}</div>
                                                    <div className="text-right text-green-600">{(calculation.leaderIncomeUniv || 0).toLocaleString()}</div>
                                                </div>
                                                <div className="grid grid-cols-[1fr,60px,60px] gap-2 items-center py-1 border-b border-gray-100 bg-indigo-50/30 px-1 rounded">
                                                    <div className="text-gray-600 font-bold">{t.lbl_univ_frag}</div>
                                                    <div className="text-right text-blue-600">-</div>
                                                    <div className="text-right text-green-600">{(calculation.univBase || 0).toLocaleString()}</div>
                                                </div>
                                                <div className="grid grid-cols-[1fr,60px,60px] gap-2 items-center py-1 bg-indigo-50/30 px-1 rounded">
                                                    <div className="text-gray-600 font-bold">{t.row_conv} + {t.row_synth}</div>
                                                    <div className="text-right text-blue-600">{((calculation.convertedAttr || 0) + (calculation.fragSynthAttr || 0)).toLocaleString()}</div>
                                                    <div className="text-right text-green-600">{((calculation.convertedUniv || 0) + (calculation.fragSynthUniv || 0)).toLocaleString()}</div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Divider (visible on medium screens+) */}
                                        <div className="md:col-span-1 block md:hidden w-full h-px bg-gray-100 my-2"></div>
                                        {/* Right part: Grand Total */}
                                        <div className="md:col-span-5 flex flex-col justify-center border-l md:border-l-0 md:pl-0 pl-4 border-indigo-50">
                                            <div className="section-title text-indigo-700 text-[1rem] font-bold mb-3 border-none p-0 drop-shadow-sm">{t.total_est}</div>
                                            <div className="flex flex-col gap-4">
                                                <div className="flex items-center gap-3 bg-blue-50/50 p-2 rounded-lg">
                                                    <div className="text-lg font-black text-blue-800 whitespace-nowrap">{lang === 'zh' ? 'å±¬æ€§' : 'Attr'}</div>
                                                    <div className="text-4xl font-black text-blue-600 tracking-tighter">{(calculation.grandTotalAttr || 0).toLocaleString()}</div>
                                                </div>
                                                <div className="flex items-center gap-3 bg-green-50/50 p-2 rounded-lg">
                                                    <div className="text-lg font-black text-green-800 whitespace-nowrap">{lang === 'zh' ? 'é€šç”¨' : 'Univ'}</div>
                                                    <div className="text-4xl font-black text-green-600 tracking-tighter">{(calculation.grandTotalUniv || 0).toLocaleString()}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* æœªä¾†é è¨ˆç²å–æ˜ç´° - ç§»åˆ°ç¬¬äºŒå€‹ä½ç½® */}
                                <div className="card p-4 border-t-2 border-green-500 bg-white shadow-sm">
                                    <div className="section-title text-green-700 text-[0.875rem] font-bold mb-2">{t.sec_future_breakdown}</div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-[0.75rem]">
                                            <thead>
                                                <tr className="bg-green-50/50 text-green-800">
                                                    <th className="p-1.5 text-left rounded-l-md">{t.th_source}</th>
                                                    <th className="p-1.5 text-center">{t.th_count}</th>
                                                    <th className="p-1.5 text-right">{t.th_attr}</th>
                                                    <th className="p-1.5 text-right">{t.th_univ}</th>
                                                    <th className="p-1.5 text-right rounded-r-md">{t.th_frag}</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                <tr>
                                                    <td className="p-1.5 font-bold text-blue-700">{t.row_daily}</td>
                                                    <td className="p-1.5 text-center font-mono">{calculation.effDays} {lang === 'zh' ? 'æ¬¡' : 'runs'}</td>
                                                    <td className="p-1.5 text-right font-bold color-wind">+{calculation.effDays * DAILY_MEMBER_REWARD.attr}</td>
                                                    <td className="p-1.5 text-right font-bold color-univ">+{calculation.effDays * DAILY_MEMBER_REWARD.univ}</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                </tr>
                                                <tr>
                                                    <td className="p-1.5 font-bold text-red-700">{t.row_weekly_divine}</td>
                                                    <td className="p-1.5 text-center font-mono">{calculation.effWeeks} {lang === 'zh' ? 'é€±' : 'wks'}</td>
                                                    <td className="p-1.5 text-right font-bold color-wind">+{calculation.effWeeks * WEEKLY_MEMBER_REWARD.attr}</td>
                                                    <td className="p-1.5 text-right font-bold color-univ">+{calculation.effWeeks * WEEKLY_MEMBER_REWARD.univ}</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                </tr>
                                                <tr>
                                                    <td className="p-1.5 font-bold text-teal-600">{t.lbl_leader_frag}</td>
                                                    <td className="p-1.5 text-center font-mono">-</td>
                                                    <td className="p-1.5 text-right font-bold color-wind">+{calculation.leaderIncomeAttr}</td>
                                                    <td className="p-1.5 text-right font-bold color-univ">+{calculation.leaderIncomeUniv}</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                </tr>
                                                <tr>
                                                    <td className="p-1.5 font-bold text-orange-600">{t.row_daily_frag}</td>
                                                    <td className="p-1.5 text-center font-mono">{calculation.effDays} {lang === 'zh' ? 'å¤©' : 'days'}</td>
                                                    <td className="p-1.5 text-right text-gray-400 font-bold text-fragment-custom">+{calculation.effDays * 1} ({t.qual_peerless_short})</td>
                                                    <td className="p-1.5 text-right text-gray-400 font-bold text-fragment-custom">+{calculation.effDays * 2} ({t.qual_rare_short})</td>
                                                    <td className="p-1.5 text-right font-bold text-fragment-custom">+{calculation.effDays * 3} ({t.qual_common_short})</td>
                                                </tr>
                                                <tr>
                                                    <td className="p-1.5 font-bold text-purple-700">{lang === 'zh' ? "æ¯æ—¥éš¨æ©Ÿç¢ç‰‡ (19ç‰‡)" : "Daily Random (19)"}</td>
                                                    <td className="p-1.5 text-center font-mono">{calculation.effDays} {lang === 'zh' ? 'å¤©' : 'days'}</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                    <td className="p-1.5 text-right font-bold text-fragment-custom">+{calculation.effDays * FRAG_SOURCES.dailyRandom}</td>
                                                </tr>
                                                <tr>
                                                    <td className="p-1.5 font-bold text-purple-700">{t.row_weekly_frag}</td>
                                                    <td className="p-1.5 text-center font-mono">{calculation.effWeeks} {lang === 'zh' ? 'é€±' : 'wks'}</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                    <td className="p-1.5 text-right font-bold text-fragment-custom">+{calculation.effWeeks * FRAG_SOURCES.weeklyGod}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 3: å•†åº— */}
                    {(viewMode === 'single' || activeTab === 'shop') && (
                        <div className={`card p-4 bg-white border-t-4 border-pink-500 mx-1 ${viewMode === 'tabs' ? 'mb-6' : 'mb-6'}`}>

                            {/* Queue + Summary Layout */}
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-4 items-stretch">
                                {/* Left: Dynamic Priority Queue */}
                                <div className="lg:col-span-9 border-2 border-indigo-100 rounded-xl overflow-hidden shadow-sm flex flex-col h-full">
                                    <div className="bg-gradient-to-r from-indigo-50 to-white p-2 border-b border-indigo-100 flex justify-between items-center h-10 px-3">
                                        <div className="text-[0.75rem] text-indigo-500 font-bold">{t.prio_subtitle}</div>
                                        <div className="text-right text-[0.75rem]">
                                            <span className="block text-green-600 font-bold">{t.prio_rem_univ} {priorityQueueAnalysis.length > 0 ? (priorityQueueAnalysis[priorityQueueAnalysis.length - 1].remainingUnivPool || 0).toLocaleString() : (calculation.grandTotalUniv || 0).toLocaleString()}</span>
                                        </div>
                                    </div>

                                    <div className="flex h-full min-h-[18.75rem] max-h-[18.75rem]">
                                        {/* Control Panel (Fixed Left Sidebar) */}
                                        <div className="w-14 bg-gray-50 border-r border-indigo-100 flex flex-col items-center justify-center gap-3 p-1 flex-shrink-0">
                                            <button className="ctrl-btn up" onClick={handleMoveUp} disabled={selectedQueueIndex === null || selectedQueueIndex === 0}>â–²</button>
                                            <button className="ctrl-btn down" onClick={handleMoveDown} disabled={selectedQueueIndex === null || selectedQueueIndex === cartQueue.length - 1}>â–¼</button>
                                            <div className="h-4"></div>
                                            <button className="ctrl-btn del" onClick={handleDeleteItem} title={lang === 'zh' ? 'åˆªé™¤é¸ä¸­é …' : 'Delete selected'} disabled={selectedQueueIndex === null}>ğŸ—‘ï¸</button>
                                            <button className="ctrl-btn del !text-red-400 !bg-red-50 !border-red-100 mt-2" onClick={clearAllQueue} title={t.btn_clear_all}>ALL</button>
                                        </div>

                                        {/* List Area */}
                                        <div className="flex-grow overflow-y-auto p-0">
                                            {priorityQueueAnalysis.length === 0 ? (
                                                <div className="text-center py-8 text-gray-400 text-sm m-4 border-2 border-dashed border-gray-100 rounded-lg">
                                                    {t.prio_empty}
                                                </div>
                                            ) : (
                                                <table className="w-full text-sm border-collapse">
                                                    <thead>
                                                        <tr className="text-gray-600 text-[0.6875rem] border-b-2 border-indigo-200 bg-gradient-to-r from-indigo-50 to-blue-50 sticky top-0 z-10 shadow-sm font-bold">
                                                            <th className="py-2.5 pl-3 text-left w-32"># {lang === 'zh' ? 'å“é …' : 'Item'}</th>
                                                            <th className="py-2.5 text-center">{lang === 'zh' ? 'é€²åº¦' : 'Progress'}</th>
                                                            <th className="py-2.5 text-left">{lang === 'zh' ? 'è³‡æºä¾†æºæ˜ç´°' : 'Resource Details'}</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {priorityQueueAnalysis.map((item, index) => {
                                                            const resourceDetails = [];
                                                            
                                                            // æ”¶é›†æ‰€æœ‰ä½¿ç”¨çš„èµ„æº
                                                            if (item.nativeUsed > 0) {
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'ç¾æœ‰åŒå±¬æ€§' : 'Current Stock',
                                                                    value: item.nativeUsed,
                                                                    color: 'text-blue-700',
                                                                    bgColor: 'bg-blue-50',
                                                                    icon: 'ğŸ’'
                                                                });
                                                            }
                                                            if (item.futureNativeUsed > 0) {
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'æœªä¾†åŒå±¬æ€§' : 'Future Native',
                                                                    value: item.futureNativeUsed,
                                                                    color: 'text-green-700',
                                                                    bgColor: 'bg-green-50',
                                                                    icon: 'ğŸŒŸ'
                                                                });
                                                            }
                                                            if (item.futureUnivUsed > 0) {
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'æœªä¾†é€šç”¨' : 'Future Univ',
                                                                    value: item.futureUnivUsed,
                                                                    color: 'text-teal-700',
                                                                    bgColor: 'bg-teal-50',
                                                                    icon: 'âœ¨'
                                                                });
                                                            }
                                                            if (item.nonTargetUniv > 0) {
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'ç¾æœ‰é€šç”¨(1:1)' : 'Cur Univ(1:1)',
                                                                    value: item.nonTargetUniv,
                                                                    color: 'text-indigo-700',
                                                                    bgColor: 'bg-indigo-50',
                                                                    icon: 'ğŸ”·'
                                                                });
                                                            }
                                                            if (item.nonTargetOtherRaw > 0) {
                                                                const gain = Math.floor(item.nonTargetOtherRaw / 2);
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'å…¶ä»–å±¬æ€§(2:1)' : 'Other Attr(2:1)',
                                                                    value: `${item.nonTargetOtherRaw}â†’${gain}`,
                                                                    color: 'text-purple-700',
                                                                    bgColor: 'bg-purple-50',
                                                                    icon: 'ğŸ”„'
                                                                });
                                                            }
                                                            if (item.futureOtherRaw > 0) {
                                                                const gain = Math.floor(item.futureOtherRaw / 2);
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'æœªä¾†å…¶ä»–å±¬æ€§(2:1)' : 'Future Other(2:1)',
                                                                    value: `${item.futureOtherRaw}â†’${gain}`,
                                                                    color: 'text-orange-700',
                                                                    bgColor: 'bg-orange-50',
                                                                    icon: 'âš¡'
                                                                });
                                                            }
                                                            if (item.conversionStolenRaw > 0) {
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'åˆ†è§£å¾Œé¢å•†å“' : 'From Later Items',
                                                                    value: item.conversionStolenRaw,
                                                                    color: 'text-pink-700',
                                                                    bgColor: 'bg-pink-50',
                                                                    icon: 'â¬‡ï¸'
                                                                });
                                                            }
                                                            
                                                            return (
                                                                <tr
                                                                    key={item.uid}
                                                                    draggable={!isMobile}
                                                                    onDragStart={!isMobile ? (e) => handleDragStart(e, index) : undefined}
                                                                    onDragOver={!isMobile ? (e) => handleDragOver(e, index) : undefined}
                                                                    onDragEnd={!isMobile ? handleDragEnd : undefined}
                                                                    onClick={() => handleQueueItemClick(index)}
                                                                    className={`border-b border-gray-100 queue-item transition-all hover:bg-blue-50/30 ${
                                                                        !isMobile ? 'cursor-move' : 'cursor-pointer'
                                                                    } ${
                                                                        selectedQueueIndex === index ? 'selected bg-indigo-100/50 border-l-4 border-l-indigo-500' : ''
                                                                    } ${draggedIndex === index && !isMobile ? 'opacity-50 scale-105' : ''}`}
                                                                    style={{ cursor: isMobile ? 'pointer' : 'move' }}
                                                                >
                                                                    <td className="py-3 pl-3">
                                                                        <div className="flex items-center gap-2 leading-tight">
                                                                            <span className="text-gray-500 font-mono text-xs font-bold bg-gray-100 px-1.5 py-0.5 rounded">{index + 1}</span>
                                                                            <div className="flex flex-col">
                                                                                <div className={`font-bold text-xs truncate max-w-[120px] ${getAttrColorText(item.category)}`} title={item.name}>
                                                                                    ({getAttrLabel(item.category)}) {item.name}
                                                                                </div>
                                                                                <div className="flex items-center gap-2 mt-0.5">
                                                                                    {item.status === 'stock' && <span className="w-1.5 h-1.5 rounded-full bg-blue-500" title={t.prio_status_stock}></span>}
                                                                                    {item.status === 'univ' && <span className="w-1.5 h-1.5 rounded-full bg-green-500" title={t.prio_status_univ}></span>}
                                                                                    {item.status === 'convert' && <span className="w-1.5 h-1.5 rounded-full bg-indigo-500" title={t.prio_status_convert}></span>}
                                                                                    {item.status === 'gap' && <span className="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse" title={t.prio_status_gap}></span>}
                                                                                    <span className="text-[0.625rem] text-gray-500">{t.shop_cost}: {item.cost}</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td className="py-3 text-center">
                                                                        <div className="flex flex-col items-center gap-0.5">
                                                                            <span className="font-mono font-bold text-sm text-gray-700">{item.progress}</span>
                                                                            {item.gap > 0 && (
                                                                                <span className="text-[0.625rem] text-red-500 font-medium">{t.shop_gap} {item.gap}</span>
                                                                            )}
                                                                        </div>
                                                                    </td>
                                                                    <td className="py-3 pr-3">
                                                                        {resourceDetails.length > 0 ? (
                                                                            <div className="flex flex-wrap gap-1">
                                                                                {resourceDetails.map((detail, idx) => (
                                                                                    <div 
                                                                                        key={idx}
                                                                                        className={`${detail.bgColor} ${detail.color} px-1.5 py-0.5 rounded text-[0.65rem] font-semibold border border-current/20 flex items-center gap-0.5`}
                                                                                        title={detail.label}
                                                                                    >
                                                                                        <span>{detail.icon}</span>
                                                                                        <span className="whitespace-nowrap">{detail.label}: {detail.value}</span>
                                                                                    </div>
                                                                                ))}
                                                                                {item.stolenFromMe > 0 && (
                                                                                    <div className="bg-red-50 text-red-700 px-1.5 py-0.5 rounded text-[0.65rem] font-semibold border border-red-200 flex items-center gap-0.5">
                                                                                        <span>â¬†ï¸</span>
                                                                                        <span className="whitespace-nowrap">{lang === 'zh' ? 'è¢«å¥ªå–' : 'Stolen'}: {item.stolenFromMe}</span>
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        ) : (
                                                                            <span className="text-gray-400 text-sm italic">{lang === 'zh' ? 'è³‡æºä¸è¶³' : 'Insufficient'}</span>
                                                                        )}
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Right: Summary Cards Stack */}
                                <div className="lg:col-span-3 flex flex-col gap-4 h-full">
                                    {/* é ä¼°æ®˜å·ç¸½é‡ */}
                                    <div className="bg-white p-3 rounded-xl shadow-sm border-2 border-indigo-50 flex flex-col overflow-hidden">
                                        <div className="text-indigo-900 font-bold text-[0.875rem] mb-3 flex items-center gap-1 border-b border-indigo-50 pb-2">
                                            <span>ğŸ“Š</span> {lang === 'zh' ? 'é ä¼°æ®˜å·ç¸½é‡' : 'Est. Total Scrolls'}
                                        </div>

                                        <div className="space-y-4">
                                            <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 flex items-center gap-3">
                                                <div className="text-base text-blue-600 font-bold whitespace-nowrap">{lang === 'zh' ? 'å±¬æ€§å·' : 'Attr'}</div>
                                                <div className="text-3xl font-black text-blue-700">{(calculation.grandTotalAttr || 0).toLocaleString()}</div>
                                            </div>

                                            <div className="bg-green-50 p-3 rounded-lg border border-green-100 flex items-center gap-3">
                                                <div className="text-base text-green-600 font-bold whitespace-nowrap">{lang === 'zh' ? 'é€šç”¨å·' : 'Univ'}</div>
                                                <div className="text-3xl font-black text-green-700">{(calculation.grandTotalUniv || 0).toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* æç¤ºå¡ç‰‡ */}
                                    <div className="bg-orange-50 p-2.5 rounded-lg border border-orange-200 shadow-sm">
                                        <div className="text-[0.75rem] text-orange-800 font-bold flex flex-col gap-0.5">
                                            {lang === 'zh' ? (
                                                <React.Fragment>
                                                    <div className="flex items-center gap-1">ğŸ’¡ æç¤ºï¼šä½¿ç”¨é€šç”¨å·å¯ä»¥ 1:1 æ›¿ä»£å±¬æ€§å·ã€‚</div>
                                                    <div>å…¶ä»–å±¬æ€§é–“å¯é€é 2:1 è½‰åŒ–å½Œè£œç¼ºå£ã€‚</div>
                                                </React.Fragment>
                                            ) : (
                                                <React.Fragment>
                                                    <div className="flex items-center gap-1">ğŸ’¡ Protip: Universal scrolls substitute 1:1.</div>
                                                    <div>Attributes convert 2:1 for gaps.</div>
                                                </React.Fragment>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>



                            {/* Bottom: Shop Items */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2">
                                {['wind', 'thunder', 'water', 'fire'].map(element => {
                                    const labels = { fire: t.attr_fire, water: t.attr_water, wind: t.attr_wind, thunder: t.attr_thunder };
                                    const textColor = { fire: 'color-fire', water: 'color-water', wind: 'color-wind', thunder: 'color-thunder' };
                                    const borderColor = { fire: 'border-fire', water: 'border-water', wind: 'border-wind', thunder: 'border-thunder' };
                                    const bgColorClass = { fire: 'bg-fire-light', water: 'bg-water-light', wind: 'bg-wind-light', thunder: 'bg-thunder-light' };

                                    return (
                                        <div key={element} className={`border rounded p-2 shadow-sm ${bgColorClass[element]}`}>
                                            <div className={`font-bold mb-1 text-center border-b pb-1 ${textColor[element]} ${borderColor[element]} flex justify-between items-center text-[0.75rem]`}>
                                                <span>{labels[element]}</span>
                                                <button onClick={() => clearShopCategory(element)} className="text-[0.625rem] bg-white border border-gray-300 px-1 rounded shadow-sm" title={t.btn_clear}>{t.btn_clear}</button>
                                            </div>
                                            <div className="space-y-1">
                                                {ATTR_SHOP_ITEMS.map(item => (
                                                    <ShopItem key={item.id} item={item} category={element} color={textColor[element]} />
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                                <div className="border rounded p-2 shadow-sm bg-univ-light">
                                    <div className="font-bold mb-1 text-center border-b pb-1 text-green-600 border-green-200 flex justify-between items-center text-[0.75rem]">
                                        <span>{t.attr_univ}</span>
                                        <button onClick={() => clearShopCategory('univ')} className="text-[0.625rem] bg-white border border-gray-300 px-1 rounded shadow-sm" title={t.btn_clear}>{t.btn_clear}</button>
                                    </div>
                                    <div className="space-y-1">
                                        {UNIV_SHOP_ITEMS.map(item => (
                                            <ShopItem key={item.id} item={item} category="univ" color="text-green-600" />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )
                    }

                    {/* Tab 4: æ¯æ—¥ç²å–æ˜ç´° */}
                    {
                        (viewMode === 'single' || activeTab === 'daily') && (
                            <div className={`card p-4 border-t-4 border-teal-500 overflow-x-auto mx-1 ${viewMode === 'tabs' ? 'mb-6' : 'mb-6'}`}>
                                <table className="w-full min-w-[700px]">
                                    <thead>
                                        <tr>
                                            <th className="w-16 text-[0.75rem]">{t.th_day}</th>
                                            <th className="w-32 text-[0.75rem]">{t.th_date}</th>
                                            <th className="text-[0.75rem]">{t.th_gain}</th>
                                            <th className="text-[0.75rem]">{t.th_acc}</th>
                                            <th className="text-[0.75rem]">{t.th_frag}</th>
                                            <th className="text-[0.75rem]">{t.th_note}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {dailyTable.map((row) => (
                                            <tr key={row.day} className={row.date.startsWith(currentDateInput.slice(5)) ? "bg-blue-100 border-l-4 border-blue-500" : ""}>
                                                <td className="font-medium text-gray-600 text-[0.875rem]">{row.day}</td>
                                                <td className="text-[0.875rem]">{row.date}</td>
                                                <td className="text-[0.875rem] text-gray-600">{row.dayAttr} / {row.dayUniv} / <span className="text-yellow-600 font-bold">{row.dayRandom}</span></td>
                                                <td className="text-[0.875rem]"><span className="text-blue-600 font-bold">{row.accAttr}</span> / <span className="text-green-600 font-bold">{row.accUniv}</span></td>
                                                <td className="text-[0.875rem]"><span className="text-yellow-800 font-bold bg-yellow-100 px-2 py-1 rounded">{row.accRandom}</span></td>
                                                <td className="text-[0.75rem] text-gray-500">{row.notes.map((note, idx) => (<span key={idx} className={note.style}>{idx > 0 && ", "}{note.text}</span>))}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )
                    }

                    {
                        (viewMode === 'single' || activeTab === 'sources') && (
                            <div className={`card p-4 border-t-4 border-yellow-500 mx-1 ${viewMode === 'tabs' ? '' : ''}`}>
                                {/* ä¸‰åˆ—ä¸¦æ’ - éŸ¿æ‡‰å¼ï¼šæ‰‹æ©Ÿ1åˆ—ï¼Œå¹³æ¿2åˆ—ï¼Œæ¡Œé¢3åˆ— */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    {/* å¡ç‰‡1: å›ºå®šä»»å‹™ */}
                                    <div className="border rounded-lg p-3 bg-yellow-50 border-yellow-200">
                                        <h3 className="font-bold text-yellow-800 mb-2 border-b border-yellow-300 pb-1 text-base">{t.src_fixed_title}</h3>
                                        <ul className="space-y-1.5 text-sm">
                                            <li className="flex justify-between items-center"><span className="text-red-700 font-bold">{t.qual_god}</span><span className="bg-white px-2 py-0.5 rounded-full text-red-600 font-bold shadow-sm text-sm">4 {t.unit_frag}</span></li>
                                            <li className="flex justify-between items-center"><span className="text-purple-700 font-bold">{t.qual_peerless}</span><span className="bg-white px-2 py-0.5 rounded-full text-purple-600 font-bold shadow-sm text-sm">5 {t.unit_frag}</span></li>
                                            <li className="flex justify-between items-center"><span className="text-indigo-700 font-bold">{t.qual_rare}</span><span className="bg-white px-2 py-0.5 rounded-full text-indigo-600 font-bold shadow-sm text-sm">9 {t.unit_frag}</span></li>
                                            <li className="flex justify-between items-center"><span className="text-green-700 font-bold">{t.qual_common}</span><span className="bg-white px-2 py-0.5 rounded-full text-green-600 font-bold shadow-sm text-sm">8 {t.unit_frag}</span></li>
                                            <li className="flex justify-between items-center"><span className="text-yellow-700 font-bold">{t.qual_random}</span><span className="bg-white px-2 py-0.5 rounded-full text-yellow-600 font-bold shadow-sm text-sm">20 {t.unit_frag}</span></li>
                                            <li className="flex justify-between items-center border-t border-yellow-200 pt-1.5 mt-1.5">
                                                <span className="text-orange-700 font-bold">âœ¨ {lang === 'zh' ? 'å¦™æ‰‹ä¸¹é’' : 'Art Event'}</span>
                                                <span className="bg-white px-2 py-0.5 rounded-full text-orange-600 font-bold shadow-sm text-sm">{t.src_art_reward}</span>
                                            </li>
                                        </ul>
                                    </div>

                                    {/* å¡ç‰‡2: é€±æœŸä»»å‹™ */}
                                    <div className="border rounded-lg p-3 bg-blue-50 border-blue-200">
                                        <h3 className="font-bold text-blue-800 mb-2 border-b border-blue-300 pb-1 text-base">{t.src_weekly_title}</h3>
                                        <div className="space-y-2 text-sm">
                                            <div>
                                                <div className="text-xs font-bold text-gray-700 mb-1">{t.src_weekly_sub}</div>
                                                <div className="flex justify-between items-center bg-white p-2 rounded border border-blue-100">
                                                    <span className="text-red-600 font-bold">{t.qual_god}</span>
                                                    <span className="font-bold text-sm">3 {t.unit_frag}/{t.unit_week}</span>
                                                </div>
                                            </div>
                                            <div>
                                                <div className="text-xs font-bold text-gray-700 mb-1">{t.src_daily_sub}</div>
                                                <div className="flex justify-between items-center bg-white p-2 rounded border border-blue-100">
                                                    <span className="text-yellow-600 font-bold">{t.qual_random}</span>
                                                    <span className="font-bold text-sm">19 {t.unit_frag}/{t.unit_day}</span>
                                                </div>
                                                <div className="text-xs text-orange-600 font-bold mt-1 text-right italic">{t.src_daily_note}</div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* å¡ç‰‡3: çå‹µè¡¨æ ¼ï¼ˆç·Šæ¹Šç‰ˆï¼‰ */}
                                    <div className="border rounded-lg p-3 bg-indigo-50 border-indigo-200">
                                        <h3 className="font-bold text-indigo-800 mb-2 border-b border-indigo-300 pb-1 text-base">{t.src_rewards_title}</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-indigo-100 text-indigo-900">
                                                    <tr>
                                                        <th className="p-1 text-xs">{t.reward_header_qual}</th>
                                                        <th className="p-1 text-xs">{t.reward_header_role}</th>
                                                        <th className="p-1 text-right text-xs">{t.reward_header_attr}</th>
                                                        <th className="p-1 text-right text-xs">{t.reward_header_univ}</th>
                                                        <th className="p-1 text-right text-xs">{t.reward_header_refund}</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-indigo-100">
                                                    {/* God */}
                                                    <tr className="bg-blue-100/50"><td className="p-1 font-bold text-red-700">{t.qual_god}</td><td className="p-1 font-bold">{t.role_capt}</td><td className="p-1 text-right text-blue-600 font-bold">30</td><td className="p-1 text-right text-green-600 font-bold">40</td><td className="p-1 text-right">-</td></tr>
                                                    <tr className="bg-white"><td className="p-1"></td><td className="p-1 text-gray-500">{t.role_memb}</td><td className="p-1 text-right text-blue-500">15</td><td className="p-1 text-right text-green-500">20</td><td className="p-1 text-right">-</td></tr>
                                                    {/* Peerless */}
                                                    <tr className="bg-blue-100/50"><td className="p-1 font-bold text-purple-700">{t.qual_peerless}</td><td className="p-1 font-bold">{t.role_capt}</td><td className="p-1 text-right text-blue-600 font-bold">16</td><td className="p-1 text-right text-green-600 font-bold">20</td><td className="p-1 text-right font-bold text-purple-600">1</td></tr>
                                                    <tr className="bg-white"><td className="p-1"></td><td className="p-1 text-gray-500">{t.role_memb}</td><td className="p-1 text-right text-blue-500">8</td><td className="p-1 text-right text-green-500">10</td><td className="p-1 text-right">-</td></tr>
                                                    {/* Rare */}
                                                    <tr className="bg-blue-100/50"><td className="p-1 font-bold text-indigo-700">{t.qual_rare}</td><td className="p-1 font-bold">{t.role_capt}</td><td className="p-1 text-right text-blue-600 font-bold">8</td><td className="p-1 text-right text-green-600 font-bold">10</td><td className="p-1 text-right font-bold text-indigo-600">1</td></tr>
                                                    <tr className="bg-white"><td className="p-1"></td><td className="p-1 text-gray-500">{t.role_memb}</td><td className="p-1 text-right text-blue-500">4</td><td className="p-1 text-right text-green-500">5</td><td className="p-1 text-right">-</td></tr>
                                                    {/* Common */}
                                                    <tr className="bg-blue-100/50"><td className="p-1 font-bold text-green-700">{t.qual_common}</td><td className="p-1 font-bold">{t.role_capt}</td><td className="p-1 text-right text-blue-600 font-bold">4</td><td className="p-1 text-right text-green-600 font-bold">5</td><td className="p-1 text-right font-bold text-green-600">1</td></tr>
                                                    <tr className="bg-white"><td className="p-1"></td><td className="p-1 text-gray-500">{t.role_memb}</td><td className="p-1 text-right text-blue-500">2</td><td className="p-1 text-right text-green-500">3</td><td className="p-1 text-right">-</td></tr>
                                                    {/* Legend */}
                                                    <tr className="bg-blue-100/50"><td className="p-1 font-bold text-purple-900">{t.qual_legend}</td><td className="p-1 font-bold">{t.role_capt}</td><td className="p-1 text-right text-blue-600 font-bold">-</td><td className="p-1 text-right text-green-600 font-bold">150</td><td className="p-1 text-right">-</td></tr>
                                                    <tr className="bg-white"><td className="p-1"></td><td className="p-1 text-gray-500">{t.role_memb}</td><td className="p-1 text-right text-blue-500">-</td><td className="p-1 text-right text-green-500">75</td><td className="p-1 text-right">-</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                    {/* Floating Zoom Console - Fixed Units to Prevent Jumping */}
                    <div style={{
                        position: 'fixed',
                        bottom: '20px',
                        right: '20px',
                        zIndex: 9999,
                        display: 'flex',
                        alignItems: 'center',
                        backgroundColor: 'white',
                        padding: '4px 8px',
                        borderRadius: '999px',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                        border: '1px solid #e0e7ff',
                        gap: '6px',
                        height: '36px'
                    }}>
                        <button
                            onClick={() => setZoomLevel(prev => Math.max(50, prev - 10))}
                            style={{ width: '28px', height: '28px', border: 'none', background: '#f5f7ff', color: '#4f46e5', fontWeight: 'bold', fontSize: '16px', borderRadius: '50%', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                        >-</button>
                        <button
                            onClick={() => setZoomLevel(100)}
                            style={{ border: 'none', background: 'transparent', color: '#6366f1', fontSize: '12px', fontWeight: '900', cursor: 'pointer', padding: '0 4px', fontFormat: 'monospace' }}
                        >{zoomLevel}%</button>
                        <button
                            onClick={() => setZoomLevel(prev => Math.min(250, prev + 10))}
                            style={{ width: '28px', height: '28px', border: 'none', background: '#f5f7ff', color: '#4f46e5', fontWeight: 'bold', fontSize: '16px', borderRadius: '50%', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                        >+</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>