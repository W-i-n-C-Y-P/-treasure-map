<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ËóèÂØ∂ÂúñÊÆòÊç≤„ÄÅÁ¢éÁâáË®àÁÆóÊ©ü | Treasure Map Calculator</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* #region CSS Styles */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Ëº∏ÂÖ•Ê°ÜÊ®£Âºè */
        .input-group label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            margin-bottom: 0.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .input-group input[type="date"] {
            width: 100%;
            max-width: 8.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.3rem;
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
            transition: border-color 0.15s;
            background-color: rgba(255, 255, 255, 0.8);
        }

        .input-group input[type="number"] {
            width: 100%;
            max-width: 5.625rem;
            border: 1px solid #d1d5db;
            border-radius: 0.3rem;
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
            transition: border-color 0.15s;
            background-color: rgba(255, 255, 255, 0.8);
        }

        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #93c5fd;
            background-color: white;
        }


        th,
        td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.5rem;
            border-left: 4px solid #3b82f6;
            padding-left: 0.5rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-top: 0.1rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* ÂïÜÂ∫óÊ®£Âºè */
        .shop-counter {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.8);
            padding: 0.2rem 0.3rem;
            border-radius: 0.25rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.25rem;
        }

        .shop-counter button {
            width: 1.125rem;
            height: 1.125rem;
            border-radius: 3px;
            background: #e5e7eb;
            color: #374151;
            font-weight: bold;
            line-height: 1;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .shop-counter button:hover {
            background: #d1d5db;
        }

        .shop-counter button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .shop-item-cost-large {
            font-size: 0.8rem;
            font-weight: 700;
        }

        /* ÂàÜÈ†ÅÊåâÈàïÊ®£Âºè */
        .tabs-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 2px;
            -webkit-overflow-scrolling: touch;
        }

        .tabs-container::-webkit-scrollbar {
            height: 3px;
        }

        .tabs-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        /* Added flex-shrink-0 to prevent overlapping/squishing */
        .tab-btn {
            display: inline-block;
            padding: 0.6rem 1rem;
            text-align: center;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 90px;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background-color: #eff6ff;
        }

        .tab-btn:hover:not(.active) {
            color: #374151;
            background-color: #f9fafb;
        }

        /* ÂÖßÂÆπÂçÄÂ°äÊç≤Ëª∏ */
        .tab-content-scroll {
            height: calc(100vh - 140px);
            overflow-y: auto;
            padding-right: 4px;
        }

        .tab-content-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .tab-content-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .tab-content-scroll::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .tab-content-scroll::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Ëá™ÂÆöÁæ©Â±¨ÊÄßÈ°èËâ≤ class */
        .color-fire {
            color: #FF2D2D;
        }

        .color-water {
            color: #00AEAE;
        }

        .color-wind {
            color: #4F9D9D;
        }

        .color-thunder {
            color: #4A4AFF;
        }

        .color-univ {
            color: #16a34a;
        }

        .border-fire {
            border-color: #FF2D2D;
        }

        .border-water {
            border-color: #00AEAE;
        }

        .border-wind {
            border-color: #4F9D9D;
        }

        .border-thunder {
            border-color: #4A4AFF;
        }

        .border-univ {
            border-color: #16a34a;
        }

        .bg-fire-light {
            background-color: #fff0f0;
        }

        .bg-water-light {
            background-color: #e0fafa;
        }

        .bg-wind-light {
            background-color: #eef9f9;
        }

        .bg-thunder-light {
            background-color: #efefff;
        }

        .bg-univ-light {
            background-color: #f0fdf4;
        }

        .text-fragment-custom {
            color: #9999CC;
        }

        .text-god {
            color: #b91c1c;
        }

        .text-peerless {
            color: #7e22ce;
        }

        .text-rare {
            color: #4338ca;
        }

        .text-common {
            color: #15803d;
        }

        .text-random {
            color: #a16207;
        }

        /* Help Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 600px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        /* Selection Styles */
        .queue-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .queue-item:hover:not(.selected) {
            background-color: #f9fafb;
        }

        .queue-item.selected {
            background-color: #eff6ff;
            border-left-color: #3b82f6;
        }

        /* Control Buttons */
        .ctrl-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.1s;
            background-color: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .ctrl-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .ctrl-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .ctrl-btn.up {
            color: #2563eb;
            background-color: #eff6ff;
            border-color: #bfdbfe;
        }

        .ctrl-btn.down {
            color: #2563eb;
            background-color: #eff6ff;
            border-color: #bfdbfe;
        }

        .ctrl-btn.del {
            color: #dc2626;
            background-color: #fef2f2;
            border-color: #fecaca;
        }

        /* #endregion */
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Â§öË™ûË®ÄË®≠ÂÆö ---
        // #region Â§öË™ûË®ÄË®≠ÂÆö (I18N)
        const I18N = {
            zh: {
                title: "ËóèÂØ∂ÂúñÊ¥ªÂãïÊî∂ÁõäË®àÁÆóÊ©ü",
                period: "Ê¥ªÂãïÊúüÈñì: 2026/01/21 ~ 2026/02/25",
                tab_main: "üìä Â∫´Â≠òËàáÊî∂ÁõäÁ∏ΩË¶Ω",
                tab_shop: "üõí ÂïÜÂ∫óË¶èÂäÉ",
                tab_daily: "üìÖ ÊØèÊó•ÊòéÁ¥∞",
                tab_sources: "üìú ‰æÜÊ∫êË™™Êòé",
                btn_help: "‚ùì Ë™™Êòé",
                btn_tabs: "üìë È†ÅÁ±§Âºè",
                btn_single: "üìú ‰∏ÄÈ†ÅÂºè",
                btn_clear: "üóëÔ∏è Ê∏ÖÈô§",
                lbl_date: "Áï∂ÂâçÊó•Êúü",
                lbl_remaining: "Ââ© {d} Â§© / {w} ÈÄ±",
                lbl_legend: "ÂÇ≥È†åËóèÂØ∂Âúñ (ÂêÑÈôê1Ê¨°)",
                lbl_leg_captain: "ÈöäÈï∑(+150ÈÄö)",
                lbl_leg_member: "ÈöäÂì°(+75ÈÄö)",
                lbl_scrolls: "ÊåÅÊúâÊÆòÊç≤",
                lbl_maps: "ÊåÅÊúâÊàêÂìÅËóèÂØ∂Âúñ",
                lbl_frags: "ÊåÅÊúâÁ¢éÁâáÊï∏Èáè",
                attr_fire: "ÁÅ´", attr_water: "Ê∞¥", attr_wind: "È¢®", attr_thunder: "Èõ∑", attr_univ: "ÈÄöÁî®",
                qual_god: "Á•ûÂìÅ", qual_peerless: "ÁµïÂìÅ", qual_rare: "ÁèçÂìÅ", qual_common: "Âá°ÂìÅ", qual_random: "Èö®Ê©ü",
                qual_legend: "ÂÇ≥È†å",

                sec_settings: "Ë®≠ÂÆöËàáÂ∫´Â≠ò",
                sec_income_title: "Ê¥ªÂãïÁµêÊùüÁ∏ΩÊî∂ÁõäÈ†ê‰º∞",
                sec_details_title: "ÊÆòÊç≤‰æÜÊ∫êË©≥ÊÉÖ",
                row_base: "Â∫´Â≠ò+Âõ∫ÂÆö",
                row_maps: "Â∫´Â≠òÊàêÂìÅ",
                row_conv: "Èö®Ê©üËΩâÂåñ",
                row_synth: "Á¢éÁâáÂêàÊàê",
                total_est: "Á∏ΩË®àÈ†ê‰º∞",
                exchange_ref: "üîÑ Â±¨ÊÄß2ÊèõÈÄöÁî®1 ÈÄöÁî®1ÊèõÂ±¨ÊÄß1",
                exchange_all_attr: "ÂÖ®ËΩâÊèõÔºöÂ±¨ÊÄß", // Updated Text
                exchange_all_univ: "ÂÖ®ËΩâÊèõÔºöÈÄöÁî®", // Updated Text

                prog_title: "Á¢éÁâáÂêàÊàêÈÄ≤Â∫¶Áõ§Èªû",
                prog_syn: "Âêà", prog_need: "Â∑Æ",

                sec_shop_title: "ÂÖåÊèõÂïÜÂ∫óË¶èÂäÉ",
                shop_desc: "Ë´ãÂãæÈÅ∏‰Ω†ÊÉ≥ÂÖåÊèõÁöÑÈ†ÖÁõÆ„ÄÇ",
                shop_conv_attr: "ÂÖ®ËΩâÂ±¨ÊÄßÊÆòÊç≤",
                shop_conv_univ: "ÂÖ®ËΩâÈÄöÁî®ÊÆòÊç≤",
                val_total: "Á∏ΩÂÉπÂÄº", req_total: "Á∏ΩÈúÄÊ±Ç", bal_total: "È§òÈ°ç",
                dtl_detail: "ÊòéÁ¥∞",
                card_supply: "‰æõÁµ¶", card_cost: "Ëä±Ë≤ª", card_bal: "ÁµêÈ§ò", card_inv: "Â∫´Â≠ò",

                sec_daily_title: "ÊØèÊó•Ë≥áÊ∫êÁç≤ÂèñÊòéÁ¥∞",
                th_day: "Day", th_date: "Êó•Êúü", th_gain: "Áï∂Êó•Áç≤Âæó (Â±¨/ÈÄö/Èö®Ê©ü)", th_acc: "Á¥ØÁ©ç Â±¨/ÈÄö", th_frag: "Á¥ØÁ©ç Èö®Ê©ü", th_note: "ÂÇôË®ª",
                note_weekly: "ÊØèÈÄ±Á•ûÂìÅ(+30Â±¨/+40ÈÄö)",
                note_fixed: "Ê¥ªÂãïÂõ∫ÂÆöÁçéÂãµ",
                note_leg: "ÂÇ≥È†å(+{v}ÈÄö)",

                sec_source_title: "üìú ÂÆòÊñπÁ¢éÁâáÁç≤Âèñ‰æÜÊ∫êË™™Êòé",
                src_fixed_title: "üéâ Ê¥ªÂãïÂÖ®Á®ãÂõ∫ÂÆö‰ªªÂãô (‰∏ÄÊ¨°ÊÄß)",
                src_weekly_title: "üìÖ ÈÄ±ÊúüÊÄß‰ªªÂãô",
                src_weekly_sub: "ÊØèÈÄ±‰ªªÂãô (ÈÄ±Êó•ÈáçÁΩÆ)",
                src_daily_sub: "ÊØèÊó•Áç≤Âèñ (Èö®Ê©ü+‰ªªÂãô)",
                src_daily_note: "(ÊØèÊó•Èö®Ê©ü 15 + ÊØèÊó•‰ªªÂãô 4)",
                src_art_reward: "ÂèØÈÅ∏ 0~25 Èö®Ê©üÁ¢éÁâá",
                unit_frag: "Áâá", unit_week: "ÈÄ±", unit_day: "Â§©",

                src_rewards_title: "üéÅ ËóèÂØ∂ÂúñË®é‰ºêÁçéÂãµÂ∞çÁÖßË°®",
                reward_header_qual: "ÂìÅË≥™", reward_header_role: "Ë∫´ÂàÜ", reward_header_attr: "Â±¨ÊÄßÊç≤", reward_header_univ: "ÈÄöÁî®Êç≤", reward_header_refund: "ËøîÈÇÑ",
                role_capt: "ÈöäÈï∑", role_memb: "ÈöäÂì°",

                help_title: "‰ΩøÁî®ÊåáÂçó",
                help_p1: "Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂ∫´Â≠òÔºàÂê´ÊàêÂìÅÂúñÂ±¨ÊÄßÔºâËàáÁ¢éÁâáÔºåÁ≥ªÁµ±Â∞áËá™ÂãïË®àÁÆóÊú™‰æÜÁ∏ΩÊî∂ÁõäËàáÂïÜÂ∫óË¶èÂäÉ„ÄÇ",
                help_h1: "1. Ë≥ºË≤∑ÂäõÂà§Êñ∑ (ÁèæÂú® vs Êú™‰æÜ)",
                help_p2: "„ÄåÂÖåÊèõÂïÜÂ∫óË¶èÂäÉ„ÄçÊé°Áî®Â§öÈáçÂà§Êñ∑Ê©üÂà∂Ôºö",
                help_li1: "‚óè **ÁèæÂú®**ÔºöÂÉÖË®àÁÆó„ÄåÁèæÊúâÂ∫´Â≠ò„Äç„ÄÇÈ°ØÁ§∫ÁÇ∫Ë≤†Êï∏‰ª£Ë°®ÊÇ®ÁèæÈáë‰∏çË∂≥„ÄÇ",
                help_li2: "‚óè **Êú™‰æÜ**ÔºöÂÑ™ÂÖà‰ΩøÁî®„ÄåÊåÅÊúâÂ±¨ÊÄßÂúñ„ÄçÁî¢Âá∫ÁöÑÊÆòÊç≤ÔºåÂÜçË®àÁÆóÈÄöÁî®/Èö®Ê©üÊî∂Áõä„ÄÇ",
                help_h2: "2. Á¢éÁâáÂêàÊàêÈÅûËø¥ÈÇèËºØ",
                help_p3: "Êú¨Â∑•ÂÖ∑Ê®°Êì¨‰∫Ü„ÄåË®é‰ºêÁµï/Áèç/Âá°ÂìÅÂúñÂæåÈÄÄÈÇÑ 1 ÁâáÁ¢éÁâá„ÄçÁöÑË¶èÂâáÔºö",
                help_li3: "Áï∂ÊÇ®Ëº∏ÂÖ• 10 ÁâáÊôÇÔºåÈÄ≤Â∫¶ÊúÉÈ°ØÁ§∫„ÄåÂêà 1 / Â∑Æ 9„ÄçÔºåÂõ†ÁÇ∫Á≥ªÁµ±È†êÁü•ÊÇ®ÊâìÂÆåÂæåÊúÉÂâ© 1 Áâá„ÄÇ",
                help_h3: "3. Á∏ÆÊîæËàá‰æøÊç∑Êìç‰Ωú (New!)",
                help_p4: "‚óè **Á∏ÆÊîæÊìç‰Ωú**ÔºöÊÇ®ÂèØ‰ª•ÈªûÊìäÂè≥‰∏ãËßíÁöÑ [+] Êàñ [-] ÈÄ≤Ë°åÁ∏ÆÊîæÔºåÈªûÊìä‰∏≠Â§ÆÁôæÂàÜÊØîÂèØÈáçÁΩÆÁÇ∫ 100%„ÄÇ",
                help_li4: "‚óè **Âø´Êç∑Èçµ**ÔºöÊîØÊè¥ `Ctrl` + `+`/`-` Á∏ÆÊîæÔºå‰ª•Âèä `Ctrl` + `0` ÈáçÁΩÆ„ÄÇ",
                help_h4: "4. Âª∫Ë≠∞ÊØèÊó•‰ΩøÁî®ÊµÅÁ®ã",
                help_s1: "ÊØèÊó•Êõ¥Êñ∞Â∫´Â≠ò (Â∫´Â≠òËàáÊî∂ÁõäÁ∏ΩË¶Ω)",
                help_d1: "Â°´ÂÖ•‰ªäÊó•ÊúÄÊñ∞ÁöÑÊÆòÊç≤„ÄÅÊàêÂìÅÂúñËàáÁ¢éÁâáÊï∏Èáè„ÄÇ",
                help_s2: "Êü•ÁúãÂêàÊàêÈÄ≤Â∫¶ (Â∫´Â≠òËàáÊî∂ÁõäÁ∏ΩË¶Ω Âè≥ÂÅ¥)",
                help_d2: "Ëã•È°ØÁ§∫ÂèØÂêàÊàêÔºå‰ª£Ë°®ÈÅäÊà≤ÂÖßÂèØ‰ª•ÂéªÂêàÊàê‰∏¶Ë®é‰ºê‰∫Ü„ÄÇ",
                help_s3: "ÂÑ™ÂÖàÈöäÂàóË¶èÂäÉ (ÂïÜÂ∫óË¶èÂäÉ)",
                help_d3: "Âä†ÂÖ•ÊÉ≥Ë≤∑ÁöÑÂïÜÂìÅÔºå‰∏¶ÈÄèÈÅé„Äå‰∏ä/‰∏ã„ÄçÊåâÈàïË™øÊï¥ÂÑ™ÂÖàÈ†ÜÂ∫è„ÄÇÁ≥ªÁµ±ÊúÉ‰æùÂ∫èÊâ£Èô§Ë≥áÊ∫ê‰∏¶È°ØÁ§∫Áº∫Âè£„ÄÇ",
                btn_gotit: "ÊàëÁû≠Ëß£‰∫Ü",

                // Priority Logic
                prio_title: "üèÜ ÂãïÊÖãË≥ºÁâ©ÈöäÂàóËàáÁº∫Âè£ÂàÜÊûê",
                prio_subtitle: "Áî±‰∏äËÄå‰∏ã‰æùÂ∫èË®àÁÆóÔºåÈªûÈÅ∏È†ÖÁõÆÂæåÂèØÁßªÂãï/Âà™Èô§",
                prio_header_item: "ÂÖåÊèõÈ†ÖÁõÆ",
                prio_header_calc: "Êâ£Èô§‰æÜÊ∫ê",
                prio_header_status: "ÁãÄÊÖã",
                prio_empty: "Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑÔºåË´ãÂú®‰∏ãÊñπÈªûÈÅ∏ + Âä†ÂÖ•ÂïÜÂìÅ",
                prio_stock_used: "ÁèæÊúâÂ±¨ÊÄßÂ∫´Â≠ò",
                prio_future_attr: "È†êË®àÁç≤Âæó: Â±¨ÊÄßÊç≤",
                prio_future_univ: "È†êË®àÁç≤Âæó: ÈÄöÁî®Êç≤",
                prio_univ_stock: "ÁèæÊúâÈÄöÁî®Â∫´Â≠ò",
                prio_univ_reward: "È†êË®àÁç≤Âæó: ÈÄöÁî®Êç≤",
                prio_conv_used: "Â±¨ÊÄßËΩâÂåñ",
                btn_clear_all: "üóëÔ∏è ÂÖ®ÈÉ®Ê∏ÖÁ©∫",
                prio_gap: "Áº∫Âè£",
                prio_status_stock: "‚úÖ Â∫´Â≠òÂÖÖË∂≥",
                prio_status_univ: "üü¢ ÈÄöÁî®ÂÖåÊèõ",
                prio_status_convert: "üîµ Â±¨ÊÄßËΩâÂåñ",
                prio_status_gap: "üî¥ Ë≥áÊ∫ê‰∏çË∂≥",
                prio_farm: "Âª∫Ë≠∞ÔºöÂ∞àÊîª{attr}Âúñ",
                prio_rem_univ: "ÈÄöÁî®Ê±†Ââ©È§ò:",
            },
            en: {
                title: "Treasure Map Calculator",
                period: "Event Period: 2026/01/21 ~ 2026/02/25",
                tab_main: "Overview",
                tab_shop: "Shop Plan",
                tab_daily: "Daily Log",
                tab_sources: "Sources",
                btn_help: "‚ùì Help",
                btn_tabs: "üìë Tabs",
                btn_single: "üìú Single",
                btn_clear: "üóëÔ∏è Clear",
                lbl_date: "Current Date",
                lbl_remaining: "{d} Days / {w} Weeks Left",
                lbl_legend: "Mythical Map (Limit 1 ea)",
                lbl_leg_captain: "Cpt(+150)",
                lbl_leg_member: "Mem(+75)",
                lbl_scrolls: "Scrolls Owned",
                lbl_maps: "Maps Owned",
                lbl_frags: "Fragments Owned",
                attr_fire: "Fire", attr_water: "Water", attr_wind: "Wind", attr_thunder: "Thndr", attr_univ: "Univ",
                qual_god: "Divine", qual_peerless: "Superior", qual_rare: "Epic", qual_common: "Common", qual_random: "Random",
                qual_legend: "Mythical",

                sec_settings: "Settings & Stock",
                sec_income_title: "Total Event Income Estimate",
                sec_details_title: "Scroll Sources Detail",
                row_base: "Stock+Fixed",
                row_maps: "Map Runs",
                row_conv: "Rdm Conv",
                row_synth: "Frag Synth",
                total_est: "Total Est.",
                exchange_ref: "üîÑ Final Exchange Ref (2:1)",
                exchange_all_attr: "All to Attr",
                exchange_all_univ: "All to Univ",

                prog_title: "Fragment Synthesis Progress",
                prog_syn: "Craft", prog_need: "Need",

                sec_shop_title: "Shop Planning",
                shop_desc: "Select items you want to exchange.",
                shop_conv_attr: "Convert All to Attribute",
                shop_conv_univ: "Convert All to Universal",
                val_total: "Value", req_total: "Cost", bal_total: "Bal.",
                dtl_detail: "Detail",
                card_supply: "Supply", card_cost: "Cost", card_bal: "Net", card_inv: "Stock",

                sec_daily_title: "Daily Resource Log",
                th_day: "Day", th_date: "Date", th_gain: "Gain (Attr/Univ/Rdm)", th_acc: "Acc A/U", th_frag: "Acc Rdm", th_note: "Note",
                note_weekly: "Weekly Divine(+30A/+40U)",
                note_fixed: "Event Fixed",
                note_leg: "Mythical(+{v}U)",

                sec_source_title: "üìú Fragment Source Reference",
                src_fixed_title: "üéâ Event Fixed Tasks (One-time)",
                src_weekly_title: "üìÖ Periodic Tasks",
                src_weekly_sub: "Weekly Tasks (Reset Sun)",
                src_daily_sub: "Daily (Random+Task)",
                src_daily_note: "(Daily Random 15 + Task 4)",
                src_art_reward: "Select 0-25 Random Frag",
                unit_frag: "pcs", unit_week: "/wk", unit_day: "/day",

                src_rewards_title: "üéÅ Map Rewards Table",
                reward_header_qual: "Quality", reward_header_role: "Role", reward_header_attr: "Attr Scrolls", reward_header_univ: "Univ Scrolls", reward_header_refund: "Refund",
                role_capt: "Captain", role_memb: "Member",

                help_title: "User Guide",
                help_p1: "Enter your stock (including map attributes) and fragments to calculate future income.",
                help_h1: "1. Purchasing Power (Now vs. Future)",
                help_p2: "Shop Planning uses multi-stage logic:",
                help_li1: "‚óè **Now**: Uses 'Current Stock Only'. Negative means unaffordable.",
                help_li2: "‚óè **Future**: Prioritizes specific scrolls from 'Owned Maps', then uses flexible income.",
                help_h2: "2. Recursive Synthesis",
                help_p3: "The tool simulates the '1-fragment refund after Superior/Epic/Common runs' rule:",
                help_li3: "Entering 10 fragments shows '1 Craft / 9 Needed' because 1 is returned after usage.",
                help_h3: "3. Zoom & Shortcuts (New!)",
                help_p4: "‚óè **Zoom Console**: Use [+] or [-] in the bottom right. Tap the percentage to reset to 100%.",
                help_li4: "‚óè **Shortcuts**: Supports `Ctrl` + `+`/`-` zoom, and `Ctrl` + `0` to reset.",
                help_h4: "4. Recommended Routine",
                help_s1: "Daily Stock Update (Tab 1)",
                help_d1: "Fill in your latest scrolls, maps, and fragments.",
                help_s2: "Check Synthesis (Tab 1 Bottom Right)",
                help_d2: "If craftable, it means you can synthesize and raid in-game.",
                help_s3: "Plan Queue (Tab 2)",
                help_d3: "Add items and use Up/Down to prioritize. The system drains resources in waterfall order.",
                btn_gotit: "Got it",

                // Priority Logic
                prio_title: "üèÜ Dynamic Shopping Queue",
                prio_subtitle: "Calculated top-to-bottom. Tap to select/move.",
                prio_header_item: "Item",
                prio_header_calc: "Source",
                prio_header_status: "Status",
                prio_empty: "Cart is empty. Add items below.",
                prio_stock_used: "Current Attr Stock",
                prio_future_attr: "Future: Attr Reward",
                prio_future_univ: "Future: Univ Reward",
                prio_univ_stock: "Current Univ Stock",
                prio_univ_reward: "Future: Univ Reward",
                prio_conv_used: "Attr Conversion",
                btn_clear_all: "üóëÔ∏è Clear All",
                prio_gap: "Gap",
                prio_status_stock: "‚úÖ Stock",
                prio_status_univ: "üü¢ Univ Used",
                prio_status_convert: "üîµ Attr Conv",
                prio_status_gap: "üî¥ Shortage",
                prio_farm: "Advice: Farm {attr}",
                prio_rem_univ: "Univ Rem:",
            }
        };
        // #endregion

        // --- Â∏∏Êï∏Ë®≠ÂÆö ---
        // #region Â∏∏Êï∏ËàáÈÖçÁΩÆ (Constants)
        const START_DATE = new Date("2026-01-21T12:00:00+08:00");
        const END_DATE = new Date("2026-02-25T00:00:00+08:00");

        const DAILY_MEMBER_REWARD = { attr: 22, univ: 29 };
        const WEEKLY_MEMBER_REWARD = { attr: 30, univ: 40 };
        const LEGEND_REWARD_MEMBER = { attr: 0, univ: 75 };
        const LEGEND_REWARD_CAPTAIN = { attr: 0, univ: 150 };

        const FRAG_SOURCES = {
            dailyRandom: 19, weeklyGod: 3, fixedGod: 4, fixedPeerless: 5, fixedRare: 9, fixedCommon: 8, fixedRandom: 20
        };

        const CAPTAIN_REWARDS = {
            god: { attr: 30, univ: 40, refundFrag: 0 },
            peerless: { attr: 16, univ: 20, refundFrag: 1 },
            rare: { attr: 8, univ: 10, refundFrag: 1 },
            common: { attr: 4, univ: 5, refundFrag: 1 }
        };

        const RANDOM_CONVERSION = { attr: 4, univ: 5, refundCommonFrag: 1, cost: 10 };
        const WEEKDAYS = ["(Êó•)", "(‰∏Ä)", "(‰∫å)", "(‰∏â)", "(Âõõ)", "(‰∫î)", "(ÂÖ≠)"];
        const APP_VERSION = "v3.11";
        const APP_AUTHOR = "Nikis Ray";

        // --- ÂïÜÂ∫óË®≠ÂÆö ---
        const ATTR_SHOP_ITEMS = [
            { id: 1, name: "I", cost: 1250 },
            { id: 2, name: "II", cost: 1000 },
            { id: 3, name: "III", cost: 750 },
            { id: 4, name: "IV", cost: 500 },
        ];
        const UNIV_SHOP_ITEMS = [
            { id: 1, name: "I", cost: 1500 },
            { id: 2, name: "II", cost: 1000 },
            { id: 3, name: "III", cost: 750 },
            { id: 4, name: "IV", cost: 500 },
        ];
        // #endregion

        function App() {
            // #region ÁãÄÊÖãÁÆ°ÁêÜ (State)
            const [activeTab, setActiveTab] = useState('main');
            const [viewMode, setViewMode] = useState('tabs');
            const [showHelp, setShowHelp] = useState(false);
            const [lang, setLang] = useState('zh');
            const [zoomLevel, setZoomLevel] = useState(() => {
                const saved = localStorage.getItem('treasure-zoom');
                return saved ? parseInt(saved) : 100;
            });

            useEffect(() => {
                document.documentElement.style.fontSize = `${zoomLevel}%`;
                localStorage.setItem('treasure-zoom', zoomLevel.toString());
            }, [zoomLevel]);

            // --- Êñ∞Â¢ûÔºöÂø´Êç∑ÈçµÊîØÊè¥ ---
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === '=' || e.key === '+') {
                            e.preventDefault();
                            setZoomLevel(prev => Math.min(250, prev + 10));
                        } else if (e.key === '-') {
                            e.preventDefault();
                            setZoomLevel(prev => Math.max(50, prev - 10));
                        } else if (e.key === '0') {
                            e.preventDefault();
                            setZoomLevel(100);
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            const t = I18N[lang];

            const [currentDateInput, setCurrentDateInput] = useState(() => {
                const now = new Date();
                if (now < START_DATE) return "2026-01-21";
                if (now > END_DATE) return "2026-02-25";
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            });

            const [inventory, setInventory] = useState({
                attrFire: 0, attrWater: 0, attrWind: 0, attrThunder: 0, univScrolls: 0,

                // Maps: Quality x Attribute (16 fields)
                godMapsWind: 0, godMapsThunder: 0, godMapsWater: 0, godMapsFire: 0,
                peerlessMapsWind: 0, peerlessMapsThunder: 0, peerlessMapsWater: 0, peerlessMapsFire: 0,
                rareMapsWind: 0, rareMapsThunder: 0, rareMapsWater: 0, rareMapsFire: 0,
                commonMapsWind: 0, commonMapsThunder: 0, commonMapsWater: 0, commonMapsFire: 0,

                godFrags: 0, peerlessFrags: 0, rareFrags: 0, commonFrags: 0, randomFrags: 0
            });

            const [legendOptions, setLegendOptions] = useState({ includeMember: false, includeCaptain: false, artEventAmount: 0 });

            // Using cartQueue as the Source of Truth for the order of items
            const [cartQueue, setCartQueue] = useState([]);

            // shopCart is derived or synchronized for the bottom UI counters (O(1) lookup)
            const [shopCart, setShopCart] = useState({
                fire: {}, water: {}, wind: {}, thunder: {}, univ: {}
            });

            // Selected Item in Queue for Mobile Actions
            const [selectedQueueIndex, setSelectedQueueIndex] = useState(null);
            // #endregion

            // --- ËºîÂä©ÂáΩÂºè ---
            // #region ËºîÂä©ÂáΩÂºè (Utils)
            const getDaysDiff = (start, end) => {
                const s = new Date(start); s.setHours(0, 0, 0, 0);
                const e = new Date(end); e.setHours(0, 0, 0, 0);
                return Math.max(0, Math.round((e - s) / (1000 * 60 * 60 * 24)));
            };

            const countSundays = (start, end) => {
                let count = 0;
                let d = new Date(start); d.setHours(12, 0, 0, 0);
                while (d < end) {
                    if (d.getDay() === 0) count++;
                    d.setDate(d.getDate() + 1);
                }
                return count;
            };
            // #endregion

            // --- ‰∏ªË¶ÅË®àÁÆó ---
            // #region Ê†∏ÂøÉË®àÁÆóÈÇèËºØ (Calculation)
            const calculation = useMemo(() => {
                const totalDays = 35;
                const totalWeeks = 6;
                const userDate = new Date(currentDateInput);
                const daysRemaining = Math.min(getDaysDiff(userDate, END_DATE), totalDays);
                let weeksRemaining = 0;
                if (userDate < END_DATE) {
                    weeksRemaining = 1 + countSundays(userDate, END_DATE);
                    if (weeksRemaining > totalWeeks) weeksRemaining = totalWeeks;
                }

                // Êî∂ÁõäË®àÁÆó
                const futureFixedAttr = (DAILY_MEMBER_REWARD.attr * daysRemaining) + (WEEKLY_MEMBER_REWARD.attr * weeksRemaining);
                const futureFixedUniv = (DAILY_MEMBER_REWARD.univ * daysRemaining) + (WEEKLY_MEMBER_REWARD.univ * weeksRemaining);
                const legendUniv = (legendOptions.includeMember ? LEGEND_REWARD_MEMBER.univ : 0) +
                    (legendOptions.includeCaptain ? LEGEND_REWARD_CAPTAIN.univ : 0);
                const artEventFrags = (parseInt(legendOptions.artEventAmount) || 0);

                const inventoryAttrTotal = parseInt(inventory.attrFire || 0) + parseInt(inventory.attrWater || 0) +
                    parseInt(inventory.attrWind || 0) + parseInt(inventory.attrThunder || 0);

                const totalEstFixedAttr = inventoryAttrTotal + futureFixedAttr;
                const totalEstFixedUniv = parseInt(inventory.univScrolls || 0) + futureFixedUniv + legendUniv;

                // ÊàêÂìÅÂúñÊî∂Áõä (Updated for Attribute Specifics)
                const getMapStats = (type, count) => ({
                    attr: count * CAPTAIN_REWARDS[type].attr,
                    univ: count * CAPTAIN_REWARDS[type].univ,
                    refund: count * CAPTAIN_REWARDS[type].refundFrag
                });

                // Calculate rewards for each attribute series
                const calcAttrSeries = (attrKey) => {
                    const god = parseInt(inventory[`godMaps${attrKey}`] || 0);
                    const peerless = parseInt(inventory[`peerlessMaps${attrKey}`] || 0);
                    const rare = parseInt(inventory[`rareMaps${attrKey}`] || 0);
                    const common = parseInt(inventory[`commonMaps${attrKey}`] || 0);

                    const gR = getMapStats('god', god);
                    const pR = getMapStats('peerless', peerless);
                    const rR = getMapStats('rare', rare);
                    const cR = getMapStats('common', common);

                    return {
                        attr: gR.attr + pR.attr + rR.attr + cR.attr,
                        univ: gR.univ + pR.univ + rR.univ + cR.univ,
                        refund: gR.refund + pR.refund + rR.refund + cR.refund
                    };
                };

                const fireMaps = calcAttrSeries('Fire');
                const waterMaps = calcAttrSeries('Water');
                const windMaps = calcAttrSeries('Wind');
                const thunderMaps = calcAttrSeries('Thunder');

                const inventoryMapAttr = fireMaps.attr + waterMaps.attr + windMaps.attr + thunderMaps.attr;
                const inventoryMapUniv = fireMaps.univ + waterMaps.univ + windMaps.univ + thunderMaps.univ;

                // Future Fixed Income per Attribute (For Shop Queue)
                // Keys must match item categories (lowercase)
                const futureMapsIncome = {
                    fire: fireMaps.attr,
                    water: waterMaps.attr,
                    wind: windMaps.attr,
                    thunder: thunderMaps.attr
                };

                // Èö®Ê©üËΩâÂåñ
                const isStart = userDate <= START_DATE;
                const futureRandomFrags = (FRAG_SOURCES.dailyRandom * daysRemaining) + (isStart ? FRAG_SOURCES.fixedRandom : 0) + artEventFrags;

                const totalRandomPool = parseInt(inventory.randomFrags || 0) + futureRandomFrags;
                const randomToMapsCount = Math.floor(totalRandomPool / 10);
                const convertedAttr = randomToMapsCount * RANDOM_CONVERSION.attr;
                const convertedUniv = randomToMapsCount * RANDOM_CONVERSION.univ;
                const refundedCommonFrags = randomToMapsCount * RANDOM_CONVERSION.refundCommonFrag;

                // Á¢éÁâáÂêàÊàêÊî∂Áõä
                // Note: Refunds from Owned Maps (Fire/Water/etc) are added to the Fragment Pools here
                // We sum up refunds from all attributes
                const totalMapRefunds = fireMaps.refund + waterMaps.refund + windMaps.refund + thunderMaps.refund;

                // Assuming all refunds go to Peerless/Rare/Common pools respectively, but the code above sums them up.
                // Wait, logic check: 'god' has 0 refund. 'peerless'/'rare'/'common' have 1 refund.
                // The refund type depends on the map type. We need to sum by quality, not just total.

                const getCountByQual = (qual) => {
                    return (parseInt(inventory[`${qual}MapsFire`] || 0)) +
                        (parseInt(inventory[`${qual}MapsWater`] || 0)) +
                        (parseInt(inventory[`${qual}MapsWind`] || 0)) +
                        (parseInt(inventory[`${qual}MapsThunder`] || 0));
                };

                const totalPeerlessRefunds = getCountByQual('peerless') * CAPTAIN_REWARDS.peerless.refundFrag;
                const totalRareRefunds = getCountByQual('rare') * CAPTAIN_REWARDS.rare.refundFrag;
                const totalCommonRefunds = getCountByQual('common') * CAPTAIN_REWARDS.common.refundFrag;

                const totalGodPool = parseInt(inventory.godFrags || 0) + ((FRAG_SOURCES.weeklyGod * weeksRemaining) + (isStart ? FRAG_SOURCES.fixedGod : 0));
                const totalPeerlessPool = parseInt(inventory.peerlessFrags || 0) + ((isStart ? FRAG_SOURCES.fixedPeerless : 0) + totalPeerlessRefunds);
                const totalRarePool = parseInt(inventory.rareFrags || 0) + ((isStart ? FRAG_SOURCES.fixedRare : 0) + totalRareRefunds);
                const totalCommonPoolFinal = parseInt(inventory.commonFrags || 0) + ((isStart ? FRAG_SOURCES.fixedCommon : 0) + totalCommonRefunds + refundedCommonFrags);

                const mapsFromGod = analyzeFragment(totalGodPool, CAPTAIN_REWARDS.god.refundFrag).maps;
                const mapsFromPeerless = analyzeFragment(totalPeerlessPool, CAPTAIN_REWARDS.peerless.refundFrag).maps;
                const mapsFromRare = analyzeFragment(totalRarePool, CAPTAIN_REWARDS.rare.refundFrag).maps;
                const mapsFromCommon = analyzeFragment(totalCommonPoolFinal, CAPTAIN_REWARDS.common.refundFrag).maps;

                const fragSynthAttr = (mapsFromGod * CAPTAIN_REWARDS.god.attr) + (mapsFromPeerless * CAPTAIN_REWARDS.peerless.attr) +
                    (mapsFromRare * CAPTAIN_REWARDS.rare.attr) + (mapsFromCommon * CAPTAIN_REWARDS.common.attr);
                const fragSynthUniv = (mapsFromGod * CAPTAIN_REWARDS.god.univ) + (mapsFromPeerless * CAPTAIN_REWARDS.peerless.univ) +
                    (mapsFromRare * CAPTAIN_REWARDS.rare.univ) + (mapsFromCommon * CAPTAIN_REWARDS.common.univ);

                // Á∏ΩÁµêÁÆó
                const grandTotalAttr = totalEstFixedAttr + inventoryMapAttr + convertedAttr + fragSynthAttr;
                const grandTotalUniv = totalEstFixedUniv + inventoryMapUniv + convertedUniv + fragSynthUniv;

                const futureAttrPool = grandTotalAttr - inventoryAttrTotal;

                // Future Flexible Amount (Daily Fixed + Random Convert + Frag Synth)
                // This is the pool used for "Future Choice" in shop, after Fixed Maps are used.
                // Logic: Flexible = GrandTotal - InventoryStock - FixedMapsIncome
                // But InventoryStock is already excluded from grandTotalAttr usually?
                // Wait, grandTotalAttr INCLUDES inventory stock.
                // So FutureAttrPool = FixedMaps + Flexible.
                // Flexible = FutureAttrPool - FixedMaps.
                const totalFixedMapsAttr = futureMapsIncome.fire + futureMapsIncome.water + futureMapsIncome.wind + futureMapsIncome.thunder;
                const futureFlexibleIncome = Math.max(0, futureAttrPool - totalFixedMapsAttr);

                // ÂïÜÂ∫óÊ∂àËÄóË®àÁÆó
                const calcCategoryCost = (category) => {
                    let cost = 0;
                    const items = category === 'univ' ? UNIV_SHOP_ITEMS : ATTR_SHOP_ITEMS;
                    items.forEach(item => {
                        const count = shopCart[category][item.id] || 0;
                        cost += count * item.cost;
                    });
                    return cost;
                };

                const shopCostFire = calcCategoryCost('fire');
                const shopCostWater = calcCategoryCost('water');
                const shopCostWind = calcCategoryCost('wind');
                const shopCostThunder = calcCategoryCost('thunder');
                const shopCostUniv = calcCategoryCost('univ');

                const shopCostAttrTotal = shopCostFire + shopCostWater + shopCostWind + shopCostThunder;

                // ÂÉπÂÄºÂÖåÊèõ
                const allAsAttr = grandTotalAttr + grandTotalUniv;
                const allAsUniv = grandTotalUniv + Math.floor(grandTotalAttr / 2);

                const shopCostAsAttr = shopCostAttrTotal + shopCostUniv;
                const shopCostAsUniv = shopCostUniv + Math.ceil(shopCostAttrTotal / 2);

                return {
                    daysRemaining, weeksRemaining, legendUniv,
                    totalEstFixedAttr, totalEstFixedUniv,
                    inventoryMapAttr, inventoryMapUniv,
                    convertedAttr, convertedUniv,
                    fragSynthAttr, fragSynthUniv,
                    grandTotalAttr, grandTotalUniv,
                    futureAttrPool,
                    futureMapsIncome,      // NEW
                    futureFlexibleIncome,  // NEW
                    allAsAttr, allAsUniv,
                    shopCostFire, shopCostWater, shopCostWind, shopCostThunder, shopCostUniv,
                    shopCostAttrTotal,
                    shopCostAsAttr, shopCostAsUniv,
                    netAttr: grandTotalAttr - shopCostAttrTotal,
                    netUniv: grandTotalUniv - shopCostUniv,
                    totalRandomPool,
                    godStatus: analyzeFragment(totalGodPool, CAPTAIN_REWARDS.god.refundFrag),
                    peerlessStatus: analyzeFragment(totalPeerlessPool, CAPTAIN_REWARDS.peerless.refundFrag),
                    rareStatus: analyzeFragment(totalRarePool, CAPTAIN_REWARDS.rare.refundFrag),
                    commonStatus: analyzeFragment(totalCommonPoolFinal, CAPTAIN_REWARDS.common.refundFrag),
                    randomStatus: analyzeFragment(totalRandomPool, 0),
                    totalGodPool, totalPeerlessPool, totalRarePool, totalCommonPoolFinal
                };
            }, [currentDateInput, inventory, legendOptions, shopCart]);

            // --- NEW: Waterfall Queue Calculation ---
            const priorityQueueAnalysis = useMemo(() => {
                // Initial Pools
                let currentUnivStock = parseInt(inventory.univScrolls || 0);
                // Future Univ Reward includes Fixed Univ from maps + Daily Univ.
                // Logic: GrandTotalUniv includes InventoryUniv. So Future = GrandTotal - Inventory.
                let futureUnivReward = (calculation.grandTotalUniv || 0) - currentUnivStock;

                // Future Choice Pool (Flexible)
                let futureFlexiblePool = calculation.futureFlexibleIncome || 0;

                // Future Fixed Maps Income (Specific Attribute)
                // We clone it to mutate during calculation
                let futureFixedMaps = {
                    fire: calculation.futureMapsIncome?.fire || 0,
                    water: calculation.futureMapsIncome?.water || 0,
                    wind: calculation.futureMapsIncome?.wind || 0,
                    thunder: calculation.futureMapsIncome?.thunder || 0
                };

                // Create a temporary inventory map for calculation (starting with current stock)
                let tempInv = {
                    fire: parseInt(inventory.attrFire || 0),
                    water: parseInt(inventory.attrWater || 0),
                    wind: parseInt(inventory.attrWind || 0),
                    thunder: parseInt(inventory.attrThunder || 0)
                };

                return cartQueue.map((item, index) => {
                    const result = {
                        ...item,
                        stockUsed: 0,
                        futureFixedUsed: 0, // NEW
                        futureAttrUsed: 0, // Flexible
                        univStockUsed: 0,
                        futureUnivRewardUsed: 0,
                        choiceToUnivUsed: 0,
                        choiceRawConsumed: 0,
                        attrConverted: 0,
                        attrConsumed: 0,
                        gap: 0,
                        status: 'ok',
                        remainingUnivPool: 0
                    };

                    const isUnivItem = item.category === 'univ';
                    const cost = item.cost;

                    if (!isUnivItem) {
                        let costRemaining = cost;

                        // 1. Current specific attribute stock
                        if (tempInv[item.category] >= costRemaining) {
                            tempInv[item.category] -= costRemaining;
                            result.stockUsed = costRemaining;
                            costRemaining = 0;
                            result.status = 'stock';
                        } else {
                            result.stockUsed = tempInv[item.category];
                            costRemaining -= tempInv[item.category];
                            tempInv[item.category] = 0;

                            // 2. Future Fixed Maps Income (NEW)
                            // "User holds Wind Map -> Gets Wind Scroll" logic
                            const fixedAvailable = futureFixedMaps[item.category];
                            if (fixedAvailable >= costRemaining) {
                                futureFixedMaps[item.category] -= costRemaining;
                                result.futureFixedUsed = costRemaining;
                                costRemaining = 0;
                                result.status = 'stock'; // Technically still "stock" or "future fixed"
                            } else {
                                result.futureFixedUsed = fixedAvailable;
                                costRemaining -= fixedAvailable;
                                futureFixedMaps[item.category] = 0;

                                // 3. Future Flexible Pool (1:1)
                                if (futureFlexiblePool >= costRemaining) {
                                    futureFlexiblePool -= costRemaining;
                                    result.futureAttrUsed = costRemaining;
                                    costRemaining = 0;
                                    result.status = 'stock';
                                } else {
                                    result.futureAttrUsed = futureFlexiblePool;
                                    costRemaining -= futureFlexiblePool;
                                    futureFlexiblePool = 0;

                                    // 4. Current Universal Stock
                                    if (currentUnivStock >= costRemaining) {
                                        currentUnivStock -= costRemaining;
                                        result.univStockUsed = costRemaining;
                                        costRemaining = 0;
                                        result.status = 'univ';
                                    } else {
                                        result.univStockUsed = currentUnivStock;
                                        costRemaining -= currentUnivStock;
                                        currentUnivStock = 0;

                                        // 5. Future Universal Reward
                                        if (futureUnivReward >= costRemaining) {
                                            futureUnivReward -= costRemaining;
                                            result.futureUnivRewardUsed = costRemaining;
                                            costRemaining = 0;
                                            result.status = 'univ';
                                        } else {
                                            result.futureUnivRewardUsed = futureUnivReward;
                                            costRemaining -= futureUnivReward;
                                            futureUnivReward = 0;

                                            // 6. Conversion from other attributes (2:1)
                                            // Can convert: Stock, FutureFixedMaps
                                            let neededAttr = costRemaining * 2;
                                            let attrConsumed = 0;
                                            const attrTypes = ['fire', 'water', 'wind', 'thunder'];
                                            for (let type of attrTypes) {
                                                if (neededAttr <= 0) break;

                                                // 1. Convert from Stock
                                                const availableStock = tempInv[type];
                                                const takeStock = Math.min(availableStock, neededAttr);
                                                tempInv[type] -= takeStock;
                                                attrConsumed += takeStock;
                                                neededAttr -= takeStock;

                                                if (neededAttr <= 0) break;

                                                // 2. Convert from Future Fixed Maps
                                                const availableFixed = futureFixedMaps[type];
                                                const takeFixed = Math.min(availableFixed, neededAttr);
                                                futureFixedMaps[type] -= takeFixed;
                                                attrConsumed += takeFixed;
                                                neededAttr -= takeFixed;
                                            }

                                            const convertedUniv = Math.floor(attrConsumed / 2);
                                            result.attrConverted = convertedUniv;
                                            result.attrConsumed = attrConsumed;
                                            costRemaining -= convertedUniv;

                                            if (costRemaining <= 0) result.status = 'convert';
                                            else { result.status = 'gap'; result.gap = costRemaining; }
                                        }
                                    }
                                }
                            }
                        }
                    } else {
                        // Universal Items
                        let costRemaining = cost;
                        // 1. Current Universal stock
                        if (currentUnivStock >= costRemaining) {
                            currentUnivStock -= costRemaining;
                            result.univStockUsed = costRemaining;
                            result.status = 'univ';
                        } else {
                            result.univStockUsed = currentUnivStock;
                            costRemaining -= currentUnivStock;
                            currentUnivStock = 0;

                            // 2. Future Universal Reward
                            if (futureUnivReward >= costRemaining) {
                                futureUnivReward -= costRemaining;
                                result.futureUnivRewardUsed = costRemaining;
                                costRemaining = 0;
                                result.status = 'univ';
                            } else {
                                result.futureUnivRewardUsed = futureUnivReward;
                                costRemaining -= futureUnivReward;
                                futureUnivReward = 0;

                                // 3. Future Flexible Pool (2:1 to Univ)
                                let neededChoice = costRemaining * 2;
                                let choiceTaken = Math.min(futureFlexiblePool, neededChoice);
                                futureFlexiblePool -= choiceTaken;
                                const choiceConverted = Math.floor(choiceTaken / 2);
                                result.choiceToUnivUsed = choiceConverted;
                                result.choiceRawConsumed = choiceTaken;
                                costRemaining -= choiceConverted;

                                if (costRemaining <= 0) result.status = 'convert';
                                else {
                                    // 4. Other Stocks & Future Fixed Maps (2:1)
                                    let neededAttr = costRemaining * 2;
                                    let attrConsumedTotal = 0;
                                    const attrTypes = ['fire', 'water', 'wind', 'thunder'];
                                    for (let type of attrTypes) {
                                        if (neededAttr <= 0) break;

                                        // 1. Convert from Stock
                                        const availableStock = tempInv[type];
                                        const takeStock = Math.min(availableStock, neededAttr);
                                        tempInv[type] -= takeStock;
                                        attrConsumedTotal += takeStock;
                                        neededAttr -= takeStock;

                                        if (neededAttr <= 0) break;

                                        // 2. Convert from Future Fixed Maps
                                        const availableFixed = futureFixedMaps[type];
                                        const takeFixed = Math.min(availableFixed, neededAttr);
                                        futureFixedMaps[type] -= takeFixed;
                                        attrConsumedTotal += takeFixed;
                                        neededAttr -= takeFixed;
                                    }
                                    const convertedStock = Math.floor(attrConsumedTotal / 2);
                                    result.attrConverted = convertedStock;
                                    result.attrConsumed = attrConsumedTotal;
                                    costRemaining -= convertedStock;

                                    if (costRemaining <= 0) result.status = 'convert';
                                    else { result.gap = costRemaining; result.status = 'gap'; }
                                }
                            }
                        }
                    }
                    result.remainingUnivPool = currentUnivStock + futureUnivReward;
                    return result;
                });
            }, [cartQueue, calculation, inventory]);
            // #endregion


            function analyzeFragment(count, refund = 0) {
                // Recursive calculation for maps: maps = 1 + floor((totalFrags - 10) / (10 - refund))
                // Each map synth requires 10, but returns 'refund' pieces back.
                const maps = count >= 10 ? (refund === 0 ? Math.floor(count / 10) : 1 + Math.floor((count - 10) / (10 - refund))) : 0;
                const totalConsumed = maps * 10;
                const totalRefunded = maps * refund;
                const current = count - totalConsumed + totalRefunded;
                const needed = 10 - current;
                return { maps, current, needed: needed <= 0 ? 0 : needed };
            }

            const dailyTable = useMemo(() => {
                let rows = [];
                let curr = new Date(START_DATE);
                let accAttr = 0, accUniv = 0, accRandom = 0;

                for (let i = 1; i <= 35; i++) {
                    const dateStr = curr.toISOString().split('T')[0];
                    const weekDay = WEEKDAYS[curr.getDay()];
                    const isSunday = curr.getDay() === 0;

                    let dayAttr = DAILY_MEMBER_REWARD.attr;
                    let dayUniv = DAILY_MEMBER_REWARD.univ;
                    let dayRandom = FRAG_SOURCES.dailyRandom;
                    let notes = [];

                    if (isSunday || i === 1) {
                        dayAttr += WEEKLY_MEMBER_REWARD.attr;
                        dayUniv += WEEKLY_MEMBER_REWARD.univ;
                        notes.push({ text: t.note_weekly, style: "font-bold text-black" });
                    }
                    if (i === 1) {
                        notes.push({ text: t.note_fixed, style: "text-gray-500" });
                        accRandom += FRAG_SOURCES.fixedRandom + (parseInt(legendOptions.artEventAmount) || 0);

                        let legUniv = 0;
                        if (legendOptions.includeMember) legUniv += LEGEND_REWARD_MEMBER.univ;
                        if (legendOptions.includeCaptain) legUniv += LEGEND_REWARD_CAPTAIN.univ;
                        if (legUniv > 0) {
                            dayUniv += legUniv;
                            const noteText = t.note_leg.replace('{v}', legUniv);
                            notes.push({ text: noteText, style: "font-bold text-orange-600" });
                        }
                    }

                    accAttr += dayAttr;
                    accUniv += dayUniv;
                    accRandom += dayRandom;

                    rows.push({
                        day: i, date: `${dateStr.slice(5)} ${lang === 'zh' ? weekDay : ''}`,
                        dayAttr, dayUniv, dayRandom,
                        accAttr, accUniv, accRandom,
                        notes
                    });
                    curr.setDate(curr.getDate() + 1);
                }
                return rows;
            }, [legendOptions, lang]);

            // #region ‰∫ã‰ª∂ËôïÁêÜ (Event Handlers)
            const updateInv = (field, val) => {
                let numVal = parseInt(val);
                if (val === "") {
                    setInventory(prev => ({ ...prev, [field]: "" }));
                    return;
                }
                if (numVal < 0) return;
                // Fix leading zero: convert "0100" back to "100"
                setInventory(prev => ({ ...prev, [field]: numVal.toString() }));
            };
            const toggleLegend = (field) => setLegendOptions(prev => ({ ...prev, [field]: !prev[field] }));

            const clearScrolls = () => setInventory(prev => ({ ...prev, attrFire: 0, attrWater: 0, attrWind: 0, attrThunder: 0, univScrolls: 0 }));
            const clearMaps = () => setInventory(prev => ({
                ...prev,
                godMapsWind: 0, godMapsThunder: 0, godMapsWater: 0, godMapsFire: 0,
                peerlessMapsWind: 0, peerlessMapsThunder: 0, peerlessMapsWater: 0, peerlessMapsFire: 0,
                rareMapsWind: 0, rareMapsThunder: 0, rareMapsWater: 0, rareMapsFire: 0,
                commonMapsWind: 0, commonMapsThunder: 0, commonMapsWater: 0, commonMapsFire: 0
            }));
            const clearFrags = () => setInventory(prev => ({ ...prev, godFrags: 0, peerlessFrags: 0, rareFrags: 0, commonFrags: 0, randomFrags: 0 }));

            // --- Updated Shop Logic with Queue ---
            const updateShop = (category, item, delta) => {
                // 1. Update the Count Map (Legacy for UI)
                setShopCart(prev => {
                    const currentCount = prev[category][item.id] || 0;
                    const newCount = Math.max(0, currentCount + delta);
                    return { ...prev, [category]: { ...prev[category], [item.id]: newCount } };
                });

                // 2. Update the Queue
                setCartQueue(prev => {
                    if (delta > 0) {
                        const newId = Date.now() + Math.random();
                        const newQueue = [...prev, {
                            uid: newId,
                            category,
                            id: item.id,
                            name: item.name,
                            cost: item.cost
                        }];
                        // Update selection index to the newly added item (end of list)
                        setSelectedQueueIndex(newQueue.length - 1);
                        return newQueue;
                    } else {
                        // Remove Last Occurrence
                        const reversed = [...prev].reverse();
                        const indexToRemove = reversed.findIndex(q => q.category === category && q.id === item.id);

                        if (indexToRemove !== -1) {
                            const newReversed = [...reversed];
                            newReversed.splice(indexToRemove, 1);
                            const finalQueue = newReversed.reverse();
                            setSelectedQueueIndex(null);
                            return finalQueue;
                        }
                        return prev;
                    }
                });
            };

            const clearShopCategory = (category) => {
                setShopCart(prev => ({ ...prev, [category]: {} }));
                // Also clear from queue
                setCartQueue(prev => prev.filter(item => item.category !== category));
            };

            // --- Manual Control Handlers ---
            const handleQueueItemClick = (index) => {
                if (selectedQueueIndex === index) {
                    setSelectedQueueIndex(null);
                } else {
                    setSelectedQueueIndex(index);
                }
            };

            const handleMoveUp = () => {
                if (selectedQueueIndex === null || selectedQueueIndex === 0) return;
                const newQueue = [...cartQueue];
                [newQueue[selectedQueueIndex - 1], newQueue[selectedQueueIndex]] = [newQueue[selectedQueueIndex], newQueue[selectedQueueIndex - 1]];
                setCartQueue(newQueue);
                setSelectedQueueIndex(selectedQueueIndex - 1);
            };

            const handleMoveDown = () => {
                if (selectedQueueIndex === null || selectedQueueIndex === cartQueue.length - 1) return;
                const newQueue = [...cartQueue];
                [newQueue[selectedQueueIndex + 1], newQueue[selectedQueueIndex]] = [newQueue[selectedQueueIndex], newQueue[selectedQueueIndex + 1]];
                setCartQueue(newQueue);
                setSelectedQueueIndex(selectedQueueIndex + 1);
            };

            const handleDeleteItem = () => {
                if (selectedQueueIndex === null) return;
                const itemToRemove = cartQueue[selectedQueueIndex];

                const newQueue = [...cartQueue];
                newQueue.splice(selectedQueueIndex, 1);
                setCartQueue(newQueue);

                // Fix selection state: inherit next index or keep same or null
                if (newQueue.length === 0) {
                    setSelectedQueueIndex(null);
                } else {
                    const nextIndex = Math.min(selectedQueueIndex, newQueue.length - 1);
                    setSelectedQueueIndex(nextIndex);
                }

                // Sync with ShopCart counts
                setShopCart(prev => {
                    const cat = itemToRemove.category;
                    const id = itemToRemove.id;
                    const currentCount = prev[cat][id] || 0;
                    const newCount = Math.max(0, currentCount - 1);
                    return { ...prev, [cat]: { ...prev[cat], [id]: newCount } };
                });
            };
            const clearAllQueue = () => {
                if (window.confirm(lang === 'zh' ? 'Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ë≥ºÁâ©ËªäÂóéÔºü' : 'Clear all items?')) {
                    setCartQueue([]);
                    setShopCart({ fire: {}, water: {}, wind: {}, thunder: {}, univ: {} });
                    setSelectedQueueIndex(null);
                }
            };
            // #endregion

            // #region ‰ªãÈù¢ËºîÂä©ÂÖÉ‰ª∂ (UI Components)
            const ShopItem = ({ item, category, color }) => {
                const count = shopCart[category][item.id] || 0;
                const costStyle = category === 'univ' ? "text-green-600" : "text-blue-600";

                return (
                    <div className="shop-counter">
                        <div className="flex flex-col justify-center">
                            <div className={`shop-item-cost-large ${costStyle}`}>{item.cost} Êç≤</div>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={() => updateShop(category, item, -1)} disabled={count <= 0}>-</button>
                            <span className={`text-sm font-bold w-6 text-center ${count > 0 ? color : 'text-gray-400'}`}>{count}</span>
                            <button onClick={() => updateShop(category, item, 1)}>+</button>
                        </div>
                    </div>
                );
            };

            const AttrDashboardCard = ({ label, textColor, bgColorClass, inv, cost }) => {
                const net = inv - cost;

                return (
                    <div className={`p-2 rounded-lg border ${bgColorClass} ${net >= 0 ? 'border-gray-200' : 'border-red-500 border-2'}`}>
                        <div className={`font-bold text-[0.75rem] mb-1 ${textColor}`}>{label}</div>
                        <div className="space-y-1 text-[0.625rem] text-gray-600">
                            <div className="flex justify-between"><span>{t.card_inv}:</span> <span>{inv.toLocaleString()}</span></div>
                            <div className="flex justify-between text-pink-600"><span>{t.card_cost}:</span> <span>-{cost.toLocaleString()}</span></div>
                            <div className="border-t border-gray-200 my-0.5 pt-0.5 flex justify-between items-center">
                                <span className="font-bold">{t.card_bal}:</span>
                                <span className={`font-bold text-sm ${net >= 0 ? 'text-blue-600' : 'text-red-600 font-extrabold'}`}>{net}</span>
                            </div>
                        </div>
                    </div>
                );
            };

            const getAttrLabel = (key) => t[`attr_${key}`];
            const getAttrColorText = (key) => `color-${key}`;
            const getAttrBg = (key) => `bg-${key}-light`;
            // #endregion

            // #region ‰ªãÈù¢‰ΩàÂ±Ä (UI Layout)
            return (
                <div className="max-w-5xl xl:max-w-7xl mx-auto p-2 md:p-6 flex flex-col min-h-screen relative">
                    {/* Top Section */}
                    <div className="flex flex-col md:flex-row justify-between items-center mb-4 pt-2 gap-3">
                        <div className="text-[0.75rem] font-bold text-gray-500 font-mono flex items-center justify-center md:justify-start order-2 md:order-1 flex-shrink-0">
                            {APP_VERSION} | {APP_AUTHOR}
                        </div>
                        <div className="text-center order-1 md:order-2 px-2">
                            <h1 className="text-2xl font-bold text-indigo-900 mb-0 leading-tight whitespace-nowrap">{t.title}</h1>
                            <p className="text-gray-500 text-[0.625rem]">{t.period}</p>
                        </div>
                        <div className="flex flex-wrap gap-2 justify-center md:justify-end order-3 md:order-3 flex-grow md:flex-grow-0">
                            <button onClick={() => setLang(prev => prev === 'zh' ? 'en' : 'zh')} className="bg-white text-indigo-600 px-3 py-1 rounded-full shadow-sm text-[0.75rem] font-bold hover:bg-indigo-50 transition border border-indigo-200 min-h-[1.875rem] flex items-center flex-shrink-0 whitespace-nowrap">
                                {lang === 'zh' ? 'EN' : '‰∏≠'}
                            </button>
                            <button onClick={() => setShowHelp(true)} className="bg-white text-gray-600 px-3 py-1 rounded-full shadow-sm text-[0.75rem] font-bold hover:bg-gray-50 transition border border-gray-200 min-h-[1.875rem] flex items-center flex-shrink-0 whitespace-nowrap">{t.btn_help}</button>
                            <button onClick={() => setViewMode(prev => prev === 'tabs' ? 'single' : 'tabs')} className="bg-white text-indigo-600 px-3 py-1 rounded-full shadow-sm text-[0.75rem] font-bold hover:bg-indigo-50 transition border border-indigo-100 flex items-center gap-1 min-h-[1.875rem] flex-shrink-0 whitespace-nowrap">
                                {viewMode === 'tabs' ? t.btn_tabs : t.btn_single}
                            </button>
                        </div>
                    </div>

                    {/* Help Modal */}
                    {showHelp && (
                        <div className="modal-overlay" onClick={() => setShowHelp(false)}>
                            <div className="modal-content p-6" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="text-xl font-bold text-gray-800">{t.help_title}</h3>
                                    <button onClick={() => setShowHelp(false)} className="text-gray-500 font-bold">√ó</button>
                                </div>
                                <div className="space-y-4 text-sm text-gray-700 overflow-y-auto px-1" style={{ maxHeight: '70vh' }}>
                                    <p>{t.help_p1}</p>

                                    {/* Section 1 */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1">{t.help_h1}</h4>
                                    <p>{t.help_p2}</p>
                                    <ul className="list-disc pl-5 space-y-1">
                                        <li>{t.help_li1}</li>
                                        <li>{t.help_li2}</li>
                                    </ul>

                                    {/* Section 2 */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1 mt-4">{t.help_h2}</h4>
                                    <p>{t.help_p3}</p>
                                    <ul className="list-disc pl-5 space-y-1">
                                        <li>{t.help_li3}</li>
                                    </ul>

                                    {/* Section 3 */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1 mt-4">{t.help_h3}</h4>
                                    <p className="mt-1">{t.help_p4}</p>
                                    <ul className="list-disc pl-5 space-y-1">
                                        <li>{t.help_li4}</li>
                                    </ul>

                                    {/* Section 4 */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1 mt-4">{t.help_h4}</h4>
                                    <ol className="list-decimal pl-5 space-y-2">
                                        <li><strong>{t.help_s1}</strong>Ôºö<p className="text-[0.75rem] text-gray-500 mt-0.5">{t.help_d1}</p></li>
                                        <li><strong>{t.help_s2}</strong>Ôºö<p className="text-[0.75rem] text-gray-500 mt-0.5">{t.help_d2}</p></li>
                                        <li><strong>{t.help_s3}</strong>Ôºö<p className="text-[0.75rem] text-gray-500 mt-0.5">{t.help_d3}</p></li>
                                    </ol>
                                </div>
                                <div className="mt-6 text-center"><button onClick={() => setShowHelp(false)} className="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 transition">{t.btn_gotit}</button></div>
                            </div>
                        </div>
                    )}

                    {/* ÂàÜÈ†Å Tab */}
                    {viewMode === 'tabs' && (
                        <div className="flex border-b border-gray-200 mb-4 bg-white rounded-t-lg shadow-sm tabs-container mx-1">
                            <div className={`tab-btn rounded-tl-lg ${activeTab === 'main' ? 'active' : ''}`} onClick={() => setActiveTab('main')}>{t.tab_main}</div>
                            <div className={`tab-btn ${activeTab === 'shop' ? 'active' : ''}`} onClick={() => setActiveTab('shop')}>{t.tab_shop}</div>
                            <div className={`tab-btn ${activeTab === 'daily' ? 'active' : ''}`} onClick={() => setActiveTab('daily')}>{t.tab_daily}</div>
                            <div className={`tab-btn rounded-tr-lg ${activeTab === 'sources' ? 'active' : ''}`} onClick={() => setActiveTab('sources')}>{t.tab_sources}</div>
                        </div>
                    )}

                    {/* Merged Tab 1: Ë®≠ÂÆöÂ∫´Â≠òËàáÊî∂ÁõäÈ†ê‰º∞ */}
                    {(viewMode === 'single' || activeTab === 'main') && (
                        <div className={`grid grid-cols-1 lg:grid-cols-12 gap-4 mx-1 h-full ${viewMode === 'tabs' ? 'mb-6' : 'mb-6'}`}>
                            {/* Left Col: Settings (5 cols wide) */}
                            <div className={`lg:col-span-5 card p-4 bg-white border-t-4 border-blue-500 flex flex-col h-full`}>
                                {/* 3-Row Header Layout - Consistent 3-Part Alignment & Compact */}
                                <div className="flex flex-col gap-1.5 mb-3">
                                    {/* Row 1: Date Selection */}
                                    <div className="bg-blue-50/50 p-2 rounded-lg border border-blue-100 flex flex-wrap items-center justify-between gap-2 shadow-sm">
                                        <div className="text-blue-900 font-bold text-[0.6875rem] flex items-center gap-1 min-w-[5rem]">üìÖ {t.lbl_date}</div>
                                        <div className="flex-grow flex items-center min-w-[8rem]">
                                            <input type="date" value={currentDateInput} onChange={(e) => setCurrentDateInput(e.target.value)} min="2026-01-21" max="2026-02-25" className="border-blue-200 rounded px-1 text-[0.75rem] h-7 w-full shadow-inner" onWheel={(e) => e.target.blur()} />
                                        </div>
                                        <div className="flex-shrink-0">
                                            <span className="text-[0.75rem] sm:text-[0.875rem] text-blue-700 font-bold whitespace-nowrap bg-white px-2 py-0.5 rounded shadow-sm border border-blue-100 block">
                                                {t.lbl_remaining.replace('{d}', calculation.daysRemaining).replace('{w}', calculation.weeksRemaining)}
                                            </span>
                                        </div>
                                    </div>

                                    {/* Row 2: Legend Rewards */}
                                    <div className="bg-purple-50/50 p-2 rounded-lg border border-purple-100 flex flex-wrap items-center justify-between gap-2 shadow-sm">
                                        <div className="text-purple-900 font-bold text-[0.6875rem] flex items-center gap-1 min-w-[5rem]">
                                            üìú {lang === 'zh' ? 'ÂÇ≥È†å' : 'Legend'}
                                        </div>
                                        <div className="flex-grow flex flex-row flex-wrap gap-2 items-center min-w-[8rem]">
                                            <div className="checkbox-group flex items-center gap-1">
                                                <input type="checkbox" id="legCaptain" checked={legendOptions.includeCaptain} onChange={() => toggleLegend('includeCaptain')} className="w-4 h-4 cursor-pointer" />
                                                <label htmlFor="legCaptain" className="text-gray-700 text-[0.625rem] sm:text-[0.75rem] cursor-pointer truncate">{t.lbl_leg_captain}</label>
                                            </div>
                                            <div className="checkbox-group flex items-center gap-1">
                                                <input type="checkbox" id="legMember" checked={legendOptions.includeMember} onChange={() => toggleLegend('includeMember')} className="w-4 h-4 cursor-pointer" />
                                                <label htmlFor="legMember" className="text-gray-700 text-[0.625rem] sm:text-[0.75rem] cursor-pointer truncate">{t.lbl_leg_member}</label>
                                            </div>
                                        </div>
                                        <div className="flex-shrink-0">
                                            <span className="text-[0.5625rem] sm:text-[0.625rem] text-purple-600 italic whitespace-nowrap bg-purple-100/50 px-2 py-0.5 rounded border border-purple-100 block">
                                                {lang === 'zh' ? 'Êî∂ÁõäË®àÂÖ•È†ê‰º∞' : 'Est. Inc.'}
                                            </span>
                                        </div>
                                    </div>

                                    {/* Row 3: Limited Events */}
                                    <div className="bg-orange-50/50 p-2 rounded-lg border border-orange-100 flex flex-wrap items-center justify-between gap-2 shadow-sm">
                                        <div className="text-orange-900 font-bold text-[0.6875rem] flex items-center gap-1 min-w-[5rem]">‚ú® {lang === 'zh' ? 'Â¶ôÊâã‰∏πÈùí' : 'Art Event'}</div>
                                        <div className="flex-grow flex items-center min-w-[8rem]">
                                            <div className="flex items-center gap-1">
                                                <select
                                                    id="legArt"
                                                    value={legendOptions.artEventAmount}
                                                    onChange={(e) => setLegendOptions(prev => ({ ...prev, artEventAmount: parseInt(e.target.value) }))}
                                                    className="border-orange-200 rounded px-1 text-[0.75rem] h-7 w-full shadow-inner bg-white"
                                                >
                                                    <option value="0">{lang === 'zh' ? 'ÁÑ°' : 'None'}</option>
                                                    <option value="5">5 {t.unit_frag}</option>
                                                    <option value="10">10 {t.unit_frag}</option>
                                                    <option value="15">15 {t.unit_frag}</option>
                                                    <option value="20">20 {t.unit_frag}</option>
                                                    <option value="25">25 {t.unit_frag}</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div className="flex-shrink-0">
                                            <span className="text-[0.5625rem] sm:text-[0.625rem] text-orange-600 italic whitespace-nowrap bg-orange-100/50 px-2 py-0.5 rounded border border-orange-100 block">
                                                {lang === 'zh' ? 'Êî∂ÁõäË®àÂÖ•È†ê‰º∞' : 'Est. Inc.'}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                {/* Scrolls */}
                                <div className="bg-blue-50 p-2 rounded-lg border border-blue-200 mb-2">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-[0.75rem] font-bold text-gray-700">{t.lbl_scrolls}</label>
                                        <button onClick={clearScrolls} className="text-[0.625rem] bg-white border border-gray-300 px-1 rounded shadow-sm">{t.btn_clear}</button>
                                    </div>
                                    <div className="grid grid-cols-5 gap-1">
                                        <div className="input-group"><label className="color-wind">{t.attr_wind}</label><input type="number" min="0" value={inventory.attrWind} onChange={(e) => updateInv('attrWind', e.target.value)} className="border-wind focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="color-thunder">{t.attr_thunder}</label><input type="number" min="0" value={inventory.attrThunder} onChange={(e) => updateInv('attrThunder', e.target.value)} className="border-thunder focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="color-water">{t.attr_water}</label><input type="number" min="0" value={inventory.attrWater} onChange={(e) => updateInv('attrWater', e.target.value)} className="border-water focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="color-fire">{t.attr_fire}</label><input type="number" min="0" value={inventory.attrFire} onChange={(e) => updateInv('attrFire', e.target.value)} className="border-fire focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-gray-600">{t.attr_univ}</label><input type="number" min="0" value={inventory.univScrolls} onChange={(e) => updateInv('univScrolls', e.target.value)} onWheel={(e) => e.target.blur()} /></div>
                                    </div>
                                </div>

                                {/* Maps (Matrix Layout) */}
                                <div className="bg-orange-50 p-2 rounded-lg border border-orange-200 mb-2">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-[0.75rem] font-bold text-gray-700">{t.lbl_maps}</label>
                                        <button onClick={clearMaps} className="text-[0.625rem] bg-white border border-gray-300 px-1 rounded shadow-sm">{t.btn_clear}</button>
                                    </div>

                                    {/* Header Row */}
                                    <div className="grid grid-cols-5 gap-1 mb-1 text-[0.625rem] font-bold text-center">
                                        <div></div>
                                        <div className="color-wind">{t.attr_wind}</div>
                                        <div className="color-thunder">{t.attr_thunder}</div>
                                        <div className="color-water">{t.attr_water}</div>
                                        <div className="color-fire">{t.attr_fire}</div>
                                    </div>

                                    {/* God Row */}
                                    <div className="grid grid-cols-5 gap-1 mb-1">
                                        <div className="text-[0.625rem] font-bold text-red-800 flex items-center justify-center bg-red-50 rounded border border-red-100">{t.qual_god}</div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.godMapsWind} onChange={(e) => updateInv('godMapsWind', e.target.value)} className="bg-red-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.godMapsThunder} onChange={(e) => updateInv('godMapsThunder', e.target.value)} className="bg-red-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.godMapsWater} onChange={(e) => updateInv('godMapsWater', e.target.value)} className="bg-red-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.godMapsFire} onChange={(e) => updateInv('godMapsFire', e.target.value)} className="bg-red-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                    </div>

                                    {/* Peerless Row */}
                                    <div className="grid grid-cols-5 gap-1 mb-1">
                                        <div className="text-[0.625rem] font-bold text-purple-800 flex items-center justify-center bg-purple-50 rounded border border-purple-100">{t.qual_peerless}</div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.peerlessMapsWind} onChange={(e) => updateInv('peerlessMapsWind', e.target.value)} className="bg-purple-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.peerlessMapsThunder} onChange={(e) => updateInv('peerlessMapsThunder', e.target.value)} className="bg-purple-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.peerlessMapsWater} onChange={(e) => updateInv('peerlessMapsWater', e.target.value)} className="bg-purple-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.peerlessMapsFire} onChange={(e) => updateInv('peerlessMapsFire', e.target.value)} className="bg-purple-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                    </div>

                                    {/* Rare Row */}
                                    <div className="grid grid-cols-5 gap-1 mb-1">
                                        <div className="text-[0.625rem] font-bold text-indigo-800 flex items-center justify-center bg-indigo-50 rounded border border-indigo-100">{t.qual_rare}</div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.rareMapsWind} onChange={(e) => updateInv('rareMapsWind', e.target.value)} className="bg-indigo-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.rareMapsThunder} onChange={(e) => updateInv('rareMapsThunder', e.target.value)} className="bg-indigo-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.rareMapsWater} onChange={(e) => updateInv('rareMapsWater', e.target.value)} className="bg-indigo-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.rareMapsFire} onChange={(e) => updateInv('rareMapsFire', e.target.value)} className="bg-indigo-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                    </div>

                                    {/* Common Row */}
                                    <div className="grid grid-cols-5 gap-1">
                                        <div className="text-[0.625rem] font-bold text-green-800 flex items-center justify-center bg-green-50 rounded border border-green-100">{t.qual_common}</div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.commonMapsWind} onChange={(e) => updateInv('commonMapsWind', e.target.value)} className="bg-green-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.commonMapsThunder} onChange={(e) => updateInv('commonMapsThunder', e.target.value)} className="bg-green-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.commonMapsWater} onChange={(e) => updateInv('commonMapsWater', e.target.value)} className="bg-green-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><input type="number" min="0" value={inventory.commonMapsFire} onChange={(e) => updateInv('commonMapsFire', e.target.value)} className="bg-green-50 text-center" onWheel={(e) => e.target.blur()} /></div>
                                    </div>
                                </div>

                                {/* Frags */}
                                <div className="bg-indigo-50 p-2 rounded-lg border border-indigo-200">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-[0.75rem] font-bold text-gray-700">{t.lbl_frags}</label>
                                        <button onClick={clearFrags} className="text-[0.625rem] bg-white border border-gray-300 px-1 rounded shadow-sm">{t.btn_clear}</button>
                                    </div>
                                    <div className="grid grid-cols-5 gap-1">
                                        <div className="input-group"><label className="text-god">{t.qual_god}</label><input type="number" min="0" value={inventory.godFrags} onChange={(e) => updateInv('godFrags', e.target.value)} className="bg-red-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-peerless">{t.qual_peerless}</label><input type="number" min="0" value={inventory.peerlessFrags} onChange={(e) => updateInv('peerlessFrags', e.target.value)} className="bg-purple-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-rare">{t.qual_rare}</label><input type="number" min="0" value={inventory.rareFrags} onChange={(e) => updateInv('rareFrags', e.target.value)} className="bg-indigo-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-common">{t.qual_common}</label><input type="number" min="0" value={inventory.commonFrags} onChange={(e) => updateInv('commonFrags', e.target.value)} className="bg-green-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-random">{t.qual_random}</label><input type="number" min="0" value={inventory.randomFrags} onChange={(e) => updateInv('randomFrags', e.target.value)} className="bg-yellow-50" onWheel={(e) => e.target.blur()} /></div>
                                    </div>
                                </div>
                            </div>

                            {/* Right Col: Income (7 cols wide) */}
                            <div className={`lg:col-span-7 card p-4 bg-white border-t-4 border-indigo-600 h-full`}>
                                {/* Details & Total Row */}
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    {/* Source Details */}
                                    <div className="bg-gray-50 p-2 rounded-lg border border-gray-200">
                                        <div className="flex justify-between items-center mb-2 border-b pb-1">
                                            <div className="font-bold text-gray-700 text-[0.75rem]">{t.sec_details_title}</div>
                                            <div className="flex gap-4 w-full justify-end text-[0.75rem] font-normal">
                                                <span className="text-blue-600">‚óè {lang === 'zh' ? 'Â±¨ÊÄß' : 'Attr'}</span>
                                                <span className="text-green-600">‚óè {lang === 'zh' ? 'ÈÄöÁî®' : 'Univ'}</span>
                                            </div>
                                        </div>
                                        <div className="space-y-1.5 text-[0.75rem]">
                                            <div className="grid grid-cols-3 gap-1 items-center py-1 border-b border-gray-200 bg-blue-50 px-1 rounded">
                                                <div className="text-gray-600 font-bold">{t.row_base}</div>
                                                <div className="text-right text-blue-600 font-bold">{calculation.totalEstFixedAttr.toLocaleString()}</div>
                                                <div className="text-right text-green-600 font-bold">{calculation.totalEstFixedUniv.toLocaleString()}</div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-1 items-center py-1 border-b border-gray-200 bg-orange-50 px-1 rounded">
                                                <div className="text-gray-600 font-bold">{t.row_maps}</div>
                                                <div className="text-right text-blue-600">{calculation.inventoryMapAttr.toLocaleString()}</div>
                                                <div className="text-right text-green-600">{calculation.inventoryMapUniv.toLocaleString()}</div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-1 items-center py-1 border-b border-gray-200 bg-indigo-50 px-1 rounded">
                                                <div className="text-gray-600 font-bold">{t.row_conv}</div>
                                                <div className="text-right text-blue-600">{calculation.convertedAttr.toLocaleString()}</div>
                                                <div className="text-right text-green-600">{calculation.convertedUniv.toLocaleString()}</div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-1 items-center py-1 bg-indigo-50 px-1 rounded">
                                                <div className="text-gray-600 font-bold">{t.row_synth}</div>
                                                <div className="text-right text-blue-600">{calculation.fragSynthAttr.toLocaleString()}</div>
                                                <div className="text-right text-green-600">{calculation.fragSynthUniv.toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Total & Exchange */}
                                    <div className="flex flex-col gap-2">
                                        <div className="bg-white p-2 rounded-lg border-2 border-indigo-100 flex-1 flex flex-col justify-center items-center shadow-sm">
                                            <div className="text-gray-400 text-[0.625rem] font-bold tracking-wider uppercase mb-1">{t.total_est}</div>
                                            <div className="flex gap-4 items-end">
                                                <div className="text-center">
                                                    <div className="text-2xl font-bold text-blue-600 tracking-tighter">{calculation.grandTotalAttr.toLocaleString()}</div>
                                                    <div className="text-[0.625rem] text-blue-400 font-bold">{lang === 'zh' ? 'Â±¨ÊÄß' : 'Attr'}</div>
                                                </div>
                                                <div className="text-center">
                                                    <div className="text-2xl font-bold text-green-600 tracking-tighter">{calculation.grandTotalUniv.toLocaleString()}</div>
                                                    <div className="text-[0.625rem] text-green-400 font-bold">{lang === 'zh' ? 'ÈÄöÁî®' : 'Univ'}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-orange-50 p-2 rounded-lg border border-orange-100 flex-1 flex flex-col justify-center">
                                            <div className="text-[0.825rem] text-orange-800 font-bold mb-1 italic opacity-85 leading-tight">
                                                {lang === 'zh' ? (
                                                    <React.Fragment>
                                                        <div>üí° ÊèêÁ§∫Ôºö‰ΩøÁî®ÈÄöÁî®Êç≤ÂèØ‰ª• 1:1 Êõø‰ª£Â±¨ÊÄßÊç≤„ÄÇ</div>
                                                        <div>ÂÖ∂‰ªñÂ±¨ÊÄßÈñìÂèØÈÄèÈÅé 2:1 ËΩâÂåñÂΩåË£úÁº∫Âè£„ÄÇ</div>
                                                    </React.Fragment>
                                                ) : (
                                                    <React.Fragment>
                                                        <div>üí° Protip: Universal scrolls substitute 1:1.</div>
                                                        <div>Attributes convert 2:1 for gaps.</div>
                                                    </React.Fragment>
                                                )}
                                            </div>
                                            <div className="text-[0.7rem] text-orange-600 mt-1">
                                                {lang === 'zh' ? 'Ë©≥Á¥∞Ë¶èÂäÉË´ãËá≥„ÄåÂïÜÂ∫ó„ÄçÂàÜÈ†ÅÊü•ÁúãÂÑ™ÂÖàÈöäÂàóÂàÜÊûê„ÄÇ' : 'Check "Shop" tab for priority analysis.'}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Progress Section */}
                                <div>
                                    <h3 className="font-bold text-gray-700 mb-2 text-sm border-b pb-1">{t.prog_title}</h3>
                                    <div className="grid grid-cols-2 gap-2 text-[0.6875rem]">
                                        <div className="flex justify-between p-1 bg-red-50 rounded border border-red-100"><span className="text-red-900 font-bold">{t.qual_god} ({calculation.totalGodPool})</span><span className="text-red-600">{t.prog_syn}{calculation.godStatus.maps} / {t.prog_need}{calculation.godStatus.needed}</span></div>
                                        <div className="flex justify-between p-1 bg-purple-50 rounded border border-purple-100"><span className="text-purple-900 font-bold">{t.qual_peerless} ({calculation.totalPeerlessPool})</span><span className="text-purple-600">{t.prog_syn}{calculation.peerlessStatus.maps} / {t.prog_need}{calculation.peerlessStatus.needed}</span></div>
                                        <div className="flex justify-between p-1 bg-indigo-50 rounded border border-indigo-100"><span className="text-indigo-900 font-bold">{t.qual_rare} ({calculation.totalRarePool})</span><span className="text-indigo-600">{t.prog_syn}{calculation.rareStatus.maps} / {t.prog_need}{calculation.rareStatus.needed}</span></div>
                                        <div className="flex justify-between p-1 bg-green-50 rounded border border-green-100"><span className="text-green-900 font-bold">{t.qual_common} ({calculation.totalCommonPoolFinal})</span><span className="text-green-600">{t.prog_syn}{calculation.commonStatus.maps} / {t.prog_need}{calculation.commonStatus.needed}</span></div>
                                        <div className="col-span-2 flex justify-between p-1 bg-yellow-50 rounded border border-yellow-100"><span className="text-yellow-900 font-bold">{t.qual_random} ({calculation.totalRandomPool})</span><span className="text-yellow-600">{t.prog_syn}{calculation.randomStatus.maps} / {t.prog_need}{calculation.randomStatus.needed}</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 3: ÂïÜÂ∫ó */}
                    {(viewMode === 'single' || activeTab === 'shop') && (
                        <div className={`card p-4 bg-white border-t-4 border-pink-500 mx-1 ${viewMode === 'tabs' ? 'mb-6' : 'mb-6'}`}>

                            {/* Queue + Summary Layout */}
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-4">
                                {/* Left: Dynamic Priority Queue */}
                                <div className="lg:col-span-9 border-2 border-indigo-100 rounded-xl overflow-hidden shadow-sm flex flex-col h-full">
                                    <div className="bg-gradient-to-r from-indigo-50 to-white p-2 border-b border-indigo-100 flex justify-between items-center h-10 px-3">
                                        <div className="text-[0.75rem] text-indigo-500 font-bold">{t.prio_subtitle}</div>
                                        <div className="text-right text-[0.75rem]">
                                            <span className="block text-green-600 font-bold">{t.prio_rem_univ} {priorityQueueAnalysis.length > 0 ? (priorityQueueAnalysis[priorityQueueAnalysis.length - 1].remainingUnivPool || 0).toLocaleString() : (calculation.grandTotalUniv || 0).toLocaleString()}</span>
                                        </div>
                                    </div>

                                    <div className="flex h-full min-h-[18.75rem] max-h-[18.75rem]">
                                        {/* Control Panel (Fixed Left Sidebar) */}
                                        <div className="w-14 bg-gray-50 border-r border-indigo-100 flex flex-col items-center justify-center gap-3 p-1 flex-shrink-0">
                                            <button className="ctrl-btn up" onClick={handleMoveUp} disabled={selectedQueueIndex === null || selectedQueueIndex === 0}>‚ñ≤</button>
                                            <button className="ctrl-btn down" onClick={handleMoveDown} disabled={selectedQueueIndex === null || selectedQueueIndex === cartQueue.length - 1}>‚ñº</button>
                                            <div className="h-4"></div>
                                            <button className="ctrl-btn del" onClick={handleDeleteItem} title={lang === 'zh' ? 'Âà™Èô§ÈÅ∏‰∏≠È†Ö' : 'Delete selected'} disabled={selectedQueueIndex === null}>üóëÔ∏è</button>
                                            <button className="ctrl-btn del !text-red-400 !bg-red-50 !border-red-100 mt-2" onClick={clearAllQueue} title={t.btn_clear_all}>ALL</button>
                                        </div>

                                        {/* List Area */}
                                        <div className="flex-grow overflow-y-auto p-0">
                                            {priorityQueueAnalysis.length === 0 ? (
                                                <div className="text-center py-8 text-gray-400 text-sm m-4 border-2 border-dashed border-gray-100 rounded-lg">
                                                    {t.prio_empty}
                                                </div>
                                            ) : (
                                                <table className="w-full text-sm">
                                                    <thead>
                                                        <tr className="text-gray-500 text-[0.75rem] border-b border-gray-100 bg-white sticky top-0 z-10 shadow-sm">
                                                            <th className="py-2 pl-3 text-left">{t.prio_header_item}</th>
                                                            <th className="py-2 text-left">{t.prio_header_calc}</th>
                                                            <th className="py-2 pr-2 text-right w-28">{t.prio_header_status}</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {priorityQueueAnalysis.map((item, index) => (
                                                            <tr
                                                                key={item.uid}
                                                                onClick={() => handleQueueItemClick(index)}
                                                                className={`border-b border-gray-50 queue-item ${selectedQueueIndex === index ? 'selected' : ''}`}
                                                            >
                                                                <td className="py-3 pl-3">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className={`inline-block w-1.5 h-8 rounded-sm ${getAttrBg(item.category)}`}></span>
                                                                        <div>
                                                                            <div className={`font-bold ${getAttrColorText(item.category)}`}>{getAttrLabel(item.category)} {item.name}</div>
                                                                            <div className="text-[0.625rem] text-gray-400">{item.cost}</div>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td className="py-3">
                                                                    <div className="flex flex-col gap-1 text-[0.625rem] md:text-[0.75rem]">
                                                                        {item.stockUsed > 0 && (
                                                                            <div className="flex items-center gap-1 text-gray-600">
                                                                                <span className="w-1.5 h-1.5 rounded-full bg-blue-400"></span>
                                                                                <span>{t.prio_stock_used}: {item.stockUsed} (= {item.stockUsed} x 1.0)</span>
                                                                            </div>
                                                                        )}
                                                                        {/* Fixed Maps Income Display */}
                                                                        {item.futureFixedUsed > 0 && (
                                                                            <div className="flex items-center gap-1 text-purple-600 font-bold">
                                                                                <span className="w-1.5 h-1.5 rounded-full bg-purple-500"></span>
                                                                                <span>{lang === 'zh' ? 'È†êË®àÁç≤Âæó: ÊàêÂìÅÂúñ' : 'Future: Map Drops'}: {item.futureFixedUsed} (= {item.futureFixedUsed} x 1.0)</span>
                                                                            </div>
                                                                        )}
                                                                        {item.futureAttrUsed > 0 && item.choiceToUnivUsed === 0 && (
                                                                            <div className="flex items-center gap-1 text-orange-600 font-medium">
                                                                                <span className="w-1.5 h-1.5 rounded-full bg-orange-400"></span>
                                                                                <span>{t.prio_future_attr}: {item.futureAttrUsed} (= {item.futureAttrUsed} x 1.0)</span>
                                                                            </div>
                                                                        )}
                                                                        {item.univStockUsed > 0 && (
                                                                            <div className="flex items-center gap-1 text-green-700">
                                                                                <span className="w-1.5 h-1.5 rounded-full bg-green-600"></span>
                                                                                <span>{t.prio_univ_stock}: {item.univStockUsed} (= {item.univStockUsed} x 1.0)</span>
                                                                            </div>
                                                                        )}
                                                                        {item.futureUnivRewardUsed > 0 && (
                                                                            <div className="flex items-center gap-1 text-green-600">
                                                                                <span className="w-1.5 h-1.5 rounded-full bg-green-400"></span>
                                                                                <span>{t.prio_univ_reward}: {item.futureUnivRewardUsed} (= {item.futureUnivRewardUsed} x 1.0)</span>
                                                                            </div>
                                                                        )}
                                                                        {item.choiceToUnivUsed > 0 && (
                                                                            <div className="flex items-center gap-1 text-teal-600 font-medium">
                                                                                <span className="w-1.5 h-1.5 rounded-full bg-teal-400"></span>
                                                                                <span>{t.prio_univ_reward}: {item.choiceToUnivUsed} (= {item.choiceRawConsumed} È†êË®àÂ±¨ÊÄß / 2)</span>
                                                                            </div>
                                                                        )}
                                                                        {item.attrConverted > 0 && (
                                                                            <div className="flex items-center gap-1 text-indigo-600">
                                                                                <span className="w-1.5 h-1.5 rounded-full bg-indigo-500"></span>
                                                                                <span>{t.prio_conv_used}: {item.attrConverted}U (= {item.attrConsumed} Â±¨ÊÄß / 2)</span>
                                                                            </div>
                                                                        )}
                                                                        {item.gap > 0 && (
                                                                            <div className="flex items-center gap-1 text-red-600 font-bold">
                                                                                <span className="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                                                                                <span>{t.prio_gap}: {item.gap}</span>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </td>
                                                                <td className="py-3 pr-2 text-right align-top">
                                                                    <div className="flex flex-col items-end gap-1">
                                                                        {item.status === 'stock' && (
                                                                            <span className="inline-block bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded text-[0.625rem] font-bold border border-blue-100 whitespace-nowrap">
                                                                                {t.prio_status_stock}
                                                                            </span>
                                                                        )}
                                                                        {item.status === 'univ' && (
                                                                            <span className="inline-block bg-green-50 text-green-700 px-1.5 py-0.5 rounded text-[0.625rem] font-bold border border-green-100 whitespace-nowrap">
                                                                                {t.prio_status_univ}
                                                                            </span>
                                                                        )}
                                                                        {item.status === 'convert' && (
                                                                            <span className="inline-block bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded text-[0.625rem] font-bold border border-indigo-100 whitespace-nowrap">
                                                                                {t.prio_status_convert}
                                                                            </span>
                                                                        )}
                                                                        {item.status === 'gap' && (
                                                                            <>
                                                                                <span className="inline-block bg-red-50 text-red-700 px-1.5 py-0.5 rounded text-[0.625rem] font-bold border border-red-100 whitespace-nowrap">
                                                                                    {t.prio_status_gap}
                                                                                </span>
                                                                                {item.category !== 'univ' && (
                                                                                    <span className="text-[0.5625rem] text-red-500 font-bold animate-pulse whitespace-nowrap">
                                                                                        {t.prio_farm.replace('{attr}', getAttrLabel(item.category))}
                                                                                    </span>
                                                                                )}
                                                                            </>
                                                                        )}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Right: Summary Cards Stack */}
                                <div className="lg:col-span-3 flex flex-col gap-4">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border-2 border-indigo-50 flex-1 flex flex-col">
                                        <div className="text-indigo-900 font-bold text-[0.75rem] mb-4 flex items-center gap-2 border-b border-indigo-50 pb-2">
                                            <span>üìä</span> {lang === 'zh' ? 'È†ê‰º∞ÊÆòÊç≤Á∏ΩÈáè' : 'Est. Total Scrolls'}
                                        </div>

                                        <div className="space-y-4 flex-1 flex flex-col justify-center">
                                            <div className="bg-blue-50 p-2 rounded-lg border border-blue-100 flex flex-col items-center text-center">
                                                <div className="text-[0.9375rem] text-blue-600 font-bold mb-1 uppercase">{lang === 'zh' ? 'Â±¨ÊÄßÊç≤' : 'Attr'}</div>
                                                <div className="text-xl font-black text-blue-700">{calculation.grandTotalAttr.toLocaleString()}</div>
                                            </div>

                                            <div className="bg-green-50 p-2 rounded-lg border border-green-100 flex flex-col items-center text-center">
                                                <div className="text-[0.9375rem] text-green-600 font-bold mb-1 uppercase">{lang === 'zh' ? 'ÈÄöÁî®Êç≤' : 'Univ'}</div>
                                                <div className="text-xl font-black text-green-700">{calculation.grandTotalUniv.toLocaleString()}</div>
                                            </div>
                                        </div>

                                        <div className="mt-6 text-[0.5rem] text-gray-400 italic text-center leading-tight">
                                            {lang === 'zh' ? 'ÈöäÂàóÂ∑≤ËÄÉÊÖÆÊú™‰æÜÊî∂Áõä' : 'Queue includes future'}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Middle: Attributes */}
                            <div className="grid grid-cols-2 md:grid-cols-5 gap-2 mb-4">
                                <AttrDashboardCard label={t.attr_wind} textColor="color-wind" bgColorClass="bg-wind-light" inv={parseInt(inventory.attrWind) || 0} cost={calculation.shopCostWind} />
                                <AttrDashboardCard label={t.attr_thunder} textColor="color-thunder" bgColorClass="bg-thunder-light" inv={parseInt(inventory.attrThunder) || 0} cost={calculation.shopCostThunder} />
                                <AttrDashboardCard label={t.attr_water} textColor="color-water" bgColorClass="bg-water-light" inv={parseInt(inventory.attrWater) || 0} cost={calculation.shopCostWater} />
                                <AttrDashboardCard label={t.attr_fire} textColor="color-fire" bgColorClass="bg-fire-light" inv={parseInt(inventory.attrFire) || 0} cost={calculation.shopCostFire} />
                                <AttrDashboardCard label={t.attr_univ} textColor="color-univ" bgColorClass="bg-univ-light" inv={parseInt(inventory.univScrolls) || 0} cost={calculation.shopCostUniv} />
                            </div>

                            {/* Bottom: Shop Items */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2">
                                {['wind', 'thunder', 'water', 'fire'].map(element => {
                                    const labels = { fire: t.attr_fire, water: t.attr_water, wind: t.attr_wind, thunder: t.attr_thunder };
                                    const textColor = { fire: 'color-fire', water: 'color-water', wind: 'color-wind', thunder: 'color-thunder' };
                                    const borderColor = { fire: 'border-fire', water: 'border-water', wind: 'border-wind', thunder: 'border-thunder' };
                                    const bgColorClass = { fire: 'bg-fire-light', water: 'bg-water-light', wind: 'bg-wind-light', thunder: 'bg-thunder-light' };

                                    return (
                                        <div key={element} className={`border rounded p-2 shadow-sm ${bgColorClass[element]}`}>
                                            <div className={`font-bold mb-1 text-center border-b pb-1 ${textColor[element]} ${borderColor[element]} flex justify-between items-center text-[0.75rem]`}>
                                                <span>{labels[element]}Â±¨ÊÄß</span>
                                                <button onClick={() => clearShopCategory(element)} className="text-[0.625rem] bg-white border border-gray-300 rounded px-1 hover:bg-gray-100" title={t.btn_clear}>{t.btn_clear.split(' ')[0]}</button>
                                            </div>
                                            <div className="space-y-1">
                                                {ATTR_SHOP_ITEMS.map(item => (
                                                    <ShopItem key={item.id} item={item} category={element} color={textColor[element]} />
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                                <div className="border rounded p-2 shadow-sm bg-univ-light">
                                    <div className="font-bold mb-1 text-center border-b pb-1 text-green-600 border-green-200 flex justify-between items-center text-[0.75rem]">
                                        <span>{t.attr_univ}</span>
                                        <button onClick={() => clearShopCategory('univ')} className="text-[0.625rem] bg-white border border-gray-300 rounded px-1 hover:bg-gray-100" title={t.btn_clear}>{t.btn_clear.split(' ')[0]}</button>
                                    </div>
                                    <div className="space-y-1">
                                        {UNIV_SHOP_ITEMS.map(item => (
                                            <ShopItem key={item.id} item={item} category="univ" color="text-green-600" />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 4: ÊØèÊó•Áç≤ÂèñÊòéÁ¥∞ */}
                    {(viewMode === 'single' || activeTab === 'daily') && (
                        <div className={`card p-4 border-t-4 border-teal-500 overflow-x-auto mx-1 ${viewMode === 'tabs' ? 'mb-6' : 'mb-6'}`}>
                            <table className="w-full min-w-[700px]">
                                <thead>
                                    <tr>
                                        <th className="w-16 text-[0.75rem]">{t.th_day}</th>
                                        <th className="w-32 text-[0.75rem]">{t.th_date}</th>
                                        <th className="text-[0.75rem]">{t.th_gain}</th>
                                        <th className="text-[0.75rem]">{t.th_acc}</th>
                                        <th className="text-[0.75rem]">{t.th_frag}</th>
                                        <th className="text-[0.75rem]">{t.th_note}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {dailyTable.map((row) => (
                                        <tr key={row.day} className={row.date.startsWith(currentDateInput.slice(5)) ? "bg-blue-100 border-l-4 border-blue-500" : ""}>
                                            <td className="font-medium text-gray-600 text-[0.75rem]">{row.day}</td>
                                            <td className="text-[0.75rem]">{row.date}</td>
                                            <td className="text-[0.75rem] text-gray-600">{row.dayAttr} / {row.dayUniv} / <span className="text-yellow-600 font-bold">{row.dayRandom}</span></td>
                                            <td className="text-[0.75rem]"><span className="text-blue-600 font-bold">{row.accAttr}</span> / <span className="text-green-600 font-bold">{row.accUniv}</span></td>
                                            <td className="text-[0.75rem]"><span className="text-yellow-800 font-bold bg-yellow-100 px-2 py-1 rounded">{row.accRandom}</span></td>
                                            <td className="text-[0.625rem] text-gray-500">{row.notes.map((note, idx) => (<span key={idx} className={note.style}>{idx > 0 && ", "}{note.text}</span>))}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {(viewMode === 'single' || activeTab === 'sources') && (
                        <div className={`card p-4 border-t-4 border-yellow-500 mx-1 ${viewMode === 'tabs' ? '' : ''}`}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="border rounded-lg p-3 bg-yellow-50 border-yellow-200">
                                    <h3 className="font-bold text-yellow-800 mb-2 border-b border-yellow-300 pb-1">{t.src_fixed_title}</h3>
                                    <ul className="space-y-1.5 text-[0.75rem]">
                                        <li className="flex justify-between items-center"><span className="text-red-700 font-bold">{t.qual_god}</span><span className="bg-white px-2 py-0.5 rounded-full text-red-600 font-bold shadow-sm">4 {t.unit_frag}</span></li>
                                        <li className="flex justify-between items-center"><span className="text-purple-700 font-bold">{t.qual_peerless}</span><span className="bg-white px-2 py-0.5 rounded-full text-purple-600 font-bold shadow-sm">5 {t.unit_frag}</span></li>
                                        <li className="flex justify-between items-center"><span className="text-indigo-700 font-bold">{t.qual_rare}</span><span className="bg-white px-2 py-0.5 rounded-full text-indigo-600 font-bold shadow-sm">9 {t.unit_frag}</span></li>
                                        <li className="flex justify-between items-center"><span className="text-green-700 font-bold">{t.qual_common}</span><span className="bg-white px-2 py-0.5 rounded-full text-green-600 font-bold shadow-sm">8 {t.unit_frag}</span></li>
                                        <li className="flex justify-between items-center"><span className="text-yellow-700 font-bold">{t.qual_random}</span><span className="bg-white px-2 py-0.5 rounded-full text-yellow-600 font-bold shadow-sm">20 {t.unit_frag}</span></li>
                                        <li className="flex justify-between items-center border-t border-yellow-200 pt-1.5 mt-1.5">
                                            <span className="text-orange-700 font-bold">‚ú® {lang === 'zh' ? 'Â¶ôÊâã‰∏πÈùí' : 'Art Event'}</span>
                                            <span className="bg-white px-2 py-0.5 rounded-full text-orange-600 font-bold shadow-sm">{t.src_art_reward}</span>
                                        </li>
                                    </ul>
                                </div>
                                <div className="space-y-4">
                                    <div className="border rounded-lg p-3 bg-blue-50 border-blue-200">
                                        <h3 className="font-bold text-blue-800 mb-2 border-b border-blue-300 pb-1">{t.src_weekly_title}</h3>
                                        <div className="space-y-2 text-[0.75rem]">
                                            <div><div className="text-[0.625rem] font-bold text-gray-700 mb-1">{t.src_weekly_sub}</div><div className="flex justify-between items-center bg-white p-1 rounded border border-blue-100"><span className="text-red-600 font-bold">{t.qual_god}</span><span className="font-bold">3 {t.unit_frag} {t.unit_week}</span></div></div>
                                            <div><div className="text-[0.625rem] font-bold text-gray-700 mb-1">{t.src_daily_sub}</div><div className="flex justify-between items-center bg-white p-1 rounded border border-blue-100"><span className="text-yellow-600 font-bold">{t.qual_random}</span><span className="font-bold">19 {t.unit_frag} {t.unit_day}</span></div><div className="text-[0.6875rem] text-orange-600 font-bold mt-1 text-right italic">{t.src_daily_note}</div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* New Rewards Reference Section */}
                            <div className="mt-4 border rounded-lg p-3 bg-indigo-50 border-indigo-200">
                                <h3 className="font-bold text-indigo-800 mb-2 border-b border-indigo-300 pb-1">{t.src_rewards_title}</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-[0.75rem] text-left">
                                        <thead className="bg-indigo-100 text-indigo-900">
                                            <tr>
                                                <th className="p-1">{t.reward_header_qual}</th>
                                                <th className="p-1">{t.reward_header_role}</th>
                                                <th className="p-1 text-right">{t.reward_header_attr}</th>
                                                <th className="p-1 text-right">{t.reward_header_univ}</th>
                                                <th className="p-1 text-right">{t.reward_header_refund}</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-indigo-100">
                                            {/* God */}
                                            <tr className="bg-blue-100/50"><td className="p-1.5 font-bold text-red-700 italic">{t.qual_god}</td><td className="p-1.5 font-bold">{t.role_capt}</td><td className="p-1.5 text-right text-blue-600 font-bold">30</td><td className="p-1.5 text-right text-green-600 font-bold">40</td><td className="p-1.5 text-right">-</td></tr>
                                            <tr className="bg-white"><td className="p-1.5"></td><td className="p-1.5 text-gray-500">{t.role_memb}</td><td className="p-1.5 text-right text-blue-500">15</td><td className="p-1.5 text-right text-green-500">20</td><td className="p-1.5 text-right">-</td></tr>
                                            {/* Peerless */}
                                            <tr className="bg-blue-100/50"><td className="p-1.5 font-bold text-purple-700 italic">{t.qual_peerless}</td><td className="p-1.5 font-bold">{t.role_capt}</td><td className="p-1.5 text-right text-blue-600 font-bold">16</td><td className="p-1.5 text-right text-green-600 font-bold">20</td><td className="p-1.5 text-right font-bold text-purple-600">1</td></tr>
                                            <tr className="bg-white"><td className="p-1.5"></td><td className="p-1.5 text-gray-500">{t.role_memb}</td><td className="p-1.5 text-right text-blue-500">8</td><td className="p-1.5 text-right text-green-500">10</td><td className="p-1.5 text-right">-</td></tr>
                                            {/* Rare */}
                                            <tr className="bg-blue-100/50"><td className="p-1.5 font-bold text-indigo-700 italic">{t.qual_rare}</td><td className="p-1.5 font-bold">{t.role_capt}</td><td className="p-1.5 text-right text-blue-600 font-bold">8</td><td className="p-1.5 text-right text-green-600 font-bold">10</td><td className="p-1.5 text-right font-bold text-indigo-600">1</td></tr>
                                            <tr className="bg-white"><td className="p-1.5"></td><td className="p-1.5 text-gray-500">{t.role_memb}</td><td className="p-1.5 text-right text-blue-500">4</td><td className="p-1.5 text-right text-green-500">5</td><td className="p-1.5 text-right">-</td></tr>
                                            {/* Common */}
                                            <tr className="bg-blue-100/50"><td className="p-1.5 font-bold text-green-700 italic">{t.qual_common}</td><td className="p-1.5 font-bold">{t.role_capt}</td><td className="p-1.5 text-right text-blue-600 font-bold">4</td><td className="p-1.5 text-right text-green-600 font-bold">5</td><td className="p-1.5 text-right font-bold text-green-600">1</td></tr>
                                            <tr className="bg-white"><td className="p-1.5"></td><td className="p-1.5 text-gray-500">{t.role_memb}</td><td className="p-1.5 text-right text-blue-500">2</td><td className="p-1.5 text-right text-green-500">3</td><td className="p-1.5 text-right">-</td></tr>
                                            {/* Legend */}
                                            <tr className="bg-blue-100/50"><td className="p-1.5 font-bold text-purple-900 italic">{t.qual_legend}</td><td className="p-1.5 font-bold">{t.role_capt}</td><td className="p-1.5 text-right text-blue-600 font-bold">-</td><td className="p-1.5 text-right text-green-600 font-bold">150</td><td className="p-1.5 text-right">-</td></tr>
                                            <tr className="bg-white"><td className="p-1.5"></td><td className="p-1.5 text-gray-500">{t.role_memb}</td><td className="p-1.5 text-right text-blue-500">-</td><td className="p-1.5 text-right text-green-500">75</td><td className="p-1.5 text-right">-</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* Floating Zoom Console - Fixed Units to Prevent Jumping */}
                    <div style={{
                        position: 'fixed',
                        bottom: '20px',
                        right: '20px',
                        zIndex: 9999,
                        display: 'flex',
                        alignItems: 'center',
                        backgroundColor: 'white',
                        padding: '4px 8px',
                        borderRadius: '999px',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                        border: '1px solid #e0e7ff',
                        gap: '6px',
                        height: '36px'
                    }}>
                        <button
                            onClick={() => setZoomLevel(prev => Math.max(50, prev - 10))}
                            style={{ width: '28px', height: '28px', border: 'none', background: '#f5f7ff', color: '#4f46e5', fontWeight: 'bold', fontSize: '16px', borderRadius: '50%', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                        >-</button>
                        <button
                            onClick={() => setZoomLevel(100)}
                            style={{ border: 'none', background: 'transparent', color: '#6366f1', fontSize: '12px', fontWeight: '900', cursor: 'pointer', padding: '0 4px', fontFormat: 'monospace' }}
                        >{zoomLevel}%</button>
                        <button
                            onClick={() => setZoomLevel(prev => Math.min(250, prev + 10))}
                            style={{ width: '28px', height: '28px', border: 'none', background: '#f5f7ff', color: '#4f46e5', fontWeight: 'bold', fontSize: '16px', borderRadius: '50%', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                        >+</button>
                    </div>
                </div>
            );
            // #endregion
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>