<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ËóèÂØ∂ÂúñÊÆòÊç≤„ÄÅÁ¢éÁâáË®àÁÆóÊ©ü | Treasure Map Calculator</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* #region CSS Styles */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation;
            font-size: 17px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Ëº∏ÂÖ•Ê°ÜÊ®£Âºè */
        .input-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 0.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .input-group input[type="date"] {
            width: 100%;
            max-width: 8.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.3rem;
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
            transition: border-color 0.15s;
            background-color: rgba(255, 255, 255, 0.8);
        }

        .input-group input[type="number"] {
            width: 100%;
            max-width: 5.625rem;
            border: 1px solid #d1d5db;
            border-radius: 0.3rem;
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
            transition: border-color 0.15s;
            background-color: rgba(255, 255, 255, 0.8);
        }

        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #93c5fd;
            background-color: white;
        }


        th,
        td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.5rem;
            border-left: 4px solid #3b82f6;
            padding-left: 0.5rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-top: 0.1rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* ÂïÜÂ∫óÊ®£Âºè */
        .shop-counter {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.8);
            padding: 0.2rem 0.3rem;
            border-radius: 0.25rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.25rem;
        }

        .shop-counter button {
            width: 1.125rem;
            height: 1.125rem;
            border-radius: 3px;
            background: #e5e7eb;
            color: #374151;
            font-weight: bold;
            line-height: 1;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .shop-counter button:hover {
            background: #d1d5db;
        }

        .shop-counter button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .shop-item-cost-large {
            font-size: 0.8rem;
            font-weight: 700;
        }

        /* ÂàÜÈ†ÅÊåâÈàïÊ®£Âºè */
        .tabs-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 2px;
            -webkit-overflow-scrolling: touch;
        }

        .tabs-container::-webkit-scrollbar {
            height: 3px;
        }

        .tabs-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        /* Added flex-shrink-0 to prevent overlapping/squishing */
        .tab-btn {
            flex: 1;
            display: inline-block;
            padding: 0.5rem 0.4rem;
            text-align: center;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 70px;
            font-size: 0.8rem;
            flex-shrink: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (min-width: 640px) {
            .tab-btn {
                min-width: 90px;
                font-size: 0.95rem;
                padding: 0.6rem 1rem;
            }
        }

        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background-color: #eff6ff;
        }

        .tab-btn:hover:not(.active) {
            color: #374151;
            background-color: #f9fafb;
        }

        /* ÂÖßÂÆπÂçÄÂ°äÊç≤Ëª∏ */
        .tab-content-scroll {
            height: calc(100vh - 140px);
            overflow-y: auto;
            padding-right: 4px;
        }

        .tab-content-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .tab-content-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .tab-content-scroll::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .tab-content-scroll::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Ëá™ÂÆöÁæ©Â±¨ÊÄßÈ°èËâ≤ class */
        .color-fire {
            color: #FF2D2D;
        }

        .color-water {
            color: #00AEAE;
        }

        .color-wind {
            color: #4F9D9D;
        }

        .color-thunder {
            color: #4A4AFF;
        }

        .color-univ {
            color: #16a34a;
        }

        .border-fire {
            border-color: #FF2D2D;
        }

        .border-water {
            border-color: #00AEAE;
        }

        .border-wind {
            border-color: #4F9D9D;
        }

        .border-thunder {
            border-color: #4A4AFF;
        }

        .border-univ {
            border-color: #16a34a;
        }

        .bg-fire-light {
            background-color: #fff0f0;
        }

        .bg-water-light {
            background-color: #e0fafa;
        }

        .bg-wind-light {
            background-color: #eef9f9;
        }

        .bg-thunder-light {
            background-color: #efefff;
        }

        .bg-univ-light {
            background-color: #f0fdf4;
        }

        .text-fragment-custom {
            color: #9999CC;
        }

        .text-god {
            color: #b91c1c;
        }

        .text-peerless {
            color: #7e22ce;
        }

        .text-rare {
            color: #4338ca;
        }

        .text-common {
            color: #15803d;
        }

        .text-random {
            color: #a16207;
        }

        /* Help Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 600px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        /* Selection Styles */
        .queue-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .queue-item:hover:not(.selected) {
            background-color: #f9fafb;
        }

        .queue-item.selected {
            background-color: #eff6ff;
            border-left-color: #3b82f6;
        }

        /* Control Buttons */
        .ctrl-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.1s;
            background-color: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .ctrl-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .ctrl-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .ctrl-btn.up {
            color: #2563eb;
            background-color: #eff6ff;
            border-color: #bfdbfe;
        }

        .ctrl-btn.down {
            color: #2563eb;
            background-color: #eff6ff;
            border-color: #bfdbfe;
        }

        .ctrl-btn.del {
            color: #dc2626;
            background-color: #fef2f2;
            border-color: #fecaca;
        }

        /* #endregion */
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Â§öË™ûË®ÄË®≠ÂÆö ---
        // #region Â§öË™ûË®ÄË®≠ÂÆö (I18N)
        const I18N = {
            zh: {
                title: "ËóèÂØ∂ÂúñÊ¥ªÂãïÊî∂ÁõäË®àÁÆóÊ©ü",
                period: "Ê¥ªÂãïÊúüÈñì: 2026/01/21 ~ 2026/02/25",
                tab_main: "üìä Â∫´Â≠òËàáÊî∂ÁõäÁ∏ΩË¶Ω",
                tab_main_short: "üìä Â∫´Â≠ò",
                tab_shop: "üõí ÂïÜÂ∫óË¶èÂäÉ",
                tab_shop_short: "üõí ÂïÜÂ∫ó",
                tab_daily: "üìÖ ÊØèÊó•ÊòéÁ¥∞",
                tab_daily_short: "üìÖ ÊòéÁ¥∞",
                tab_sources: "üìú ‰æÜÊ∫êË™™Êòé",
                tab_sources_short: "üìú ‰æÜÊ∫ê",
                btn_help: "‚ùì Ë™™Êòé",
                btn_tabs: "üìë È†ÅÁ±§Âºè",
                btn_single: "üìú ‰∏ÄÈ†ÅÂºè",
                btn_clear: "üóëÔ∏è Ê∏ÖÈô§",
                lbl_date: "Áï∂ÂâçÊó•Êúü",
                lbl_remaining: "Ââ© {d} Â§© / {w} ÈÄ±",
                lbl_legend: "ÂÇ≥È†åËóèÂØ∂Âúñ (ÂêÑÈôê1Ê¨° - Ëã•Â∑≤Áç≤ÂæóË´ãÂãøÈÅ∏)",
                lbl_leg_captain: "ÈöäÈï∑(+150ÈÄö)",
                lbl_leg_member: "ÈöäÂì°(+75ÈÄö)",
                lbl_scrolls: "ÊåÅÊúâÊÆòÊç≤Â∫´Â≠ò (Â±¨ÊÄß)",
                lbl_maps: "ÊåÅÊúâÊàêÂìÅËóèÂØ∂Âúñ (‰∏çÂàÜÂ±¨ÊÄß)",
                lbl_frags: "ÊåÅÊúâÁ¢éÁâáÂ∫´Â≠ò",
                lbl_member_frag: "ÈöäÂì°ÊÆòÊç≤ (ÊØèÊó•ËàáÊØèÈÄ±)",
                lbl_leader_frag: "ÈöäÈï∑ÊÆòÊç≤ (ÊåÅÊúâÂúñÊî∂Áõä)",
                lbl_univ_frag: "ÈÄöÁî®ÊÆòÊç≤ (ÈÄöÁî®ËàáÂÇ≥È†å)",
                lbl_art_event: "Â¶ôÊâã‰∏πÈùí (Ëã•Â∑≤Áç≤ÂæóË´ãÂãøÈÅ∏)",
                art_count: "Áç≤ÂæóÊ¨°Êï∏", attr_fire: "ÁÅ´", attr_water: "Ê∞¥", attr_wind: "È¢®", attr_thunder: "Èõ∑", attr_univ: "ÈÄöÁî®",
                qual_god: "Á•ûÂìÅ", qual_peerless: "ÁµïÂìÅ", qual_rare: "ÁèçÂìÅ", qual_common: "Âá°ÂìÅ", qual_random: "Èö®Ê©ü",
                qual_legend: "ÂÇ≥È†å",

                sec_settings: "Ë®≠ÂÆöËàáÂ∫´Â≠ò",
                sec_income_title: "Ê¥ªÂãïÁµêÊùüÁ∏ΩÊî∂ÁõäÈ†ê‰º∞",
                sec_details_title: "ÊÆòÊç≤‰æÜÊ∫êË©≥ÊÉÖ",
                row_base: "Â∫´Â≠ò+Âõ∫ÂÆö",
                row_maps: "Â∫´Â≠òÊàêÂìÅ",
                row_conv: "Èö®Ê©üËΩâÂåñ",
                row_synth: "Á¢éÁâáÂêàÊàê",
                total_est: "Á∏ΩË®àÈ†ê‰º∞",
                exchange_ref: "üîÑ Â±¨ÊÄß2ÊèõÈÄöÁî®1 ÈÄöÁî®1ÊèõÂ±¨ÊÄß1",
                exchange_all_attr: "ÂÖ®ËΩâÊèõÔºöÂ±¨ÊÄß", // Updated Text
                exchange_all_univ: "ÂÖ®ËΩâÊèõÔºöÈÄöÁî®", // Updated Text

                prog_title: "Á¢éÁâáÂêàÊàêÈÄ≤Â∫¶Áõ§Èªû",
                prog_syn: "Âêà", prog_need: "Â∑Æ",

                sec_shop_title: "ÂÖåÊèõÂïÜÂ∫óË¶èÂäÉ",
                shop_desc: "Ë´ãÂãæÈÅ∏‰Ω†ÊÉ≥ÂÖåÊèõÁöÑÈ†ÖÁõÆ„ÄÇ",
                shop_conv_attr: "ÂÖ®ËΩâÂ±¨ÊÄßÊÆòÊç≤",
                shop_conv_univ: "ÂÖ®ËΩâÈÄöÁî®ÊÆòÊç≤",
                val_total: "Á∏ΩÂÉπÂÄº", req_total: "Á∏ΩÈúÄÊ±Ç", bal_total: "È§òÈ°ç",
                dtl_detail: "ÊòéÁ¥∞",
                card_supply: "‰æõÁµ¶", card_cost: "Ëä±Ë≤ª", card_bal: "ÁµêÈ§ò", card_inv: "Â∫´Â≠ò",

                sec_daily_title: "ÊØèÊó•Ë≥áÊ∫êÁç≤ÂèñÊòéÁ¥∞",
                th_day: "Day", th_date: "Êó•Êúü", th_gain: "Áï∂Êó•Áç≤Âæó (Â±¨/ÈÄö/Èö®Ê©ü)", th_acc: "Á¥ØÁ©ç Â±¨/ÈÄö", th_frag: "Á¥ØÁ©ç Èö®Ê©ü", th_note: "ÂÇôË®ª",
                note_weekly: "ÊØèÈÄ±Á•ûÂìÅ(+30Â±¨/+40ÈÄö)",
                note_fixed: "Ê¥ªÂãïÂõ∫ÂÆöÁçéÂãµ",
                note_leg: "ÂÇ≥È†å(+{v}ÈÄö)",

                sec_source_title: "üìú ÂÆòÊñπÁ¢éÁâáÁç≤Âèñ‰æÜÊ∫êË™™Êòé",
                src_fixed_title: "üéâ Ê¥ªÂãïÂÖ®Á®ãÂõ∫ÂÆö‰ªªÂãô (‰∏ÄÊ¨°ÊÄß)",
                src_weekly_title: "üìÖ ÈÄ±ÊúüÊÄß‰ªªÂãô",
                src_weekly_sub: "ÊØèÈÄ±‰ªªÂãô (ÈÄ±Êó•ÈáçÁΩÆ)",
                src_daily_sub: "ÊØèÊó•Áç≤Âèñ (Èö®Ê©ü+‰ªªÂãô)",
                src_daily_note: "(ÊØèÊó•Èö®Ê©ü 15 + ÊØèÊó•‰ªªÂãô 4)",
                src_art_reward: "ÂèØÈÅ∏ 0~25 Èö®Ê©üÁ¢éÁâá",
                unit_frag: "Áâá", unit_week: "ÈÄ±", unit_day: "Â§©",

                src_rewards_title: "üéÅ ËóèÂØ∂ÂúñË®é‰ºêÁçéÂãµÂ∞çÁÖßË°®",
                reward_header_qual: "ÂìÅË≥™", reward_header_role: "Ë∫´ÂàÜ", reward_header_attr: "Â±¨ÊÄßÊç≤", reward_header_univ: "ÈÄöÁî®Êç≤", reward_header_refund: "ËøîÈÇÑ",
                role_capt: "ÈöäÈï∑", role_memb: "ÈöäÂì°",

                help_title: "‰ΩøÁî®ÊåáÂçó",
                help_p1: "Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂ∫´Â≠òÔºàÂê´ÊàêÂìÅÂúñÂ±¨ÊÄßÔºâËàáÁ¢éÁâáÔºåÁ≥ªÁµ±Â∞áËá™ÂãïË®àÁÆóÊú™‰æÜÁ∏ΩÊî∂ÁõäËàáÂïÜÂ∫óË¶èÂäÉ„ÄÇ",
                help_h1: "1. Ë≥ºË≤∑ÂäõÂà§Êñ∑ (ÁèæÂú® vs Êú™‰æÜ)",
                help_p2: "„ÄåÂÖåÊèõÂïÜÂ∫óË¶èÂäÉ„ÄçÊé°Áî®Â§öÈáçÂà§Êñ∑Ê©üÂà∂Ôºö",
                help_li1: "‚óè **ÁèæÂú®**ÔºöÂÉÖË®àÁÆó„ÄåÁèæÊúâÂ∫´Â≠ò„Äç„ÄÇÈ°ØÁ§∫ÁÇ∫Ë≤†Êï∏‰ª£Ë°®ÊÇ®ÁèæÈáë‰∏çË∂≥„ÄÇ",
                help_li2: "‚óè **Êú™‰æÜ**ÔºöÂÑ™ÂÖà‰ΩøÁî®„ÄåÊåÅÊúâÂ±¨ÊÄßÂúñ„ÄçÁî¢Âá∫ÁöÑÊÆòÊç≤ÔºåÂÜçË®àÁÆóÈÄöÁî®/Èö®Ê©üÊî∂Áõä„ÄÇ",
                help_h2: "2. Á¢éÁâáÂêàÊàêÈÅûËø¥ÈÇèËºØ",
                help_p3: "Êú¨Â∑•ÂÖ∑Ê®°Êì¨‰∫Ü„ÄåË®é‰ºêÁµï/Áèç/Âá°ÂìÅÂúñÂæåÈÄÄÈÇÑ 1 ÁâáÁ¢éÁâá„ÄçÁöÑË¶èÂâáÔºö",
                help_li3: "Áï∂ÊÇ®Ëº∏ÂÖ• 10 ÁâáÊôÇÔºåÈÄ≤Â∫¶ÊúÉÈ°ØÁ§∫„ÄåÂêà 1 / Â∑Æ 9„ÄçÔºåÂõ†ÁÇ∫Á≥ªÁµ±È†êÁü•ÊÇ®ÊâìÂÆåÂæåÊúÉÂâ© 1 Áâá„ÄÇ",
                help_h3: "3. ÂïÜÂ∫óÂÖåÊèõË®àÁÆóÈÇèËºØ (ÈáçË¶ÅÔºÅ)",
                help_p4: "ÂïÜÂìÅÊåâÂÑ™ÂÖàÈ†ÜÂ∫è‰æùÂ∫èËôïÁêÜÔºåÊØèÂÄãÂïÜÂìÅ‰æùÁÖß‰ª•‰∏ãÊ≠•È©ü‰ΩøÁî®Ë≥áÊ∫êÔºö",
                help_li4: "‚óè **Ê≠•È©ü1**ÔºöÁèæÊúâÂêåÂ±¨ÊÄßÂ∫´Â≠ò (1:1)",
                help_li5: "‚óè **Ê≠•È©ü2**ÔºöÊú™‰æÜÁç≤ÂèñÂêåÂ±¨ÊÄß (1:1ÔºåÂÑ™ÂÖàÁµ¶Á¨¨‰∏ÄÂÄãÂ±¨ÊÄßÂïÜÂìÅ)",
                help_li6: "‚óè **Ê≠•È©ü3**ÔºöÁèæÊúâ„Äå‰∏çÂú®ÂïÜÂìÅÊ¨Ñ„ÄçÁöÑÂ±¨ÊÄß (2:1ËΩâÊèõ)",
                help_li7: "‚óè **Ê≠•È©ü4**ÔºöÁèæÊúâ„ÄåÂïÜÂìÅÊ¨ÑË£°ÊúÄ‰ΩéÂÑ™ÂÖàÊ¨ä„ÄçÁöÑÂ±¨ÊÄß (2:1ËΩâÊèõ)",
                help_li8: "‚óè **Ê≠•È©ü5**ÔºöÊú™‰æÜÁç≤ÂèñÁöÑÂ±¨ÊÄßÊÆòÂç∑ (2:1ËΩâÊèõ)",
                help_p5: "**ÈáçË¶ÅÊèêÁ§∫**ÔºöÂâçÈù¢ÁöÑÂïÜÂìÅÊúÉÂÑ™ÂÖà‰ΩøÁî®ÊâÄÊúâÂèØÁî®Ë≥áÊ∫êÔºåÂæåÈù¢ÁöÑÂïÜÂìÅÂè™ËÉΩ‰ΩøÁî®Ââ©È§òË≥áÊ∫ê„ÄÇÊñ∞Â¢ûÂïÜÂìÅ‰∏çÊúÉÂΩ±ÈüøÂâçÈù¢ÂïÜÂìÅÁöÑË®àÁÆóÁµêÊûú„ÄÇÊÇ®ÂèØ‰ª•ÈÄèÈÅéË™øÊï¥ÂïÜÂìÅÈ†ÜÂ∫è‰æÜÂÑ™ÂåñË≥áÊ∫êÂàÜÈÖç„ÄÇ",
                help_h4: "4. Á∏ÆÊîæËàá‰æøÊç∑Êìç‰Ωú",
                help_p6: "‚óè **Á∏ÆÊîæÊìç‰Ωú**ÔºöÊÇ®ÂèØ‰ª•ÈªûÊìäÂè≥‰∏ãËßíÁöÑ [+] Êàñ [-] ÈÄ≤Ë°åÁ∏ÆÊîæÔºåÈªûÊìä‰∏≠Â§ÆÁôæÂàÜÊØîÂèØÈáçÁΩÆÁÇ∫ 100%„ÄÇ",
                help_p7: "‚óè **ÊãñÊãΩÊéíÂ∫è**ÔºöÂú®ÈõªËÖ¶‰∏äÔºåÊÇ®ÂèØ‰ª•Áõ¥Êé•ÊãñÊãΩÂïÜÂìÅÈöäÂàó‰æÜÂø´ÈÄüË™øÊï¥ÂÑ™ÂÖàÈ†ÜÂ∫è„ÄÇÊâãÊ©üË´ã‰ΩøÁî®‰∏ä‰∏ãÁÆ≠È†≠ÊåâÈàï„ÄÇ",
                help_p8: "‚óè **Êï∏ÊìöËá™Âãï‰øùÂ≠ò**ÔºöÊâÄÊúâËº∏ÂÖ•ÁöÑÊï∏ÊìöÊúÉËá™Âãï‰øùÂ≠òÂà∞ÁÄèË¶ΩÂô®Ôºå‰∏ãÊ¨°ÊâìÈñãÊôÇÊúÉËá™ÂãïËºâÂÖ•„ÄÇ",
                help_h5: "5. Âª∫Ë≠∞ÊØèÊó•‰ΩøÁî®ÊµÅÁ®ã",
                help_li4: "‚óè **Âø´Êç∑Èçµ**ÔºöÊîØÊè¥ `Ctrl` + `+`/`-` Á∏ÆÊîæÔºå‰ª•Âèä `Ctrl` + `0` ÈáçÁΩÆ„ÄÇ",
                help_h4: "4. Âª∫Ë≠∞ÊØèÊó•‰ΩøÁî®ÊµÅÁ®ã",
                help_s1: "ÊØèÊó•Êõ¥Êñ∞Â∫´Â≠ò (Â∫´Â≠òËàáÊî∂ÁõäÁ∏ΩË¶Ω)",
                help_d1: "Â°´ÂÖ•‰ªäÊó•ÊúÄÊñ∞ÁöÑÊÆòÊç≤„ÄÅÊàêÂìÅÂúñËàáÁ¢éÁâáÊï∏Èáè„ÄÇ",
                help_s2: "Êü•ÁúãÂêàÊàêÈÄ≤Â∫¶ (Â∫´Â≠òËàáÊî∂ÁõäÁ∏ΩË¶Ω Âè≥ÂÅ¥)",
                help_d2: "Ëã•È°ØÁ§∫ÂèØÂêàÊàêÔºå‰ª£Ë°®ÈÅäÊà≤ÂÖßÂèØ‰ª•ÂéªÂêàÊàê‰∏¶Ë®é‰ºê‰∫Ü„ÄÇ",
                help_s3: "ÂÑ™ÂÖàÈöäÂàóË¶èÂäÉ (ÂïÜÂ∫óË¶èÂäÉ)",
                help_d3: "Âä†ÂÖ•ÊÉ≥Ë≤∑ÁöÑÂïÜÂìÅÔºå‰∏¶ÈÄèÈÅé‰∏ä‰∏ãÊåâÈàïË™øÊï¥ÂÑ™ÂÖàÈ†ÜÂ∫èÔºàÈõªËÖ¶ÂèØÊãñÊãΩÔºâ„ÄÇÁ≥ªÁµ±ÊúÉ‰æùÂ∫èÊâ£Èô§Ë≥áÊ∫ê‰∏¶È°ØÁ§∫Áº∫Âè£„ÄÇ",
                btn_gotit: "ÊàëÁû≠Ëß£‰∫Ü",

                // Priority Logic
                prio_title: "üèÜ ÂãïÊÖãË≥ºÁâ©ÈöäÂàóËàáÁº∫Âè£ÂàÜÊûê",
                prio_subtitle: "Áî±‰∏äËÄå‰∏ã‰æùÂ∫èË®àÁÆóÔºåÈªûÈÅ∏È†ÖÁõÆÂæåÂèØÁßªÂãï/Âà™Èô§ÔºàÈõªËÖ¶ÂèØÊãñÊãΩÔºâ",
                prio_header_item: "ÂÖåÊèõÈ†ÖÁõÆ",
                prio_header_calc: "Êâ£Èô§‰æÜÊ∫ê",
                prio_header_status: "ÁãÄÊÖã",
                prio_empty: "Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑÔºåË´ãÂú®‰∏ãÊñπÈªûÈÅ∏ + Âä†ÂÖ•ÂïÜÂìÅ",
                prio_stock_used: "ÁèæÊúâÂ±¨ÊÄßÂ∫´Â≠ò",
                prio_future_attr: "È†êË®àÁç≤Âæó: Â±¨ÊÄßÊç≤",
                prio_future_univ: "È†êË®àÁç≤Âæó: ÈÄöÁî®Êç≤",
                prio_univ_stock: "ÁèæÊúâÈÄöÁî®Â∫´Â≠ò",
                prio_univ_reward: "È†êË®àÁç≤Âæó: ÈÄöÁî®Êç≤",
                prio_conv_used: "Â±¨ÊÄßËΩâÂåñ",
                btn_clear_all: "üóëÔ∏è ÂÖ®ÈÉ®Ê∏ÖÁ©∫",
                prio_gap: "Áº∫Âè£",
                prio_status_stock: "‚úÖ Â∫´Â≠òÂÖÖË∂≥",
                prio_status_univ: "üü¢ ÈÄöÁî®ÂÖåÊèõ",
                prio_status_convert: "üîµ Â±¨ÊÄßËΩâÂåñ",
                prio_status_gap: "üî¥ Ë≥áÊ∫ê‰∏çË∂≥",
                prio_farm: "Âª∫Ë≠∞ÔºöÂ∞àÊîª{attr}Âúñ",
                prio_rem_univ: "ÈÄöÁî®Ê±†Ââ©È§ò:",

                // New Labels
                sec_future_breakdown: "Êú™‰æÜÈ†êË®àÁç≤Áç≤ÂèñÊòéÁ¥∞ (Ââ©È§òÊ¨°Êï∏)",
                th_source: "‰æÜÊ∫ê",
                th_count: "Ââ©È§ò",
                th_attr: "Â±¨ÊÄßÊç≤",
                th_univ: "ÈÄöÁî®Êç≤",
                th_frag: "Á¢éÁâá",
                row_daily: "ÊØèÊó•ÈöäÂì°ÁçéÂãµ",
                row_weekly_divine: "ÊØèÈÄ±Á•ûÂìÅÁçéÂãµ",
                row_daily_frag: "Êó•Â∏∏Âèä‰ªªÂãôÁ¢éÁâá (1Áµï/2Áèç/3Âá°)",
                row_weekly_frag: "ÊØèÈÄ±Á•ûÂìÅÁ¢éÁâá (Á•û*3)",
                row_art_event: "Â¶ôÊâã‰∏πÈùí (Ëã•Â∑≤È†òÂèñË´ãÂãøËº∏ÂÖ•)",
            },
            en: {
                title: "Treasure Map Calculator",
                period: "Event Period: 2026/01/21 ~ 2026/02/25",
                tab_main: "Overview",
                tab_main_short: "üìä Home",
                tab_shop: "Shop Plan",
                tab_shop_short: "üõí Shop",
                tab_daily: "Daily Log",
                tab_daily_short: "üìÖ Daily",
                tab_sources: "Sources",
                tab_sources_short: "üìú Info",
                btn_help: "‚ùì Help",
                btn_tabs: "üìë Tabs",
                btn_single: "üìú Single",
                btn_clear: "üóëÔ∏è Clear",
                lbl_date: "Current Date",
                lbl_remaining: "{d} Days / {w} Weeks Left",
                lbl_legend: "Mythical Map (Limit 1 ea)",
                lbl_leg_captain: "Cpt(+150)",
                lbl_leg_member: "Mem(+75)",
                lbl_scrolls: "Scrolls Owned",
                lbl_maps: "Maps Owned",
                lbl_frags: "Fragments Owned",
                attr_fire: "Fire", attr_water: "Water", attr_wind: "Wind", attr_thunder: "Thndr", attr_univ: "Univ",
                qual_god: "Divine", qual_peerless: "Superior", qual_rare: "Epic", qual_common: "Common", qual_random: "Random",
                qual_legend: "Mythical",

                sec_settings: "Settings & Stock",
                sec_income_title: "Total Event Income Estimate",
                sec_details_title: "Scroll Sources Detail",
                row_base: "Stock+Fixed",
                row_maps: "Map Runs",
                row_conv: "Rdm Conv",
                row_synth: "Frag Synth",
                total_est: "Total Est.",
                exchange_ref: "üîÑ Final Exchange Ref (2:1)",
                exchange_all_attr: "All to Attr",
                exchange_all_univ: "All to Univ",

                prog_title: "Fragment Synthesis Progress",
                prog_syn: "Craft", prog_need: "Need",

                sec_shop_title: "Shop Planning",
                shop_desc: "Select items you want to exchange.",
                shop_conv_attr: "Convert All to Attribute",
                shop_conv_univ: "Convert All to Universal",
                val_total: "Value", req_total: "Cost", bal_total: "Bal.",
                dtl_detail: "Detail",
                card_supply: "Supply", card_cost: "Cost", card_bal: "Net", card_inv: "Stock",

                sec_daily_title: "Daily Resource Log",
                th_day: "Day", th_date: "Date", th_gain: "Gain (Attr/Univ/Rdm)", th_acc: "Acc A/U", th_frag: "Acc Rdm", th_note: "Note",
                note_weekly: "Weekly Divine(+30A/+40U)",
                note_fixed: "Event Fixed",
                note_leg: "Mythical(+{v}U)",

                sec_source_title: "üìú Fragment Source Reference",
                src_fixed_title: "üéâ Event Fixed Tasks (One-time)",
                src_weekly_title: "üìÖ Periodic Tasks",
                src_weekly_sub: "Weekly Tasks (Reset Sun)",
                src_daily_sub: "Daily (Random+Task)",
                src_daily_note: "(Daily Random 15 + Task 4)",
                src_art_reward: "Select 0-25 Random Frag",
                unit_frag: "pcs", unit_week: "/wk", unit_day: "/day",

                src_rewards_title: "üéÅ Map Rewards Table",
                reward_header_qual: "Quality", reward_header_role: "Role", reward_header_attr: "Attr Scrolls", reward_header_univ: "Univ Scrolls", reward_header_refund: "Refund",
                role_capt: "Captain", role_memb: "Member",

                help_title: "User Guide",
                help_p1: "Enter your stock (including map attributes) and fragments to calculate future income.",
                help_h1: "1. Purchasing Power (Now vs. Future)",
                help_p2: "Shop Planning uses multi-stage logic:",
                help_li1: "‚óè **Now**: Uses 'Current Stock Only'. Negative means unaffordable.",
                help_li2: "‚óè **Future**: Prioritizes specific scrolls from 'Owned Maps', then uses flexible income.",
                help_h2: "2. Recursive Synthesis",
                help_p3: "The tool simulates the '1-fragment refund after Superior/Epic/Common runs' rule:",
                help_li3: "Entering 10 fragments shows '1 Craft / 9 Needed' because 1 is returned after usage.",
                help_h3: "3. Shop Exchange Logic (Important!)",
                help_p4: "Items are processed in priority order. Each item uses resources in these steps:",
                help_li4: "‚óè **Step 1**: Current native stock (1:1 ratio)",
                help_li5: "‚óè **Step 2**: Future native income (1:1, priority to 1st attribute item)",
                help_li6: "‚óè **Step 3**: Current attributes NOT in cart (2:1 conversion)",
                help_li7: "‚óè **Step 4**: Lowest priority attributes IN cart (2:1 conversion)",
                help_li8: "‚óè **Step 5**: Future attribute income (2:1 conversion)",
                help_p5: "**Important**: Higher priority items use all available resources first. Later items only get remaining resources. Adding new items won't change previous items' calculations. Adjust item order to optimize resource allocation.",
                help_h4: "4. Zoom & Shortcuts",
                help_p6: "‚óè **Zoom Console**: Use [+] or [-] in the bottom right. Tap the percentage to reset to 100%.",
                help_p7: "‚óè **Drag to Reorder**: On desktop, drag items directly to adjust priority. On mobile, use arrow buttons.",
                help_p8: "‚óè **Auto-Save**: All input data is automatically saved to your browser and restored on next visit.",
                help_h5: "5. Daily Workflow",
                help_li4: "‚óè **Shortcuts**: Supports `Ctrl` + `+`/`-` zoom, and `Ctrl` + `0` to reset.",
                help_h5: "5. Recommended Routine",
                help_s1: "Daily Stock Update (Tab 1)",
                help_d1: "Fill in your latest scrolls, maps, and fragments.",
                help_s2: "Check Synthesis (Tab 1 Bottom Right)",
                help_d2: "If craftable, it means you can synthesize and raid in-game.",
                help_s3: "Plan Queue (Tab 2)",
                help_d3: "Add items and drag or use arrow buttons to prioritize. System drains resources sequentially.",
                btn_gotit: "Got it",

                // Priority Logic
                prio_title: "üèÜ Dynamic Shopping Queue",
                prio_subtitle: "Calculated sequentially. Click to select, use arrows to reorder (desktop: drag).",
                prio_header_item: "Item",
                prio_header_calc: "Source",
                prio_header_status: "Status",
                prio_empty: "Cart is empty. Add items below.",
                prio_stock_used: "Current Attr Stock",
                prio_future_attr: "Future: Attr Reward",
                prio_future_univ: "Future: Univ Reward",
                prio_univ_stock: "Current Univ Stock",
                prio_univ_reward: "Future: Univ Reward",
                prio_conv_used: "Attr Conversion",
                btn_clear_all: "üóëÔ∏è Clear All",
                prio_gap: "Gap",
                prio_status_stock: "‚úÖ Stock",
                prio_status_univ: "üü¢ Univ Used",
                prio_status_convert: "üîµ Attr Conv",
                prio_status_gap: "üî¥ Shortage",
                prio_farm: "Advice: Farm {attr}",
                prio_rem_univ: "Univ Rem:",

                // New Labels
                sec_future_breakdown: "Future Gain Breakdown (Rem. Counts)",
                th_source: "Source",
                th_count: "Rem.",
                th_attr: "Attr.",
                th_univ: "Univ.",
                th_frag: "Frag.",
                row_daily: "Daily Member",
                row_weekly_divine: "Weekly Divine",
                row_daily_frag: "Daily Random Frag",
                row_weekly_frag: "Weekly Divine Frag",
            }
        };
        // #endregion

        // --- Â∏∏Êï∏Ë®≠ÂÆö ---
        // #region Â∏∏Êï∏ËàáÈÖçÁΩÆ (Constants)
        const START_DATE = new Date("2026-01-21T12:00:00+08:00");
        const END_DATE = new Date("2026-02-25T00:00:00+08:00");

        const DAILY_MEMBER_REWARD = { attr: 22, univ: 29 };
        const WEEKLY_MEMBER_REWARD = { attr: 30, univ: 40 };
        const LEGEND_REWARD_MEMBER = { attr: 0, univ: 75 };
        const LEGEND_REWARD_CAPTAIN = { attr: 0, univ: 150 };

        const FRAG_SOURCES = {
            dailyRandom: 19, weeklyGod: 3, fixedGod: 4, fixedPeerless: 5, fixedRare: 9, fixedCommon: 8, fixedRandom: 20
        };

        const CAPTAIN_REWARDS = {
            god: { attr: 30, univ: 40, refundFrag: 0 },
            peerless: { attr: 16, univ: 20, refundFrag: 1 },
            rare: { attr: 8, univ: 10, refundFrag: 1 },
            common: { attr: 4, univ: 5, refundFrag: 1 }
        };

        const RANDOM_CONVERSION = { attr: 4, univ: 5, refundCommonFrag: 1, cost: 10 };
        const WEEKDAYS = ["(Êó•)", "(‰∏Ä)", "(‰∫å)", "(‰∏â)", "(Âõõ)", "(‰∫î)", "(ÂÖ≠)"];
        const APP_VERSION = "v3.20";
        const APP_AUTHOR = "Nikis Ray";

        // --- ÂïÜÂ∫óË®≠ÂÆö ---
        const ATTR_SHOP_ITEMS = [
            { id: 1, name: "I", cost: 1250 },
            { id: 2, name: "II", cost: 1000 },
            { id: 3, name: "III", cost: 750 },
            { id: 4, name: "IV", cost: 500 },
        ];
        const UNIV_SHOP_ITEMS = [
            { id: 1, name: "I", cost: 1500 },
            { id: 2, name: "II", cost: 1000 },
            { id: 3, name: "III", cost: 750 },
            { id: 4, name: "IV", cost: 500 },
        ];
        // #endregion

        function App() {
            // #region ÁãÄÊÖãÁÆ°ÁêÜ (State)
            const [activeTab, setActiveTab] = useState('main');
            const [viewMode, setViewMode] = useState('tabs');
            const [showHelp, setShowHelp] = useState(false);
            const [lang, setLang] = useState('zh');
            const [targetAttr, setTargetAttr] = useState('none');
            const [zoomLevel, setZoomLevel] = useState(() => {
                const saved = localStorage.getItem('treasure-zoom');
                return saved ? parseInt(saved) : 100;
            });

            useEffect(() => {
                document.documentElement.style.fontSize = `${zoomLevel}%`;
                localStorage.setItem('treasure-zoom', zoomLevel.toString());
            }, [zoomLevel]);

            // --- Êñ∞Â¢ûÔºöÂø´Êç∑ÈçµÊîØÊè¥ ---
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === '=' || e.key === '+') {
                            e.preventDefault();
                            setZoomLevel(prev => Math.min(250, prev + 10));
                        } else if (e.key === '-') {
                            e.preventDefault();
                            setZoomLevel(prev => Math.max(50, prev - 10));
                        } else if (e.key === '0') {
                            e.preventDefault();
                            setZoomLevel(100);
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            const t = I18N[lang];

            // #region ÁãÄÊÖãÂàùÂßãÂåñ - Âæû localStorage ËÆÄÂèñ
            const getInitialDate = () => {
                const saved = localStorage.getItem('treasure-date');
                if (saved) return saved;
                const now = new Date();
                if (now < START_DATE) return "2026-01-21";
                if (now > END_DATE) return "2026-02-25";
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };

            const getInitialInventory = () => {
                const saved = localStorage.getItem('treasure-inventory');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to parse inventory:', e);
                    }
                }
                return {
                    attrFire: 0, attrWater: 0, attrWind: 0, attrThunder: 0, univScrolls: 0,
                    godMaps: 0, peerlessMaps: 0, rareMaps: 0, commonMaps: 0,
                    godFrags: 0, peerlessFrags: 0, rareFrags: 0, commonFrags: 0, randomFrags: 0
                };
            };

            const getInitialLegendOptions = () => {
                const saved = localStorage.getItem('treasure-legend');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to parse legend options:', e);
                    }
                }
                return { includeMember: false, includeCaptain: false, artEventAmount: 0 };
            };

            const getInitialCartQueue = () => {
                const saved = localStorage.getItem('treasure-cart-queue');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to parse cart queue:', e);
                    }
                }
                return [];
            };

            const getInitialShopCart = () => {
                const saved = localStorage.getItem('treasure-shop-cart');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to parse shop cart:', e);
                    }
                }
                return { fire: {}, water: {}, wind: {}, thunder: {}, univ: {} };
            };

            const [currentDateInput, setCurrentDateInput] = useState(getInitialDate);
            const [inventory, setInventory] = useState(getInitialInventory);
            const [legendOptions, setLegendOptions] = useState(getInitialLegendOptions);
            const [cartQueue, setCartQueue] = useState(getInitialCartQueue);
            const [shopCart, setShopCart] = useState(getInitialShopCart);
            const [selectedQueueIndex, setSelectedQueueIndex] = useState(null);
            const [dateError, setDateError] = useState('');
            const [draggedIndex, setDraggedIndex] = useState(null);
            const [isMobile, setIsMobile] = useState(false);
            // #endregion

            // Ê™¢Ê∏¨ÊòØÂê¶ÁÇ∫ÁßªÂãïË®≠ÂÇô
            useEffect(() => {
                const checkMobile = () => {
                    setIsMobile(window.innerWidth < 768 || 'ontouchstart' in window);
                };
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);

            // #region Êï∏ÊìöÊåÅ‰πÖÂåñ - Ëá™Âãï‰øùÂ≠òÂà∞ localStorage
            useEffect(() => {
                localStorage.setItem('treasure-date', currentDateInput);
            }, [currentDateInput]);

            useEffect(() => {
                localStorage.setItem('treasure-inventory', JSON.stringify(inventory));
            }, [inventory]);

            useEffect(() => {
                localStorage.setItem('treasure-legend', JSON.stringify(legendOptions));
            }, [legendOptions]);

            useEffect(() => {
                localStorage.setItem('treasure-cart-queue', JSON.stringify(cartQueue));
            }, [cartQueue]);

            useEffect(() => {
                localStorage.setItem('treasure-shop-cart', JSON.stringify(shopCart));
            }, [shopCart]);
            // #endregion

            // --- ËºîÂä©ÂáΩÂºè ---
            // #region ËºîÂä©ÂáΩÂºè (Utils)
            const getDaysDiff = (start, end) => {
                const s = new Date(start); s.setHours(0, 0, 0, 0);
                const e = new Date(end); e.setHours(0, 0, 0, 0);
                return Math.max(0, Math.round((e - s) / (1000 * 60 * 60 * 24)));
            };

            const countSundays = (start, end) => {
                let count = 0;
                let d = new Date(start); d.setHours(12, 0, 0, 0);
                while (d < end) {
                    if (d.getDay() === 0) count++;
                    d.setDate(d.getDate() + 1);
                }
                return count;
            };
            // #endregion

            // --- ‰∏ªË¶ÅË®àÁÆó ---
            // #region Ê†∏ÂøÉË®àÁÆóÈÇèËºØ (Calculation)
            const calculation = useMemo(() => {
                const totalDays = 35;
                const totalWeeks = 6;
                const userDate = new Date(currentDateInput);
                const daysRemaining = Math.min(getDaysDiff(userDate, END_DATE), totalDays);
                let weeksRemaining = 0;
                if (userDate < END_DATE) {
                    weeksRemaining = countSundays(userDate, END_DATE);
                    if (weeksRemaining > totalWeeks) weeksRemaining = totalWeeks;
                }

                // ÊúâÊïàÊ¨°Êï∏Ë®àÁÆó
                const effDays = Math.max(0, daysRemaining - 1);
                const effWeeks = Math.max(0, weeksRemaining);

                // 1. ÈöäÂì°ÊÆòÊç≤ (Member Fragments)
                const memberIncomeAttr = (DAILY_MEMBER_REWARD.attr * effDays) + (WEEKLY_MEMBER_REWARD.attr * effWeeks);
                const memberIncomeUniv = (DAILY_MEMBER_REWARD.univ * effDays) + (WEEKLY_MEMBER_REWARD.univ * effWeeks);

                // 2. ÈöäÈï∑ÊÆòÊç≤ (Leader Fragments from Owned Maps)
                const getMapStats = (type, count) => ({
                    attr: count * CAPTAIN_REWARDS[type].attr,
                    univ: count * CAPTAIN_REWARDS[type].univ,
                    refund: count * CAPTAIN_REWARDS[type].refundFrag
                });

                const godReward = getMapStats('god', parseInt(inventory.godMaps || 0));
                const peerlessReward = getMapStats('peerless', parseInt(inventory.peerlessMaps || 0));
                const rareReward = getMapStats('rare', parseInt(inventory.rareMaps || 0));
                const commonReward = getMapStats('common', parseInt(inventory.commonMaps || 0));

                const leaderIncomeAttr = godReward.attr + peerlessReward.attr + rareReward.attr + commonReward.attr;
                const leaderIncomeUniv = godReward.univ + peerlessReward.univ + rareReward.univ + commonReward.univ;

                // 3. ÈÄöÁî®ÊÆòÊç≤ËàáÂÖ∂È§òÊî∂Áõä
                const legendUniv = (legendOptions.includeMember ? LEGEND_REWARD_MEMBER.univ : 0) +
                    (legendOptions.includeCaptain ? LEGEND_REWARD_CAPTAIN.univ : 0);
                const artEventFrags = (parseInt(legendOptions.artEventAmount) || 0);

                // Èö®Ê©üËΩâÂåñ
                const isStart = userDate <= START_DATE;
                const futureRandomFrags = (FRAG_SOURCES.dailyRandom * effDays) + (isStart ? FRAG_SOURCES.fixedRandom : 0) + artEventFrags;
                const totalRandomPool = parseInt(inventory.randomFrags || 0) + futureRandomFrags;
                const randomToMapsCount = Math.floor(totalRandomPool / 10);
                const convertedAttr = randomToMapsCount * RANDOM_CONVERSION.attr;
                const convertedUniv = randomToMapsCount * RANDOM_CONVERSION.univ;
                const refundedCommonFrags = randomToMapsCount * RANDOM_CONVERSION.refundCommonFrag;

                // Á¢éÁâáÂêàÊàêÊî∂Áõä
                const godRefund = 0; // Gods don't refund
                const peerlessRefund = parseInt(inventory.peerlessMaps || 0) * CAPTAIN_REWARDS.peerless.refundFrag;
                const rareRefund = parseInt(inventory.rareMaps || 0) * CAPTAIN_REWARDS.rare.refundFrag;
                const commonRefund = parseInt(inventory.commonMaps || 0) * CAPTAIN_REWARDS.common.refundFrag;

                const totalGodPool = parseInt(inventory.godFrags || 0) + ((FRAG_SOURCES.weeklyGod * effWeeks) + (isStart ? FRAG_SOURCES.fixedGod : 0));
                const totalPeerlessPool = parseInt(inventory.peerlessFrags || 0) + ((isStart ? FRAG_SOURCES.fixedPeerless : 0) + peerlessRefund + (effDays * 1));
                const totalRarePool = parseInt(inventory.rareFrags || 0) + ((isStart ? FRAG_SOURCES.fixedRare : 0) + rareRefund + (effDays * 2));
                const totalCommonPoolFinal = parseInt(inventory.commonFrags || 0) + ((isStart ? FRAG_SOURCES.fixedCommon : 0) + commonRefund + refundedCommonFrags + (effDays * 3));

                const mapsFromGod = analyzeFragment(totalGodPool, CAPTAIN_REWARDS.god.refundFrag).maps;
                const mapsFromPeerless = analyzeFragment(totalPeerlessPool, CAPTAIN_REWARDS.peerless.refundFrag).maps;
                const mapsFromRare = analyzeFragment(totalRarePool, CAPTAIN_REWARDS.rare.refundFrag).maps;
                const mapsFromCommon = analyzeFragment(totalCommonPoolFinal, CAPTAIN_REWARDS.common.refundFrag).maps;

                const fragSynthAttr = (mapsFromGod * CAPTAIN_REWARDS.god.attr) + (mapsFromPeerless * CAPTAIN_REWARDS.peerless.attr) +
                    (mapsFromRare * CAPTAIN_REWARDS.rare.attr) + (mapsFromCommon * CAPTAIN_REWARDS.common.attr);
                const fragSynthUniv = (mapsFromGod * CAPTAIN_REWARDS.god.univ) + (mapsFromPeerless * CAPTAIN_REWARDS.peerless.univ) +
                    (mapsFromRare * CAPTAIN_REWARDS.rare.univ) + (mapsFromCommon * CAPTAIN_REWARDS.common.univ);

                // Á∏ΩÁµêÁÆó
                const inventoryAttrTotal = parseInt(inventory.attrFire || 0) + parseInt(inventory.attrWater || 0) +
                    parseInt(inventory.attrWind || 0) + parseInt(inventory.attrThunder || 0);

                // Final Categorized Pools
                const finalMemberAttr = memberIncomeAttr;
                const finalLeaderAttr = leaderIncomeAttr;
                const finalConversionAttr = convertedAttr + fragSynthAttr;

                const finalUnivBase = parseInt(inventory.univScrolls || 0) + legendUniv;
                const finalUnivReward = memberIncomeUniv + leaderIncomeUniv + convertedUniv + fragSynthUniv;

                const grandTotalAttr = inventoryAttrTotal + finalMemberAttr + finalLeaderAttr + finalConversionAttr;
                const grandTotalUniv = finalUnivBase + finalUnivReward;

                // Waterfall Pools
                // Separate pools as requested: Member Future Attr vs Leader Future Attr
                const futureMemberIncomeAttr = memberIncomeAttr;
                const futureLeaderIncomeAttr = leaderIncomeAttr + convertedAttr + fragSynthAttr;
                const futureMapsIncome = { fire: 0, water: 0, wind: 0, thunder: 0 }; // No more attribute-specific fixed maps

                // ÂïÜÂ∫óÊ∂àËÄóË®àÁÆó (Legacy helpers)
                const calcCategoryCost = (category) => {
                    let cost = 0;
                    const items = category === 'univ' ? UNIV_SHOP_ITEMS : ATTR_SHOP_ITEMS;
                    items.forEach(item => {
                        const count = shopCart[category][item.id] || 0;
                        cost += count * item.cost;
                    });
                    return cost;
                };

                return {
                    daysRemaining, weeksRemaining, legendUniv,
                    memberIncomeAttr, memberIncomeUniv,
                    leaderIncomeAttr, leaderIncomeUniv,
                    convertedAttr, convertedUniv,
                    fragSynthAttr, fragSynthUniv,
                    grandTotalAttr, grandTotalUniv,
                    univBase: finalUnivBase,
                    futureMemberIncomeAttr,
                    futureLeaderIncomeAttr,
                    futureMapsIncome,
                    allAsAttr: grandTotalAttr + grandTotalUniv,
                    allAsUniv: grandTotalUniv + Math.floor(grandTotalAttr / 2),
                    shopCostFire: calcCategoryCost('fire'), shopCostWater: calcCategoryCost('water'),
                    shopCostWind: calcCategoryCost('wind'), shopCostThunder: calcCategoryCost('thunder'),
                    shopCostUniv: calcCategoryCost('univ'),
                    shopCostAttrTotal: calcCategoryCost('fire') + calcCategoryCost('water') + calcCategoryCost('wind') + calcCategoryCost('thunder'),
                    totalRandomPool,
                    godStatus: analyzeFragment(totalGodPool, CAPTAIN_REWARDS.god.refundFrag),
                    peerlessStatus: analyzeFragment(totalPeerlessPool, CAPTAIN_REWARDS.peerless.refundFrag),
                    rareStatus: analyzeFragment(totalRarePool, CAPTAIN_REWARDS.rare.refundFrag),
                    commonStatus: analyzeFragment(totalCommonPoolFinal, CAPTAIN_REWARDS.common.refundFrag),
                    randomStatus: analyzeFragment(totalRandomPool, 0),
                    totalGodPool, totalPeerlessPool, totalRarePool, totalCommonPoolFinal,
                    effDays, effWeeks
                };
            }, [currentDateInput, inventory, legendOptions]);

            // --- NEW: Waterfall Queue Calculation ---
            const priorityQueueAnalysisData = useMemo(() => {
                // Determine auto-target attribute if set to 'none'
                let effectiveTargetAttr = targetAttr;
                if (effectiveTargetAttr === 'none') {
                    const firstAttrItem = cartQueue.find(it => it.category !== 'univ');
                    if (firstAttrItem) effectiveTargetAttr = firstAttrItem.category;
                }

                let pools = {
                    uStock: { val: parseInt(inventory.univScrolls || 0) },
                    uReward: { val: Math.max(0, (calculation.grandTotalUniv || 0) - parseInt(inventory.univScrolls || 0)) },
                    fFlex: { val: (calculation.futureMemberIncomeAttr || 0) + (calculation.futureLeaderIncomeAttr || 0) },
                    aStock: {
                        fire: { val: parseInt(inventory.attrFire || 0) }, water: { val: parseInt(inventory.attrWater || 0) },
                        wind: { val: parseInt(inventory.attrWind || 0) }, thunder: { val: parseInt(inventory.attrThunder || 0) }
                    }
                };

                // Initialize results
                const results = cartQueue.map(item => ({
                    ...item,
                    nativeUsed: 0,        // Ê≠•È©ü1: ÁèæÊúâ ÂêåÂ±¨ÊÄß (1:1)
                    nonTargetUniv: 0,     // Ê≠•È©ü2: ÈùûÁõÆÊ®ô ÁÑ°Â±¨ (1:1)
                    futureNativeUsed: 0,  // Ê≠•È©ü3: ÂæåÁ∫åÊéâËêΩ ÂêåÂ±¨ (1:1)
                    futureUnivUsed: 0,    // Ê≠•È©ü3/4: ÂæåÁ∫åÊéâËêΩ ÁÑ°Â±¨ (1:1)
                    nonTargetOtherRaw: 0, // Ê≠•È©ü4: ÈùûÁõÆÊ®ô ‰∏çÂêåÂ±¨ (2:1)
                    futureOtherRaw: 0,    // Ê≠•È©ü5: ÂæåÁ∫åÊéâËêΩ ‰∏çÂêåÂ±¨ (2:1)
                    conversionStolenRaw: 0, // Ê≠•È©ü6: ÈúÄÂàÜËß£ÂÖ∂‰ªñ
                    stolenFromMe: 0,      // Ë¢´ÂàÜËß£
                    gap: item.cost,
                    status: 'gap',
                    reservedNative: 0     // Phase 1 È†êÁïôÁöÑÁèæÊúâÂ∫´Â≠ò
                }));

                // ÂàÜÊûêÂïÜÂìÅÊ¨ÑË£°ÊúâÂì™‰∫õÂ±¨ÊÄßÔºàÁî®ÊñºÂà§Êñ∑Ê≠•È©ü3Âíå4Ôºâ
                const attributesInCart = {
                    fire: false, water: false, wind: false, thunder: false
                };
                const attributePriority = []; // ÊåâÈ†ÜÂ∫èË®òÈåÑÂ±¨ÊÄßÂá∫ÁèæÁöÑÂÑ™ÂÖàÊ¨ä
                
                results.forEach(res => {
                    if (res.category !== 'univ' && !attributesInCart[res.category]) {
                        attributesInCart[res.category] = true;
                        attributePriority.push(res.category);
                    }
                });

                // ÊåâÈ†ÜÂ∫èÈÄêÂÄãÂÆåÊï¥ËôïÁêÜÊØèÂÄãÂïÜÂìÅ
                results.forEach((res, i) => {
                    
                    // Ê≠•È©ü1: ÁèæÊúâÂêåÂ±¨ÊÄßÂ∫´Â≠ò (1:1)
                    const nativePool = res.category === 'univ' ? pools.uStock : pools.aStock[res.category];
                    if (nativePool && nativePool.val > 0 && res.gap > 0) {
                        const took = Math.min(res.gap, nativePool.val);
                        res.nativeUsed = took;
                        res.reservedNative = took;
                        res.gap -= took;
                        nativePool.val -= took;
                    }
                    
                    if (res.gap <= 0) return;

                    // Ê≠•È©ü2: Êú™‰æÜÁç≤ÂèñÂêåÂ±¨ÊÄß (1:1)
                    if (res.category !== 'univ' && res.category === effectiveTargetAttr) {
                        if (pools.fFlex.val > 0 && res.gap > 0) {
                            const took = Math.min(res.gap, pools.fFlex.val);
                            res.futureNativeUsed += took;
                            res.gap -= took;
                            pools.fFlex.val -= took;
                        }
                    } else if (res.category === 'univ') {
                        if (pools.uReward.val > 0 && res.gap > 0) {
                            const took = Math.min(res.gap, pools.uReward.val);
                            res.futureUnivUsed += took;
                            res.gap -= took;
                            pools.uReward.val -= took;
                        }
                    }
                    
                    if (res.gap <= 0) return;

                    // Ê≠•È©ü3: ÁèæÊúâ„Äå‰∏çÂú®ÂïÜÂìÅÊ¨Ñ„ÄçÁöÑÂ±¨ÊÄßÊÆòÂç∑ (2:1)
                    if (res.category === 'univ') {
                        const notInCart = ['fire', 'water', 'wind', 'thunder'].filter(attr => !attributesInCart[attr]);
                        notInCart.forEach(attr => {
                            if (res.gap <= 0 || pools.aStock[attr].val <= 0) return;
                            const needed = res.gap * 2;
                            const took = Math.min(pools.aStock[attr].val, needed);
                            const gain = Math.floor(took / 2);
                            if (gain > 0) {
                                res.nonTargetOtherRaw += took;
                                res.gap -= gain;
                                pools.aStock[attr].val -= took;
                            }
                        });
                    }
                    
                    if (res.gap <= 0) return;

                    // Ê≠•È©ü4: ÁèæÊúâ„ÄåÂïÜÂìÅÊ¨ÑË£°ÊúÄ‰ΩéÂÑ™ÂÖàÊ¨ä„ÄçÁöÑÂ±¨ÊÄßÊÆòÂç∑ (2:1)
                    if (res.category === 'univ') {
                        const inCartReversed = [...attributePriority].reverse();
                        inCartReversed.forEach(attr => {
                            if (res.gap <= 0 || pools.aStock[attr].val <= 0) return;
                            const needed = res.gap * 2;
                            const took = Math.min(pools.aStock[attr].val, needed);
                            const gain = Math.floor(took / 2);
                            if (gain > 0) {
                                res.nonTargetOtherRaw += took;
                                res.gap -= gain;
                                pools.aStock[attr].val -= took;
                            }
                        });
                    }
                    
                    if (res.gap <= 0) return;

                    // === Â±¨ÊÄßÂïÜÂìÅÁöÑÊ≠•È©ü3-6 ===
                    if (res.category !== 'univ') {
                        // Ê≠•È©ü3: Êú™‰æÜÈÄöÁî®ÊÆòÂç∑ (1:1)
                        if (pools.uReward.val > 0 && res.gap > 0) {
                            const took = Math.min(res.gap, pools.uReward.val);
                            res.futureUnivUsed += took;
                            res.gap -= took;
                            pools.uReward.val -= took;
                        }
                        
                        if (res.gap <= 0) return;
                        
                        // Ê≠•È©ü4: ‰∏çÂú®ÂïÜÂìÅÊ¨ÑÁöÑÂ±¨ÊÄß (2:1)
                        const notInCart = ['fire', 'water', 'wind', 'thunder'].filter(attr => !attributesInCart[attr] && attr !== res.category);
                        notInCart.forEach(attr => {
                            if (res.gap <= 0 || pools.aStock[attr].val <= 0) return;
                            const needed = res.gap * 2;
                            const took = Math.min(pools.aStock[attr].val, needed);
                            const gain = Math.floor(took / 2);
                            if (gain > 0) {
                                res.nonTargetOtherRaw += took;
                                res.gap -= gain;
                                pools.aStock[attr].val -= took;
                            }
                        });
                        
                        if (res.gap <= 0) return;
                        
                        // Ê≠•È©ü5: ÂïÜÂìÅÊ¨ÑÊúÄ‰ΩéÂÑ™ÂÖàÊ¨äÁöÑÂ±¨ÊÄß (2:1) - ÊéíÈô§Ëá™Â∑±
                        const inCartReversed = [...attributePriority].reverse().filter(attr => attr !== res.category);
                        inCartReversed.forEach(attr => {
                            if (res.gap <= 0 || pools.aStock[attr].val <= 0) return;
                            const needed = res.gap * 2;
                            const took = Math.min(pools.aStock[attr].val, needed);
                            const gain = Math.floor(took / 2);
                            if (gain > 0) {
                                res.nonTargetOtherRaw += took;
                                res.gap -= gain;
                                pools.aStock[attr].val -= took;
                            }
                        });
                        
                        if (res.gap <= 0) return;
                        
                        // Ê≠•È©ü6: Êú™‰æÜÂ±¨ÊÄßÊÆòÂç∑ (2:1)
                        if (pools.fFlex.val > 0 && res.gap > 0) {
                            const needed = res.gap * 2;
                            const took = Math.min(pools.fFlex.val, needed);
                            const gain = Math.floor(took / 2);
                            if (gain > 0) {
                                res.futureOtherRaw += took;
                                res.gap -= gain;
                                pools.fFlex.val -= took;
                            }
                        }
                    }

                    // === ÈÄöÁî®ÂïÜÂìÅÁöÑÊ≠•È©ü5 ===
                    if (res.category === 'univ' && pools.fFlex.val > 0 && res.gap > 0) {
                        const needed = res.gap * 2;
                        const took = Math.min(pools.fFlex.val, needed);
                        const gain = Math.floor(took / 2);
                        if (gain > 0) {
                            res.futureOtherRaw += took;
                            res.gap -= gain;
                            pools.fFlex.val -= took;
                        }
                    }
                });

                const finalResults = results.map(res => {
                    const filled = res.cost - res.gap;
                    res.progress = `${filled}/${res.cost}`;
                    if (res.gap <= 0) {
                        if (res.nativeUsed > 0 || res.futureNativeUsed > 0) res.status = 'stock';
                        else if (res.nonTargetUniv > 0 || res.futureUnivUsed > 0) res.status = 'univ';
                        else res.status = 'convert';
                    } else res.status = 'gap';

                    return { ...res };
                });

                return {
                    results: finalResults,
                    remnants: {
                        univ: pools.uStock.val + pools.uReward.val,
                        fire: pools.aStock.fire.val, water: pools.aStock.water.val,
                        wind: pools.aStock.wind.val, thunder: pools.aStock.thunder.val,
                        flexible: pools.fFlex.val
                    }
                };
            }, [cartQueue, calculation, inventory, targetAttr]);

            const priorityQueueAnalysis = priorityQueueAnalysisData.results;
            const queueRemnants = priorityQueueAnalysisData.remnants;
            // #endregion


            function analyzeFragment(count, refund = 0) {
                // Recursive calculation for maps: maps = 1 + floor((totalFrags - 10) / (10 - refund))
                // Each map synth requires 10, but returns 'refund' pieces back.
                const maps = count >= 10 ? (refund === 0 ? Math.floor(count / 10) : 1 + Math.floor((count - 10) / (10 - refund))) : 0;
                const totalConsumed = maps * 10;
                const totalRefunded = maps * refund;
                const current = count - totalConsumed + totalRefunded;
                const needed = 10 - current;
                return { maps, current, needed: needed <= 0 ? 0 : needed };
            }

            const dailyTable = useMemo(() => {
                let rows = [];
                let curr = new Date(START_DATE);
                let accAttr = 0, accUniv = 0, accRandom = 0;

                for (let i = 1; i <= 35; i++) {
                    const dateStr = curr.toISOString().split('T')[0];
                    const weekDay = WEEKDAYS[curr.getDay()];
                    const isSunday = curr.getDay() === 0;

                    let dayAttr = DAILY_MEMBER_REWARD.attr;
                    let dayUniv = DAILY_MEMBER_REWARD.univ;
                    let dayRandom = FRAG_SOURCES.dailyRandom;
                    let notes = [];

                    if (isSunday || i === 1) {
                        dayAttr += WEEKLY_MEMBER_REWARD.attr;
                        dayUniv += WEEKLY_MEMBER_REWARD.univ;
                        notes.push({ text: t.note_weekly, style: "font-bold text-black" });
                    }
                    if (i === 1) {
                        notes.push({ text: t.note_fixed, style: "text-gray-500" });
                        accRandom += FRAG_SOURCES.fixedRandom + (parseInt(legendOptions.artEventAmount) || 0);

                        let legUniv = 0;
                        if (legendOptions.includeMember) legUniv += LEGEND_REWARD_MEMBER.univ;
                        if (legendOptions.includeCaptain) legUniv += LEGEND_REWARD_CAPTAIN.univ;
                        if (legUniv > 0) {
                            dayUniv += legUniv;
                            const noteText = t.note_leg.replace('{v}', legUniv);
                            notes.push({ text: noteText, style: "font-bold text-orange-600" });
                        }
                    }

                    accAttr += dayAttr;
                    accUniv += dayUniv;
                    accRandom += dayRandom;

                    rows.push({
                        day: i, date: `${dateStr.slice(5)} ${lang === 'zh' ? weekDay : ''}`,
                        dayAttr, dayUniv, dayRandom,
                        accAttr, accUniv, accRandom,
                        notes
                    });
                    curr.setDate(curr.getDate() + 1);
                }
                return rows;
            }, [legendOptions, lang]);

            // #region ‰∫ã‰ª∂ËôïÁêÜ (Event Handlers)
            // --- Ëº∏ÂÖ•È©óË≠â ---
            const handleDateChange = (val) => {
                const inputDate = new Date(val);
                const minDate = new Date('2026-01-21');
                const maxDate = new Date('2026-02-25');
                
                if (inputDate < minDate || inputDate > maxDate) {
                    setDateError(lang === 'zh' 
                        ? 'Êó•ÊúüÂøÖÈ†àÂú® 2026-01-21 Ëá≥ 2026-02-25 ‰πãÈñì' 
                        : 'Date must be between 2026-01-21 and 2026-02-25');
                } else {
                    setDateError('');
                }
                setCurrentDateInput(val);
            };

            const updateInv = (field, val) => {
                let numVal = parseInt(val);
                if (val === "") {
                    setInventory(prev => ({ ...prev, [field]: "" }));
                    return;
                }
                if (numVal < 0 || numVal > 999999) return; // ÈôêÂà∂ÁØÑÂúç
                setInventory(prev => ({ ...prev, [field]: numVal.toString() }));
            };

            const updateArtEvent = (val) => {
                let numVal = parseInt(val);
                if (val === "") {
                    setLegendOptions(prev => ({ ...prev, artEventAmount: "" }));
                    return;
                }
                if (numVal < 0 || numVal > 999999) return;
                setLegendOptions(prev => ({ ...prev, artEventAmount: numVal }));
            };

            const toggleLegend = (field) => setLegendOptions(prev => ({ ...prev, [field]: !prev[field] }));

            const clearScrolls = () => setInventory(prev => ({ ...prev, attrFire: 0, attrWater: 0, attrWind: 0, attrThunder: 0, univScrolls: 0 }));
            const clearMaps = () => setInventory(prev => ({
                ...prev,
                godMaps: 0, peerlessMaps: 0, rareMaps: 0, commonMaps: 0
            }));
            const clearFrags = () => setInventory(prev => ({ ...prev, godFrags: 0, peerlessFrags: 0, rareFrags: 0, commonFrags: 0, randomFrags: 0 }));

            // --- Updated Shop Logic with Queue ---
            const updateShop = (category, item, delta) => {
                // 1. Update the Count Map (Legacy for UI)
                setShopCart(prev => {
                    const currentCount = prev[category][item.id] || 0;
                    const newCount = Math.max(0, currentCount + delta);
                    return { ...prev, [category]: { ...prev[category], [item.id]: newCount } };
                });

                // 2. Update the Queue
                setCartQueue(prev => {
                    if (delta > 0) {
                        const newId = Date.now() + Math.random();
                        const newQueue = [...prev, {
                            uid: newId,
                            category,
                            id: item.id,
                            name: item.name,
                            cost: item.cost
                        }];
                        // Update selection index to the newly added item (end of list)
                        setSelectedQueueIndex(newQueue.length - 1);
                        return newQueue;
                    } else {
                        // Remove Last Occurrence
                        const reversed = [...prev].reverse();
                        const indexToRemove = reversed.findIndex(q => q.category === category && q.id === item.id);

                        if (indexToRemove !== -1) {
                            const newReversed = [...reversed];
                            newReversed.splice(indexToRemove, 1);
                            const finalQueue = newReversed.reverse();
                            setSelectedQueueIndex(null);
                            return finalQueue;
                        }
                        return prev;
                    }
                });
            };

            const clearShopCategory = (category) => {
                setShopCart(prev => ({ ...prev, [category]: {} }));
                // Also clear from queue
                setCartQueue(prev => prev.filter(item => item.category !== category));
            };

            // --- Manual Control Handlers ---
            const handleQueueItemClick = (index) => {
                if (selectedQueueIndex === index) {
                    setSelectedQueueIndex(null);
                } else {
                    setSelectedQueueIndex(index);
                }
            };

            const handleMoveUp = () => {
                if (selectedQueueIndex === null || selectedQueueIndex === 0) return;
                const newQueue = [...cartQueue];
                [newQueue[selectedQueueIndex - 1], newQueue[selectedQueueIndex]] = [newQueue[selectedQueueIndex], newQueue[selectedQueueIndex - 1]];
                setCartQueue(newQueue);
                setSelectedQueueIndex(selectedQueueIndex - 1);
            };

            const handleMoveDown = () => {
                if (selectedQueueIndex === null || selectedQueueIndex === cartQueue.length - 1) return;
                const newQueue = [...cartQueue];
                [newQueue[selectedQueueIndex + 1], newQueue[selectedQueueIndex]] = [newQueue[selectedQueueIndex], newQueue[selectedQueueIndex + 1]];
                setCartQueue(newQueue);
                setSelectedQueueIndex(selectedQueueIndex + 1);
            };

            // --- ÊãñÊãΩÊéíÂ∫è Handlers (ÂÉÖÊ°åÈù¢Á´Ø) ---
            const handleDragStart = (e, index) => {
                if (isMobile) return; // ÊâãÊ©üÁ¶ÅÁî®
                setDraggedIndex(index);
                if (e.dataTransfer) {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', e.currentTarget);
                }
            };

            const handleDragOver = (e, index) => {
                if (isMobile) return; // ÊâãÊ©üÁ¶ÅÁî®
                e.preventDefault();
                if (e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'move';
                }
                
                if (draggedIndex === null || draggedIndex === index) return;
                
                const newQueue = [...cartQueue];
                const draggedItem = newQueue[draggedIndex];
                newQueue.splice(draggedIndex, 1);
                newQueue.splice(index, 0, draggedItem);
                
                setCartQueue(newQueue);
                setDraggedIndex(index);
            };

            const handleDragEnd = () => {
                if (isMobile) return; // ÊâãÊ©üÁ¶ÅÁî®
                setDraggedIndex(null);
            };

            // --- Ëß∏ÊéßÊãñÊãΩÂ∑≤ÁßªÈô§ÔºàÊâãÊ©ü‰ΩøÁî®‰∏ä‰∏ãÁÆ≠È†≠Ôºâ ---

            const handleDeleteItem = () => {
                if (selectedQueueIndex === null) return;
                const itemToRemove = cartQueue[selectedQueueIndex];

                const newQueue = [...cartQueue];
                newQueue.splice(selectedQueueIndex, 1);
                setCartQueue(newQueue);

                // Fix selection state: inherit next index or keep same or null
                if (newQueue.length === 0) {
                    setSelectedQueueIndex(null);
                } else {
                    const nextIndex = Math.min(selectedQueueIndex, newQueue.length - 1);
                    setSelectedQueueIndex(nextIndex);
                }

                // Sync with ShopCart counts
                setShopCart(prev => {
                    const cat = itemToRemove.category;
                    const id = itemToRemove.id;
                    const currentCount = prev[cat][id] || 0;
                    const newCount = Math.max(0, currentCount - 1);
                    return { ...prev, [cat]: { ...prev[cat], [id]: newCount } };
                });
            };
            const clearAllQueue = () => {
                if (window.confirm(lang === 'zh' ? 'Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ë≥ºÁâ©ËªäÂóéÔºü' : 'Clear all items?')) {
                    setCartQueue([]);
                    setShopCart({ fire: {}, water: {}, wind: {}, thunder: {}, univ: {} });
                    setSelectedQueueIndex(null);
                }
            };
            // #endregion

            // #region ‰ªãÈù¢ËºîÂä©ÂÖÉ‰ª∂ (UI Components)
            const ShopItem = ({ item, category, color }) => {
                const count = shopCart[category][item.id] || 0;
                const costStyle = category === 'univ' ? "text-green-600" : "text-blue-600";

                return (
                    <div className="shop-counter">
                        <div className="flex flex-col justify-center">
                            <div className={`shop-item-cost-large ${costStyle}`}>{item.cost} Êç≤</div>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={() => updateShop(category, item, -1)} disabled={count <= 0}>-</button>
                            <span className={`text-sm font-bold w-6 text-center ${count > 0 ? color : 'text-gray-400'}`}>{count}</span>
                            <button onClick={() => updateShop(category, item, 1)}>+</button>
                        </div>
                    </div>
                );
            };

            const AttrDashboardCard = ({ label, textColor, bgColorClass, inv, cost }) => {
                const net = inv - cost;

                return (
                    <div className={`p-2 rounded-lg border ${bgColorClass} ${net >= 0 ? 'border-gray-200' : 'border-red-500 border-2'}`}>
                        <div className={`font-bold text-[0.75rem] mb-1 ${textColor}`}>{label}</div>
                        <div className="space-y-1 text-[0.625rem] text-gray-600">
                            <div className="flex justify-between"><span>{t.card_inv}:</span> <span>{(inv || 0).toLocaleString()}</span></div>
                            <div className="flex justify-between text-pink-600"><span>{t.card_cost}:</span> <span>-{(cost || 0).toLocaleString()}</span></div>
                            <div className="border-t border-gray-200 my-0.5 pt-0.5 flex justify-between items-center">
                                <span className="font-bold">{t.card_bal}:</span>
                                <span className={`font-bold text-sm ${net >= 0 ? 'text-blue-600' : 'text-red-600 font-extrabold'}`}>{net}</span>
                            </div>
                        </div>
                    </div>
                );
            };

            const getAttrLabel = (key) => t[`attr_${key}`];
            const getAttrColorText = (key) => `color-${key}`;
            const getAttrBg = (key) => `bg-${key}-light`;
            // #endregion

            // #region ‰ªãÈù¢‰ΩàÂ±Ä (UI Layout)
            return (
                <div className="max-w-5xl xl:max-w-7xl mx-auto p-2 md:p-6 flex flex-col min-h-screen relative">
                    {/* Top Section */}
                    <div className="flex flex-col md:flex-row justify-between items-center mb-4 pt-2 gap-3">
                        <div className="text-[0.75rem] font-bold text-gray-500 font-mono flex items-center justify-center md:justify-start order-2 md:order-1 flex-shrink-0">
                            {APP_VERSION} | {APP_AUTHOR}
                        </div>
                        <div className="text-center order-1 md:order-2 px-2">
                            <h1 className="text-2xl font-bold text-indigo-900 mb-0 leading-tight whitespace-nowrap">{t.title}</h1>
                            <p className="text-gray-500 text-[0.625rem]">{t.period}</p>
                        </div>
                        <div className="flex flex-wrap gap-2 justify-center md:justify-end order-3 md:order-3 flex-grow md:flex-grow-0">
                            <button onClick={() => setLang(prev => prev === 'zh' ? 'en' : 'zh')} className="bg-white text-indigo-600 px-3 py-1 rounded-full shadow-sm text-[0.75rem] font-bold hover:bg-indigo-50 transition border border-indigo-200 min-h-[1.875rem] flex items-center flex-shrink-0 whitespace-nowrap">
                                {lang === 'zh' ? 'EN' : '‰∏≠'}
                            </button>
                            <button onClick={() => setShowHelp(true)} className="bg-white text-gray-600 px-3 py-1 rounded-full shadow-sm text-[0.75rem] font-bold hover:bg-gray-50 transition border border-gray-200 min-h-[1.875rem] flex items-center flex-shrink-0 whitespace-nowrap">{t.btn_help}</button>
                            <button onClick={() => setViewMode(prev => prev === 'tabs' ? 'single' : 'tabs')} className="bg-white text-indigo-600 px-3 py-1 rounded-full shadow-sm text-[0.75rem] font-bold hover:bg-indigo-50 transition border border-indigo-100 flex items-center gap-1 min-h-[1.875rem] flex-shrink-0 whitespace-nowrap">
                                {viewMode === 'tabs' ? t.btn_tabs : t.btn_single}
                            </button>
                        </div>
                    </div>

                    {/* Help Modal */}
                    {showHelp && (
                        <div className="modal-overlay" onClick={() => setShowHelp(false)}>
                            <div className="modal-content p-6" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="text-xl font-bold text-gray-800">{t.help_title}</h3>
                                    <button onClick={() => setShowHelp(false)} className="text-gray-500 font-bold">√ó</button>
                                </div>
                                <div className="space-y-4 text-sm text-gray-700 overflow-y-auto px-1" style={{ maxHeight: '70vh' }}>
                                    <p>{t.help_p1}</p>

                                    {/* Section 1 */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1">{t.help_h1}</h4>
                                    <p>{t.help_p2}</p>
                                    <ul className="list-disc pl-5 space-y-1">
                                        <li>{t.help_li1}</li>
                                        <li>{t.help_li2}</li>
                                    </ul>

                                    {/* Section 2 */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1 mt-4">{t.help_h2}</h4>
                                    <p>{t.help_p3}</p>
                                    <ul className="list-disc pl-5 space-y-1">
                                        <li>{t.help_li3}</li>
                                    </ul>

                                    {/* Section 3 - Calculation Logic */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1 mt-4">{t.help_h3}</h4>
                                    <p className="mt-1">{t.help_p4}</p>
                                    <ul className="list-none pl-3 space-y-1 text-sm">
                                        <li>{t.help_li4}</li>
                                        <li>{t.help_li5}</li>
                                        <li>{t.help_li6}</li>
                                        <li>{t.help_li7}</li>
                                        <li>{t.help_li8}</li>
                                    </ul>
                                    <p className="mt-2 text-sm bg-amber-50 p-2 rounded border-l-4 border-amber-400">{t.help_p5}</p>

                                    {/* Section 4 - Zoom & Shortcuts */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1 mt-4">{t.help_h4}</h4>
                                    <p className="mt-1">{t.help_p6}</p>
                                    <p className="mt-1">{t.help_p7}</p>
                                    <p className="mt-1">{t.help_p8}</p>

                                    {/* Section 5 - Daily Workflow */}
                                    <h4 className="font-bold text-lg text-indigo-700 border-b pb-1 mt-4">{t.help_h5}</h4>
                                    <ol className="list-decimal pl-5 space-y-2">
                                        <li><strong>{t.help_s1}</strong>Ôºö<p className="text-[0.75rem] text-gray-500 mt-0.5">{t.help_d1}</p></li>
                                        <li><strong>{t.help_s2}</strong>Ôºö<p className="text-[0.75rem] text-gray-500 mt-0.5">{t.help_d2}</p></li>
                                        <li><strong>{t.help_s3}</strong>Ôºö<p className="text-[0.75rem] text-gray-500 mt-0.5">{t.help_d3}</p></li>
                                    </ol>
                                </div>
                                <div className="mt-6 text-center"><button onClick={() => setShowHelp(false)} className="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 transition">{t.btn_gotit}</button></div>
                            </div>
                        </div>
                    )}

                    {/* ÂàÜÈ†Å Tab */}
                    {viewMode === 'tabs' && (
                        <div className="flex border-b border-gray-200 mb-4 bg-white rounded-t-lg shadow-sm tabs-container mx-1">
                            <div className={`tab-btn rounded-tl-lg ${activeTab === 'main' ? 'active' : ''}`} onClick={() => setActiveTab('main')}>
                                <span className="hidden sm:inline">{t.tab_main}</span>
                                <span className="inline sm:hidden">{t.tab_main_short}</span>
                            </div>
                            <div className={`tab-btn ${activeTab === 'shop' ? 'active' : ''}`} onClick={() => setActiveTab('shop')}>
                                <span className="hidden sm:inline">{t.tab_shop}</span>
                                <span className="inline sm:hidden">{t.tab_shop_short}</span>
                            </div>
                            <div className={`tab-btn ${activeTab === 'daily' ? 'active' : ''}`} onClick={() => setActiveTab('daily')}>
                                <span className="hidden sm:inline">{t.tab_daily}</span>
                                <span className="inline sm:hidden">{t.tab_daily_short}</span>
                            </div>
                            <div className={`tab-btn rounded-tr-lg ${activeTab === 'sources' ? 'active' : ''}`} onClick={() => setActiveTab('sources')}>
                                <span className="hidden sm:inline">{t.tab_sources}</span>
                                <span className="inline sm:hidden">{t.tab_sources_short}</span>
                            </div>
                        </div>
                    )}

                    {/* Merged Tab 1: Ë®≠ÂÆöÂ∫´Â≠òËàáÊî∂ÁõäÈ†ê‰º∞ */}
                    {(viewMode === 'single' || activeTab === 'main') && (
                        <div className={`grid grid-cols-1 lg:grid-cols-12 gap-4 mx-1 h-full ${viewMode === 'tabs' ? 'mb-6' : 'mb-6'}`}>
                            {/* Left Col: Settings (6 cols wide) */}
                            <div className={`lg:col-span-6 card p-4 bg-white border-t-4 border-blue-500 flex flex-col h-full`}>
                                {/* 3-Row Header Layout - Consistent 3-Part Alignment & Compact */}
                                <div className="flex flex-col gap-1.5 mb-3">
                                    {/* Row 1: Date Selection */}
                                    <div className="bg-blue-50/50 p-2 rounded-lg border border-blue-100 flex flex-wrap items-center justify-between gap-2 shadow-sm">
                                        <div className="text-blue-900 font-bold text-[0.6875rem] flex items-center gap-1 min-w-[5rem]">üìÖ {t.lbl_date}</div>
                                        <div className="flex-grow flex flex-col items-start min-w-[8rem]">
                                            <input 
                                                type="date" 
                                                value={currentDateInput} 
                                                onChange={(e) => handleDateChange(e.target.value)} 
                                                min="2026-01-21" 
                                                max="2026-02-25" 
                                                className={`border-blue-200 rounded px-1 text-[0.75rem] h-7 w-full shadow-inner ${dateError ? 'border-red-400 bg-red-50' : ''}`}
                                                onWheel={(e) => e.target.blur()} 
                                            />
                                            {dateError && <span className="text-[0.625rem] text-red-600 mt-0.5">{dateError}</span>}
                                        </div>
                                        <div className="flex-shrink-0">
                                            <span className="text-[0.75rem] sm:text-[0.875rem] text-blue-700 font-bold whitespace-nowrap bg-white px-2 py-0.5 rounded shadow-sm border border-blue-100 block text-center min-w-[5.625rem]">
                                                {t.lbl_remaining.replace('{d}', calculation.effDays).replace('{w}', calculation.effWeeks)}
                                            </span>
                                        </div>
                                    </div>

                                    {/* Row 2: Legend Rewards */}
                                    <div className="bg-purple-50/50 p-2 rounded-lg border border-purple-100 flex flex-wrap items-center justify-between gap-2 shadow-sm">
                                        <div className="text-purple-900 font-bold text-[0.6875rem] flex items-center gap-1 min-w-[5rem]">
                                            üìú {lang === 'zh' ? 'ÂÇ≥È†å (Ëã•Â∑≤Áç≤ÂæóË´ãÂãøÂãæÈÅ∏)' : 'Legend  (Opt. out if done)'}
                                        </div>
                                        <div className="flex-grow flex flex-row flex-wrap gap-2 items-center min-w-[8rem]">
                                            <div className="checkbox-group flex items-center gap-1">
                                                <input type="checkbox" id="legCaptain" checked={legendOptions.includeCaptain} onChange={() => toggleLegend('includeCaptain')} className="w-4 h-4 cursor-pointer" />
                                                <label htmlFor="legCaptain" className="text-gray-700 text-[0.625rem] sm:text-[0.75rem] cursor-pointer truncate">{t.lbl_leg_captain}</label>
                                            </div>
                                            <div className="checkbox-group flex items-center gap-1">
                                                <input type="checkbox" id="legMember" checked={legendOptions.includeMember} onChange={() => toggleLegend('includeMember')} className="w-4 h-4 cursor-pointer" />
                                                <label htmlFor="legMember" className="text-gray-700 text-[0.625rem] sm:text-[0.75rem] cursor-pointer truncate">{t.lbl_leg_member}</label>
                                            </div>
                                        </div>
                                        <div className="flex-shrink-0">
                                            <span className="text-[0.5625rem] sm:text-[0.625rem] text-purple-600 italic whitespace-nowrap bg-purple-100/50 px-2 py-0.5 rounded border border-purple-100 block">
                                                {lang === 'zh' ? 'Êî∂ÁõäË®àÂÖ•È†ê‰º∞' : 'Est. Inc.'}
                                            </span>
                                        </div>
                                    </div>

                                    {/* Row 3: Limited Events & Target Attr */}
                                    <div className="bg-orange-50/50 p-2 rounded-lg border border-orange-100 flex flex-wrap items-center justify-between gap-2 shadow-sm">
                                        <div className="text-orange-900 font-bold text-[0.6875rem] flex items-center gap-1 min-w-[5rem]">‚ú® {lang === 'zh' ? 'Â¶ôÊâã (Ëã•Â∑≤Áç≤ÂæóË´ãÂãøÂãæÈÅ∏)' : 'Art (Opt. out if done)'}</div>
                                        {/* Art Event Select */}
                                        <div className="flex items-center gap-1 flex-1 min-w-[6rem]">
                                            <select value={legendOptions.artEventAmount} onChange={(e) => setLegendOptions(prev => ({ ...prev, artEventAmount: parseInt(e.target.value) }))} className="border-orange-200 rounded px-1 text-[0.7rem] h-6 bg-white">
                                                <option value="0">0</option><option value="5">5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option>
                                            </select>
                                        </div>
                                        <div className="flex-shrink-0">
                                            <span className="text-[0.5625rem] sm:text-[0.625rem] text-orange-600 italic whitespace-nowrap bg-orange-100/50 px-2 py-0.5 rounded border border-orange-100 block">
                                                {lang === 'zh' ? 'Êî∂ÁõäË®àÂÖ•È†ê‰º∞' : 'Est. Inc.'}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                {/* Scrolls */}
                                <div className="bg-blue-50 p-2 rounded-lg border border-blue-200 mb-2">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-[0.75rem] font-bold text-gray-700">{t.lbl_scrolls}</label>
                                        <button onClick={clearScrolls} className="text-[0.625rem] bg-white border border-gray-300 px-1 rounded shadow-sm">{t.btn_clear}</button>
                                    </div>
                                    <div className="grid grid-cols-5 gap-1">
                                        <div className="input-group"><label className="color-wind">{t.attr_wind}</label><input type="number" min="0" value={inventory.attrWind} onChange={(e) => updateInv('attrWind', e.target.value)} className="border-wind focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="color-thunder">{t.attr_thunder}</label><input type="number" min="0" value={inventory.attrThunder} onChange={(e) => updateInv('attrThunder', e.target.value)} className="border-thunder focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="color-water">{t.attr_water}</label><input type="number" min="0" value={inventory.attrWater} onChange={(e) => updateInv('attrWater', e.target.value)} className="border-water focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="color-fire">{t.attr_fire}</label><input type="number" min="0" value={inventory.attrFire} onChange={(e) => updateInv('attrFire', e.target.value)} className="border-fire focus:ring-1" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-gray-600">{t.attr_univ}</label><input type="number" min="0" value={inventory.univScrolls} onChange={(e) => updateInv('univScrolls', e.target.value)} onWheel={(e) => e.target.blur()} /></div>
                                    </div>
                                </div>

                                {/* Maps (Simplified: One row for Qualities) */}
                                <div className="bg-orange-50 p-2 rounded-lg border border-orange-200 mb-2">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-[0.75rem] font-bold text-gray-700">{t.lbl_maps}</label>
                                        <button onClick={clearMaps} className="text-[0.625rem] bg-white border border-gray-300 px-1 rounded shadow-sm">{t.btn_clear}</button>
                                    </div>

                                    <div className="grid grid-cols-4 gap-2 text-[0.6875rem]">
                                        <div className="input-group">
                                            <label className="text-red-600">{t.qual_god}</label>
                                            <input type="number" min="0" value={inventory.godMaps} onChange={(e) => updateInv('godMaps', e.target.value)} className="bg-red-50 w-full" onWheel={(e) => e.target.blur()} />
                                        </div>
                                        <div className="input-group">
                                            <label className="text-purple-600">{t.qual_peerless}</label>
                                            <input type="number" min="0" value={inventory.peerlessMaps} onChange={(e) => updateInv('peerlessMaps', e.target.value)} className="bg-purple-50 w-full" onWheel={(e) => e.target.blur()} />
                                        </div>
                                        <div className="input-group">
                                            <label className="text-indigo-600">{t.qual_rare}</label>
                                            <input type="number" min="0" value={inventory.rareMaps} onChange={(e) => updateInv('rareMaps', e.target.value)} className="bg-indigo-50 w-full" onWheel={(e) => e.target.blur()} />
                                        </div>
                                        <div className="input-group">
                                            <label className="text-green-600">{t.qual_common}</label>
                                            <input type="number" min="0" value={inventory.commonMaps} onChange={(e) => updateInv('commonMaps', e.target.value)} className="bg-green-50 w-full" onWheel={(e) => e.target.blur()} />
                                        </div>
                                    </div>
                                </div>

                                {/* Frags */}
                                <div className="bg-indigo-50 p-2 rounded-lg border border-indigo-200">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-[0.75rem] font-bold text-gray-700">{t.lbl_frags}</label>
                                        <button onClick={clearFrags} className="text-[0.625rem] bg-white border border-gray-300 px-1 rounded shadow-sm">{t.btn_clear}</button>
                                    </div>
                                    <div className="grid grid-cols-5 gap-1">
                                        <div className="input-group"><label className="text-god">{t.qual_god}</label><input type="number" min="0" value={inventory.godFrags} onChange={(e) => updateInv('godFrags', e.target.value)} className="bg-red-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-peerless">{t.qual_peerless}</label><input type="number" min="0" value={inventory.peerlessFrags} onChange={(e) => updateInv('peerlessFrags', e.target.value)} className="bg-purple-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-rare">{t.qual_rare}</label><input type="number" min="0" value={inventory.rareFrags} onChange={(e) => updateInv('rareFrags', e.target.value)} className="bg-indigo-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-common">{t.qual_common}</label><input type="number" min="0" value={inventory.commonFrags} onChange={(e) => updateInv('commonFrags', e.target.value)} className="bg-green-50" onWheel={(e) => e.target.blur()} /></div>
                                        <div className="input-group"><label className="text-random">{t.qual_random}</label><input type="number" min="0" value={inventory.randomFrags} onChange={(e) => updateInv('randomFrags', e.target.value)} className="bg-yellow-50" onWheel={(e) => e.target.blur()} /></div>
                                    </div>
                                </div>

                                {/* Tip Card moved here (below Frags) */}
                                <div className="mt-2 bg-orange-50 p-2.5 rounded-lg border border-orange-200 shadow-sm">
                                    <div className="text-[0.75rem] text-orange-800 font-bold flex flex-col gap-0.5">
                                        {lang === 'zh' ? (
                                            <React.Fragment>
                                                <div className="flex items-center gap-1">üí° ÊèêÁ§∫Ôºö‰ΩøÁî®ÈÄöÁî®Êç≤ÂèØ‰ª• 1:1 Êõø‰ª£Â±¨ÊÄßÊç≤„ÄÇ</div>
                                                <div>ÂÖ∂‰ªñÂ±¨ÊÄßÈñìÂèØÈÄèÈÅé 2:1 ËΩâÂåñÂΩåË£úÁº∫Âè£„ÄÇ</div>
                                                <div className="text-orange-600 mt-0.5 flex items-center gap-1 font-normal opacity-80">
                                                    Ë©≥Á¥∞Ë¶èÂäÉË´ãËá≥„ÄåÂïÜÂ∫ó„ÄçÂàÜÈ†ÅÊü•ÁúãÂÑ™ÂÖàÈöäÂàóÂàÜÊûê„ÄÇ
                                                </div>
                                            </React.Fragment>
                                        ) : (
                                            <React.Fragment>
                                                <div className="flex items-center gap-1">üí° Protip: Universal scrolls substitute 1:1.</div>
                                                <div>Attributes convert 2:1 for gaps.</div>
                                                <div className="text-orange-600 mt-0.5 flex items-center gap-1 font-normal opacity-80">
                                                    Check "Shop" tab for priority analysis.
                                                </div>
                                            </React.Fragment>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Right Col: Calculations (6 cols wide) */}
                            <div className="lg:col-span-6 flex flex-col gap-4 overflow-hidden">
                                {/* Merged Row: Source Details & Grand Total */}
                                <div className="card p-4 border-t-2 border-indigo-600 bg-white shadow-sm">
                                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
                                        {/* Left part: Source Details */}
                                        <div className="md:col-span-7">
                                            <div className="section-title text-indigo-700 text-[0.875rem] font-bold mb-2">
                                                {t.sec_details_title}
                                            </div>
                                            <div className="bg-gray-50 p-2 rounded-lg border border-gray-100 space-y-1.5 text-[0.75rem]">
                                                <div className="flex justify-between items-center border-b pb-1 text-gray-400 font-bold uppercase text-[0.625rem]">
                                                    <span>{t.th_source}</span>
                                                    <div className="flex gap-4">
                                                        <span className="text-blue-600">Â±¨ÊÄß</span>
                                                        <span className="text-green-600">ÈÄöÁî®</span>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-[1fr,60px,60px] gap-2 items-center py-1 border-b border-gray-100 bg-blue-50/30 px-1 rounded">
                                                    <div className="text-gray-600 font-bold">{t.lbl_member_frag}</div>
                                                    <div className="text-right text-blue-600 font-bold">{(calculation.memberIncomeAttr || 0).toLocaleString()}</div>
                                                    <div className="text-right text-green-600 font-bold">{(calculation.memberIncomeUniv || 0).toLocaleString()}</div>
                                                </div>
                                                <div className="grid grid-cols-[1fr,60px,60px] gap-2 items-center py-1 border-b border-gray-100 bg-orange-50/30 px-1 rounded">
                                                    <div className="text-gray-600 font-bold">{t.lbl_leader_frag}</div>
                                                    <div className="text-right text-blue-600">{(calculation.leaderIncomeAttr || 0).toLocaleString()}</div>
                                                    <div className="text-right text-green-600">{(calculation.leaderIncomeUniv || 0).toLocaleString()}</div>
                                                </div>
                                                <div className="grid grid-cols-[1fr,60px,60px] gap-2 items-center py-1 border-b border-gray-100 bg-indigo-50/30 px-1 rounded">
                                                    <div className="text-gray-600 font-bold">{t.lbl_univ_frag}</div>
                                                    <div className="text-right text-blue-600">-</div>
                                                    <div className="text-right text-green-600">{(calculation.univBase || 0).toLocaleString()}</div>
                                                </div>
                                                <div className="grid grid-cols-[1fr,60px,60px] gap-2 items-center py-1 bg-indigo-50/30 px-1 rounded">
                                                    <div className="text-gray-600 font-bold">{t.row_conv} + {t.row_synth}</div>
                                                    <div className="text-right text-blue-600">{((calculation.convertedAttr || 0) + (calculation.fragSynthAttr || 0)).toLocaleString()}</div>
                                                    <div className="text-right text-green-600">{((calculation.convertedUniv || 0) + (calculation.fragSynthUniv || 0)).toLocaleString()}</div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Divider (visible on medium screens+) */}
                                        <div className="md:col-span-1 block md:hidden w-full h-px bg-gray-100 my-2"></div>
                                        {/* Right part: Grand Total */}
                                        <div className="md:col-span-5 flex flex-col justify-center border-l md:border-l-0 md:pl-0 pl-4 border-indigo-50">
                                            <div className="section-title text-indigo-700 text-[1rem] font-bold mb-3 border-none p-0 drop-shadow-sm">{t.total_est}</div>
                                            <div className="flex flex-col gap-4">
                                                <div className="flex items-center gap-3 bg-blue-50/50 p-2 rounded-lg">
                                                    <div className="text-lg font-black text-blue-800 whitespace-nowrap">{lang === 'zh' ? 'Â±¨ÊÄß' : 'Attr'}</div>
                                                    <div className="text-4xl font-black text-blue-600 tracking-tighter">{(calculation.grandTotalAttr || 0).toLocaleString()}</div>
                                                </div>
                                                <div className="flex items-center gap-3 bg-green-50/50 p-2 rounded-lg">
                                                    <div className="text-lg font-black text-green-800 whitespace-nowrap">{lang === 'zh' ? 'ÈÄöÁî®' : 'Univ'}</div>
                                                    <div className="text-4xl font-black text-green-600 tracking-tighter">{(calculation.grandTotalUniv || 0).toLocaleString()}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Middle: Progress Section */}
                                <div className="card p-4 border-t-2 border-indigo-500 bg-white shadow-sm">
                                    <h3 className="font-bold text-gray-700 mb-2 text-sm border-b pb-1">{t.prog_title}</h3>
                                    <div className="grid grid-cols-2 gap-2 text-[0.6875rem]">
                                        <div className="flex justify-between p-1 bg-red-50 rounded border border-red-100"><span className="text-red-900 font-bold">{t.qual_god} ({calculation.totalGodPool})</span><span className="text-red-600">{t.prog_syn}{calculation.godStatus.maps} / {t.prog_need}{calculation.godStatus.needed}</span></div>
                                        <div className="flex justify-between p-1 bg-purple-50 rounded border border-purple-100"><span className="text-purple-900 font-bold">{t.qual_peerless} ({calculation.totalPeerlessPool})</span><span className="text-purple-600">{t.prog_syn}{calculation.peerlessStatus.maps} / {t.prog_need}{calculation.peerlessStatus.needed}</span></div>
                                        <div className="flex justify-between p-1 bg-indigo-50 rounded border border-indigo-100"><span className="text-indigo-900 font-bold">{t.qual_rare} ({calculation.totalRarePool})</span><span className="text-indigo-600">{t.prog_syn}{calculation.rareStatus.maps} / {t.prog_need}{calculation.rareStatus.needed}</span></div>
                                        <div className="flex justify-between p-1 bg-green-50 rounded border border-green-100"><span className="text-green-900 font-bold">{t.qual_common} ({calculation.totalCommonPoolFinal})</span><span className="text-green-600">{t.prog_syn}{calculation.commonStatus.maps} / {t.prog_need}{calculation.commonStatus.needed}</span></div>
                                        <div className="col-span-2 flex justify-between p-1 bg-yellow-50 rounded border border-yellow-100"><span className="text-yellow-900 font-bold">{t.qual_random} ({calculation.totalRandomPool})</span><span className="text-yellow-600">{t.prog_syn}{calculation.randomStatus.maps} / {t.prog_need}{calculation.randomStatus.needed}</span></div>
                                    </div>
                                </div>

                                {/* Bottom: Future Gain Breakdown */}
                                <div className="card p-4 border-t-2 border-green-500 bg-white shadow-sm">
                                    <div className="section-title text-green-700 text-[0.875rem] font-bold mb-2">{t.sec_future_breakdown}</div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-[0.75rem]">
                                            <thead>
                                                <tr className="bg-green-50/50 text-green-800">
                                                    <th className="p-1.5 text-left rounded-l-md">{t.th_source}</th>
                                                    <th className="p-1.5 text-center">{t.th_count}</th>
                                                    <th className="p-1.5 text-right">{t.th_attr}</th>
                                                    <th className="p-1.5 text-right">{t.th_univ}</th>
                                                    <th className="p-1.5 text-right rounded-r-md">{t.th_frag}</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                <tr>
                                                    <td className="p-1.5 font-bold text-blue-700">{t.row_daily}</td>
                                                    <td className="p-1.5 text-center font-mono">{calculation.effDays} {lang === 'zh' ? 'Ê¨°' : 'runs'}</td>
                                                    <td className="p-1.5 text-right font-bold color-wind">+{calculation.effDays * DAILY_MEMBER_REWARD.attr}</td>
                                                    <td className="p-1.5 text-right font-bold color-univ">+{calculation.effDays * DAILY_MEMBER_REWARD.univ}</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                </tr>
                                                <tr>
                                                    <td className="p-1.5 font-bold text-red-700">{t.row_weekly_divine}</td>
                                                    <td className="p-1.5 text-center font-mono">{calculation.effWeeks} {lang === 'zh' ? 'ÈÄ±' : 'wks'}</td>
                                                    <td className="p-1.5 text-right font-bold color-wind">+{calculation.effWeeks * WEEKLY_MEMBER_REWARD.attr}</td>
                                                    <td className="p-1.5 text-right font-bold color-univ">+{calculation.effWeeks * WEEKLY_MEMBER_REWARD.univ}</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                </tr>
                                                <tr>
                                                    <td className="p-1.5 font-bold text-teal-600">{t.lbl_leader_frag}</td>
                                                    <td className="p-1.5 text-center font-mono">-</td>
                                                    <td className="p-1.5 text-right font-bold color-wind">+{calculation.leaderIncomeAttr}</td>
                                                    <td className="p-1.5 text-right font-bold color-univ">+{calculation.leaderIncomeUniv}</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                </tr>
                                                <tr>
                                                    <td className="p-1.5 font-bold text-orange-600">{t.row_daily_frag}</td>
                                                    <td className="p-1.5 text-center font-mono">{calculation.effDays} {lang === 'zh' ? 'Â§©' : 'days'}</td>
                                                    <td className="p-1.5 text-right text-gray-400 font-bold text-fragment-custom">+{calculation.effDays * 1} (Áµï)</td>
                                                    <td className="p-1.5 text-right text-gray-400 font-bold text-fragment-custom">+{calculation.effDays * 2} (Áèç)</td>
                                                    <td className="p-1.5 text-right font-bold text-fragment-custom">+{calculation.effDays * 3} (Âá°)</td>
                                                </tr>
                                                <tr>
                                                    <td className="p-1.5 font-bold text-purple-700">{lang === 'zh' ? "ÊØèÊó•Èö®Ê©üÁ¢éÁâá (19Áâá)" : "Daily Random (19)"}</td>
                                                    <td className="p-1.5 text-center font-mono">{calculation.effDays} {lang === 'zh' ? 'Â§©' : 'days'}</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                    <td className="p-1.5 text-right font-bold text-fragment-custom">+{calculation.effDays * FRAG_SOURCES.dailyRandom}</td>
                                                </tr>
                                                <tr>
                                                    <td className="p-1.5 font-bold text-purple-700">{t.row_weekly_frag}</td>
                                                    <td className="p-1.5 text-center font-mono">{calculation.effWeeks} {lang === 'zh' ? 'ÈÄ±' : 'wks'}</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                    <td className="p-1.5 text-right text-gray-400">-</td>
                                                    <td className="p-1.5 text-right font-bold text-fragment-custom">+{calculation.effWeeks * FRAG_SOURCES.weeklyGod}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tab 3: ÂïÜÂ∫ó */}
                    {(viewMode === 'single' || activeTab === 'shop') && (
                        <div className={`card p-4 bg-white border-t-4 border-pink-500 mx-1 ${viewMode === 'tabs' ? 'mb-6' : 'mb-6'}`}>

                            {/* Queue + Summary Layout */}
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-4 items-stretch">
                                {/* Left: Dynamic Priority Queue */}
                                <div className="lg:col-span-9 border-2 border-indigo-100 rounded-xl overflow-hidden shadow-sm flex flex-col h-full">
                                    <div className="bg-gradient-to-r from-indigo-50 to-white p-2 border-b border-indigo-100 flex justify-between items-center h-10 px-3">
                                        <div className="text-[0.75rem] text-indigo-500 font-bold">{t.prio_subtitle}</div>
                                        <div className="text-right text-[0.75rem]">
                                            <span className="block text-green-600 font-bold">{t.prio_rem_univ} {priorityQueueAnalysis.length > 0 ? (priorityQueueAnalysis[priorityQueueAnalysis.length - 1].remainingUnivPool || 0).toLocaleString() : (calculation.grandTotalUniv || 0).toLocaleString()}</span>
                                        </div>
                                    </div>

                                    <div className="flex h-full min-h-[18.75rem] max-h-[18.75rem]">
                                        {/* Control Panel (Fixed Left Sidebar) */}
                                        <div className="w-14 bg-gray-50 border-r border-indigo-100 flex flex-col items-center justify-center gap-3 p-1 flex-shrink-0">
                                            <button className="ctrl-btn up" onClick={handleMoveUp} disabled={selectedQueueIndex === null || selectedQueueIndex === 0}>‚ñ≤</button>
                                            <button className="ctrl-btn down" onClick={handleMoveDown} disabled={selectedQueueIndex === null || selectedQueueIndex === cartQueue.length - 1}>‚ñº</button>
                                            <div className="h-4"></div>
                                            <button className="ctrl-btn del" onClick={handleDeleteItem} title={lang === 'zh' ? 'Âà™Èô§ÈÅ∏‰∏≠È†Ö' : 'Delete selected'} disabled={selectedQueueIndex === null}>üóëÔ∏è</button>
                                            <button className="ctrl-btn del !text-red-400 !bg-red-50 !border-red-100 mt-2" onClick={clearAllQueue} title={t.btn_clear_all}>ALL</button>
                                        </div>

                                        {/* List Area */}
                                        <div className="flex-grow overflow-y-auto p-0">
                                            {priorityQueueAnalysis.length === 0 ? (
                                                <div className="text-center py-8 text-gray-400 text-sm m-4 border-2 border-dashed border-gray-100 rounded-lg">
                                                    {t.prio_empty}
                                                </div>
                                            ) : (
                                                <table className="w-full text-sm border-collapse">
                                                    <thead>
                                                        <tr className="text-gray-600 text-xs border-b-2 border-indigo-200 bg-gradient-to-r from-indigo-50 to-blue-50 sticky top-0 z-10 shadow-sm font-bold">
                                                            <th className="py-3 pl-3 text-left w-32"># {lang === 'zh' ? 'ÂìÅÈ†Ö' : 'Item'}</th>
                                                            <th className="py-3 text-center">{lang === 'zh' ? 'ÈÄ≤Â∫¶' : 'Progress'}</th>
                                                            <th className="py-3 text-left">{lang === 'zh' ? 'Ë≥áÊ∫ê‰æÜÊ∫êÊòéÁ¥∞' : 'Resource Details'}</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {priorityQueueAnalysis.map((item, index) => {
                                                            const resourceDetails = [];
                                                            
                                                            // Êî∂ÈõÜÊâÄÊúâ‰ΩøÁî®ÁöÑËµÑÊ∫ê
                                                            if (item.nativeUsed > 0) {
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'ÁèæÊúâÂêåÂ±¨ÊÄß' : 'Current Stock',
                                                                    value: item.nativeUsed,
                                                                    color: 'text-blue-700',
                                                                    bgColor: 'bg-blue-50',
                                                                    icon: 'üíé'
                                                                });
                                                            }
                                                            if (item.futureNativeUsed > 0) {
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'Êú™‰æÜÂêåÂ±¨ÊÄß' : 'Future Native',
                                                                    value: item.futureNativeUsed,
                                                                    color: 'text-green-700',
                                                                    bgColor: 'bg-green-50',
                                                                    icon: 'üåü'
                                                                });
                                                            }
                                                            if (item.futureUnivUsed > 0) {
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'Êú™‰æÜÈÄöÁî®' : 'Future Univ',
                                                                    value: item.futureUnivUsed,
                                                                    color: 'text-teal-700',
                                                                    bgColor: 'bg-teal-50',
                                                                    icon: '‚ú®'
                                                                });
                                                            }
                                                            if (item.nonTargetUniv > 0) {
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'ÁèæÊúâÈÄöÁî®(1:1)' : 'Cur Univ(1:1)',
                                                                    value: item.nonTargetUniv,
                                                                    color: 'text-indigo-700',
                                                                    bgColor: 'bg-indigo-50',
                                                                    icon: 'üî∑'
                                                                });
                                                            }
                                                            if (item.nonTargetOtherRaw > 0) {
                                                                const gain = Math.floor(item.nonTargetOtherRaw / 2);
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'ÂÖ∂‰ªñÂ±¨ÊÄß(2:1)' : 'Other Attr(2:1)',
                                                                    value: `${item.nonTargetOtherRaw}‚Üí${gain}`,
                                                                    color: 'text-purple-700',
                                                                    bgColor: 'bg-purple-50',
                                                                    icon: 'üîÑ'
                                                                });
                                                            }
                                                            if (item.futureOtherRaw > 0) {
                                                                const gain = Math.floor(item.futureOtherRaw / 2);
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'Êú™‰æÜÂÖ∂‰ªñÂ±¨ÊÄß(2:1)' : 'Future Other(2:1)',
                                                                    value: `${item.futureOtherRaw}‚Üí${gain}`,
                                                                    color: 'text-orange-700',
                                                                    bgColor: 'bg-orange-50',
                                                                    icon: '‚ö°'
                                                                });
                                                            }
                                                            if (item.conversionStolenRaw > 0) {
                                                                resourceDetails.push({
                                                                    label: lang === 'zh' ? 'ÂàÜËß£ÂæåÈù¢ÂïÜÂìÅ' : 'From Later Items',
                                                                    value: item.conversionStolenRaw,
                                                                    color: 'text-pink-700',
                                                                    bgColor: 'bg-pink-50',
                                                                    icon: '‚¨áÔ∏è'
                                                                });
                                                            }
                                                            
                                                            return (
                                                                <tr
                                                                    key={item.uid}
                                                                    draggable={!isMobile}
                                                                    onDragStart={!isMobile ? (e) => handleDragStart(e, index) : undefined}
                                                                    onDragOver={!isMobile ? (e) => handleDragOver(e, index) : undefined}
                                                                    onDragEnd={!isMobile ? handleDragEnd : undefined}
                                                                    onClick={() => handleQueueItemClick(index)}
                                                                    className={`border-b border-gray-100 queue-item transition-all hover:bg-blue-50/30 ${
                                                                        !isMobile ? 'cursor-move' : 'cursor-pointer'
                                                                    } ${
                                                                        selectedQueueIndex === index ? 'selected bg-indigo-100/50 border-l-4 border-l-indigo-500' : ''
                                                                    } ${draggedIndex === index && !isMobile ? 'opacity-50 scale-105' : ''}`}
                                                                    style={{ cursor: isMobile ? 'pointer' : 'move' }}
                                                                >
                                                                    <td className="py-4 pl-3">
                                                                        <div className="flex items-center gap-2 leading-tight">
                                                                            <span className="text-gray-500 font-mono text-sm font-bold bg-gray-100 px-2 py-1 rounded">{index + 1}</span>
                                                                            <div className="flex flex-col">
                                                                                <div className={`font-bold text-sm truncate max-w-[120px] ${getAttrColorText(item.category)}`} title={item.name}>
                                                                                    ({getAttrLabel(item.category)}) {item.name}
                                                                                </div>
                                                                                <div className="flex items-center gap-2 mt-1">
                                                                                    {item.status === 'stock' && <span className="w-2 h-2 rounded-full bg-blue-500" title={t.prio_status_stock}></span>}
                                                                                    {item.status === 'univ' && <span className="w-2 h-2 rounded-full bg-green-500" title={t.prio_status_univ}></span>}
                                                                                    {item.status === 'convert' && <span className="w-2 h-2 rounded-full bg-indigo-500" title={t.prio_status_convert}></span>}
                                                                                    {item.status === 'gap' && <span className="w-2 h-2 rounded-full bg-red-500 animate-pulse" title={t.prio_status_gap}></span>}
                                                                                    <span className="text-[0.65rem] text-gray-500">ÊàêÊú¨: {item.cost}</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td className="py-4 text-center">
                                                                        <div className="flex flex-col items-center gap-1">
                                                                            <span className="font-mono font-bold text-base text-gray-700">{item.progress}</span>
                                                                            {item.gap > 0 && (
                                                                                <span className="text-xs text-red-500 font-medium">Áº∫ {item.gap}</span>
                                                                            )}
                                                                        </div>
                                                                    </td>
                                                                    <td className="py-4 pr-3">
                                                                        {resourceDetails.length > 0 ? (
                                                                            <div className="flex flex-wrap gap-1.5">
                                                                                {resourceDetails.map((detail, idx) => (
                                                                                    <div 
                                                                                        key={idx}
                                                                                        className={`${detail.bgColor} ${detail.color} px-2 py-1 rounded-md text-xs font-semibold border border-current/20 flex items-center gap-1`}
                                                                                        title={detail.label}
                                                                                    >
                                                                                        <span>{detail.icon}</span>
                                                                                        <span className="whitespace-nowrap">{detail.label}: {detail.value}</span>
                                                                                    </div>
                                                                                ))}
                                                                                {item.stolenFromMe > 0 && (
                                                                                    <div className="bg-red-50 text-red-700 px-2 py-1 rounded-md text-xs font-semibold border border-red-200 flex items-center gap-1">
                                                                                        <span>‚¨ÜÔ∏è</span>
                                                                                        <span className="whitespace-nowrap">{lang === 'zh' ? 'Ë¢´Â•™Âèñ' : 'Stolen'}: {item.stolenFromMe}</span>
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        ) : (
                                                                            <span className="text-gray-400 text-sm italic">{lang === 'zh' ? 'Ë≥áÊ∫ê‰∏çË∂≥' : 'Insufficient'}</span>
                                                                        )}
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Right: Summary Cards Stack */}
                                <div className="lg:col-span-3 flex flex-col gap-4 h-full">
                                    <div className="bg-white p-3 rounded-xl shadow-sm border-2 border-indigo-50 flex-1 flex flex-col overflow-hidden">
                                        <div className="text-indigo-900 font-bold text-[0.7rem] mb-2 flex items-center gap-1 border-b border-indigo-50 pb-1">
                                            <span>üìä</span> {lang === 'zh' ? 'È†ê‰º∞ÊÆòÊç≤Á∏ΩÈáè' : 'Est. Total Scrolls'}
                                        </div>

                                        <div className="space-y-4 flex-1 flex flex-col justify-center">
                                            <div className="bg-blue-50 p-2 rounded-lg border border-blue-100 flex flex-col items-center text-center">
                                                <div className="text-[0.6rem] text-blue-600 font-bold mb-1 uppercase">{lang === 'zh' ? 'Â±¨ÊÄßÊç≤' : 'Attr'}</div>
                                                <div className="text-xl font-black text-blue-700">{(calculation.grandTotalAttr || 0).toLocaleString()}</div>
                                            </div>

                                            <div className="bg-green-50 p-2 rounded-lg border border-green-100 flex flex-col items-center text-center">
                                                <div className="text-[0.6rem] text-green-600 font-bold mb-1 uppercase">{lang === 'zh' ? 'ÈÄöÁî®Êç≤' : 'Univ'}</div>
                                                <div className="text-xl font-black text-green-700">{(calculation.grandTotalUniv || 0).toLocaleString()}</div>
                                            </div>
                                        </div>

                                        <div className="mt-6 text-[0.5rem] text-gray-400 italic text-center leading-tight">
                                            {lang === 'zh' ? 'ÈöäÂàóÂ∑≤ËÄÉÊÖÆÊú™‰æÜÊî∂Áõä' : 'Queue includes future'}
                                        </div>
                                    </div>
                                </div>
                            </div>



                            {/* Bottom: Shop Items */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2">
                                {['wind', 'thunder', 'water', 'fire'].map(element => {
                                    const labels = { fire: t.attr_fire, water: t.attr_water, wind: t.attr_wind, thunder: t.attr_thunder };
                                    const textColor = { fire: 'color-fire', water: 'color-water', wind: 'color-wind', thunder: 'color-thunder' };
                                    const borderColor = { fire: 'border-fire', water: 'border-water', wind: 'border-wind', thunder: 'border-thunder' };
                                    const bgColorClass = { fire: 'bg-fire-light', water: 'bg-water-light', wind: 'bg-wind-light', thunder: 'bg-thunder-light' };

                                    return (
                                        <div key={element} className={`border rounded p-2 shadow-sm ${bgColorClass[element]}`}>
                                            <div className={`font-bold mb-1 text-center border-b pb-1 ${textColor[element]} ${borderColor[element]} flex justify-between items-center text-[0.75rem]`}>
                                                <span>{labels[element]}Â±¨ÊÄß</span>
                                                <button onClick={() => clearShopCategory(element)} className="text-[0.625rem] bg-white border border-gray-300 rounded px-1 hover:bg-gray-100" title={t.btn_clear}>{t.btn_clear.split(' ')[0]}</button>
                                            </div>
                                            <div className="space-y-1">
                                                {ATTR_SHOP_ITEMS.map(item => (
                                                    <ShopItem key={item.id} item={item} category={element} color={textColor[element]} />
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                                <div className="border rounded p-2 shadow-sm bg-univ-light">
                                    <div className="font-bold mb-1 text-center border-b pb-1 text-green-600 border-green-200 flex justify-between items-center text-[0.75rem]">
                                        <span>{t.attr_univ}</span>
                                        <button onClick={() => clearShopCategory('univ')} className="text-[0.625rem] bg-white border border-gray-300 rounded px-1 hover:bg-gray-100" title={t.btn_clear}>{t.btn_clear.split(' ')[0]}</button>
                                    </div>
                                    <div className="space-y-1">
                                        {UNIV_SHOP_ITEMS.map(item => (
                                            <ShopItem key={item.id} item={item} category="univ" color="text-green-600" />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )
                    }

                    {/* Tab 4: ÊØèÊó•Áç≤ÂèñÊòéÁ¥∞ */}
                    {
                        (viewMode === 'single' || activeTab === 'daily') && (
                            <div className={`card p-4 border-t-4 border-teal-500 overflow-x-auto mx-1 ${viewMode === 'tabs' ? 'mb-6' : 'mb-6'}`}>
                                <table className="w-full min-w-[700px]">
                                    <thead>
                                        <tr>
                                            <th className="w-16 text-[0.75rem]">{t.th_day}</th>
                                            <th className="w-32 text-[0.75rem]">{t.th_date}</th>
                                            <th className="text-[0.75rem]">{t.th_gain}</th>
                                            <th className="text-[0.75rem]">{t.th_acc}</th>
                                            <th className="text-[0.75rem]">{t.th_frag}</th>
                                            <th className="text-[0.75rem]">{t.th_note}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {dailyTable.map((row) => (
                                            <tr key={row.day} className={row.date.startsWith(currentDateInput.slice(5)) ? "bg-blue-100 border-l-4 border-blue-500" : ""}>
                                                <td className="font-medium text-gray-600 text-[0.75rem]">{row.day}</td>
                                                <td className="text-[0.75rem]">{row.date}</td>
                                                <td className="text-[0.75rem] text-gray-600">{row.dayAttr} / {row.dayUniv} / <span className="text-yellow-600 font-bold">{row.dayRandom}</span></td>
                                                <td className="text-[0.75rem]"><span className="text-blue-600 font-bold">{row.accAttr}</span> / <span className="text-green-600 font-bold">{row.accUniv}</span></td>
                                                <td className="text-[0.75rem]"><span className="text-yellow-800 font-bold bg-yellow-100 px-2 py-1 rounded">{row.accRandom}</span></td>
                                                <td className="text-[0.625rem] text-gray-500">{row.notes.map((note, idx) => (<span key={idx} className={note.style}>{idx > 0 && ", "}{note.text}</span>))}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )
                    }

                    {
                        (viewMode === 'single' || activeTab === 'sources') && (
                            <div className={`card p-4 border-t-4 border-yellow-500 mx-1 ${viewMode === 'tabs' ? '' : ''}`}>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="border rounded-lg p-3 bg-yellow-50 border-yellow-200">
                                        <h3 className="font-bold text-yellow-800 mb-2 border-b border-yellow-300 pb-1">{t.src_fixed_title}</h3>
                                        <ul className="space-y-1.5 text-[0.75rem]">
                                            <li className="flex justify-between items-center"><span className="text-red-700 font-bold">{t.qual_god}</span><span className="bg-white px-2 py-0.5 rounded-full text-red-600 font-bold shadow-sm">4 {t.unit_frag}</span></li>
                                            <li className="flex justify-between items-center"><span className="text-purple-700 font-bold">{t.qual_peerless}</span><span className="bg-white px-2 py-0.5 rounded-full text-purple-600 font-bold shadow-sm">5 {t.unit_frag}</span></li>
                                            <li className="flex justify-between items-center"><span className="text-indigo-700 font-bold">{t.qual_rare}</span><span className="bg-white px-2 py-0.5 rounded-full text-indigo-600 font-bold shadow-sm">9 {t.unit_frag}</span></li>
                                            <li className="flex justify-between items-center"><span className="text-green-700 font-bold">{t.qual_common}</span><span className="bg-white px-2 py-0.5 rounded-full text-green-600 font-bold shadow-sm">8 {t.unit_frag}</span></li>
                                            <li className="flex justify-between items-center"><span className="text-yellow-700 font-bold">{t.qual_random}</span><span className="bg-white px-2 py-0.5 rounded-full text-yellow-600 font-bold shadow-sm">20 {t.unit_frag}</span></li>
                                            <li className="flex justify-between items-center border-t border-yellow-200 pt-1.5 mt-1.5">
                                                <span className="text-orange-700 font-bold">‚ú® {lang === 'zh' ? 'Â¶ôÊâã‰∏πÈùí' : 'Art Event'}</span>
                                                <span className="bg-white px-2 py-0.5 rounded-full text-orange-600 font-bold shadow-sm">{t.src_art_reward}</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="border rounded-lg p-3 bg-blue-50 border-blue-200">
                                            <h3 className="font-bold text-blue-800 mb-2 border-b border-blue-300 pb-1">{t.src_weekly_title}</h3>
                                            <div className="space-y-2 text-[0.75rem]">
                                                <div><div className="text-[0.625rem] font-bold text-gray-700 mb-1">{t.src_weekly_sub}</div><div className="flex justify-between items-center bg-white p-1 rounded border border-blue-100"><span className="text-red-600 font-bold">{t.qual_god}</span><span className="font-bold">3 {t.unit_frag} {t.unit_week}</span></div></div>
                                                <div><div className="text-[0.625rem] font-bold text-gray-700 mb-1">{t.src_daily_sub}</div><div className="flex justify-between items-center bg-white p-1 rounded border border-blue-100"><span className="text-yellow-600 font-bold">{t.qual_random}</span><span className="font-bold">19 {t.unit_frag} {t.unit_day}</span></div><div className="text-[0.6875rem] text-orange-600 font-bold mt-1 text-right italic">{t.src_daily_note}</div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* New Rewards Reference Section */}
                                <div className="mt-4 border rounded-lg p-3 bg-indigo-50 border-indigo-200">
                                    <h3 className="font-bold text-indigo-800 mb-2 border-b border-indigo-300 pb-1">{t.src_rewards_title}</h3>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-[0.75rem] text-left">
                                            <thead className="bg-indigo-100 text-indigo-900">
                                                <tr>
                                                    <th className="p-1">{t.reward_header_qual}</th>
                                                    <th className="p-1">{t.reward_header_role}</th>
                                                    <th className="p-1 text-right">{t.reward_header_attr}</th>
                                                    <th className="p-1 text-right">{t.reward_header_univ}</th>
                                                    <th className="p-1 text-right">{t.reward_header_refund}</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-indigo-100">
                                                {/* God */}
                                                <tr className="bg-blue-100/50"><td className="p-1.5 font-bold text-red-700 italic">{t.qual_god}</td><td className="p-1.5 font-bold">{t.role_capt}</td><td className="p-1.5 text-right text-blue-600 font-bold">30</td><td className="p-1.5 text-right text-green-600 font-bold">40</td><td className="p-1.5 text-right">-</td></tr>
                                                <tr className="bg-white"><td className="p-1.5"></td><td className="p-1.5 text-gray-500">{t.role_memb}</td><td className="p-1.5 text-right text-blue-500">15</td><td className="p-1.5 text-right text-green-500">20</td><td className="p-1.5 text-right">-</td></tr>
                                                {/* Peerless */}
                                                <tr className="bg-blue-100/50"><td className="p-1.5 font-bold text-purple-700 italic">{t.qual_peerless}</td><td className="p-1.5 font-bold">{t.role_capt}</td><td className="p-1.5 text-right text-blue-600 font-bold">16</td><td className="p-1.5 text-right text-green-600 font-bold">20</td><td className="p-1.5 text-right font-bold text-purple-600">1</td></tr>
                                                <tr className="bg-white"><td className="p-1.5"></td><td className="p-1.5 text-gray-500">{t.role_memb}</td><td className="p-1.5 text-right text-blue-500">8</td><td className="p-1.5 text-right text-green-500">10</td><td className="p-1.5 text-right">-</td></tr>
                                                {/* Rare */}
                                                <tr className="bg-blue-100/50"><td className="p-1.5 font-bold text-indigo-700 italic">{t.qual_rare}</td><td className="p-1.5 font-bold">{t.role_capt}</td><td className="p-1.5 text-right text-blue-600 font-bold">8</td><td className="p-1.5 text-right text-green-600 font-bold">10</td><td className="p-1.5 text-right font-bold text-indigo-600">1</td></tr>
                                                <tr className="bg-white"><td className="p-1.5"></td><td className="p-1.5 text-gray-500">{t.role_memb}</td><td className="p-1.5 text-right text-blue-500">4</td><td className="p-1.5 text-right text-green-500">5</td><td className="p-1.5 text-right">-</td></tr>
                                                {/* Common */}
                                                <tr className="bg-blue-100/50"><td className="p-1.5 font-bold text-green-700 italic">{t.qual_common}</td><td className="p-1.5 font-bold">{t.role_capt}</td><td className="p-1.5 text-right text-blue-600 font-bold">4</td><td className="p-1.5 text-right text-green-600 font-bold">5</td><td className="p-1.5 text-right font-bold text-green-600">1</td></tr>
                                                <tr className="bg-white"><td className="p-1.5"></td><td className="p-1.5 text-gray-500">{t.role_memb}</td><td className="p-1.5 text-right text-blue-500">2</td><td className="p-1.5 text-right text-green-500">3</td><td className="p-1.5 text-right">-</td></tr>
                                                {/* Legend */}
                                                <tr className="bg-blue-100/50"><td className="p-1.5 font-bold text-purple-900 italic">{t.qual_legend}</td><td className="p-1.5 font-bold">{t.role_capt}</td><td className="p-1.5 text-right text-blue-600 font-bold">-</td><td className="p-1.5 text-right text-green-600 font-bold">150</td><td className="p-1.5 text-right">-</td></tr>
                                                <tr className="bg-white"><td className="p-1.5"></td><td className="p-1.5 text-gray-500">{t.role_memb}</td><td className="p-1.5 text-right text-blue-500">-</td><td className="p-1.5 text-right text-green-500">75</td><td className="p-1.5 text-right">-</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                    {/* Floating Zoom Console - Fixed Units to Prevent Jumping */}
                    <div style={{
                        position: 'fixed',
                        bottom: '20px',
                        right: '20px',
                        zIndex: 9999,
                        display: 'flex',
                        alignItems: 'center',
                        backgroundColor: 'white',
                        padding: '4px 8px',
                        borderRadius: '999px',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                        border: '1px solid #e0e7ff',
                        gap: '6px',
                        height: '36px'
                    }}>
                        <button
                            onClick={() => setZoomLevel(prev => Math.max(50, prev - 10))}
                            style={{ width: '28px', height: '28px', border: 'none', background: '#f5f7ff', color: '#4f46e5', fontWeight: 'bold', fontSize: '16px', borderRadius: '50%', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                        >-</button>
                        <button
                            onClick={() => setZoomLevel(100)}
                            style={{ border: 'none', background: 'transparent', color: '#6366f1', fontSize: '12px', fontWeight: '900', cursor: 'pointer', padding: '0 4px', fontFormat: 'monospace' }}
                        >{zoomLevel}%</button>
                        <button
                            onClick={() => setZoomLevel(prev => Math.min(250, prev + 10))}
                            style={{ width: '28px', height: '28px', border: 'none', background: '#f5f7ff', color: '#4f46e5', fontWeight: 'bold', fontSize: '16px', borderRadius: '50%', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                        >+</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>